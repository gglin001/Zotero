"use strict";!function(){angular.module("templates.xpl.search",[]),angular.module("xpl.search",["xpl","templates.xpl.search"]).config(["$httpProvider","$locationProvider","tealiumPrvdrProvider",function($httpProvider,$locationProvider,tealiumPrvdrProvider){$locationProvider.html5Mode(!0).hashPrefix("!"),$httpProvider.defaults.cache=!1,$httpProvider.defaults.headers.get||($httpProvider.defaults.headers.get={}),$httpProvider.defaults.headers.get["If-Modified-Since"]="0"}]).run(["$rootScope","tealiumService","tealiumPrvdr","tealiumDataPrvdr",function($rootScope,tealiumService,tealiumPrvdr,tealiumDataPrvdr){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams,options){$rootScope.stateIsLoading=!0}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$rootScope.stateIsLoading=!1})}])}(),function(){angular.module("xpl.search").constant("searchConstants",{facets:{query:"queryText",refinements:"refinements",range:"ranges",sort:"sortType",combineQuery:"combineQuery",matchBoolean:"matchBoolean",page:"pageNumber",rowsPerPage:"rowsPerPage",within:"searchWithin",openAccess:"openAccess",subscribed:"subscribed",fileCabinet:"fileCabinet",newsearch:"newsearch",punumber:"punumber",searchField:"searchField",promo:"promo",history:"history",selectedValue:"selectedValue",selectActive:"showActiveTitlesOnly",contentType:"contentType"},searchFieldKey:"key",defaultResultsLayout:"title-citation",resultsContainerIdName:"xplResultsContainer",facetsDrawerIdName:"xplFacetsDrawer"})}(),function(){function searchRoutes($stateProvider,$urlRouterProvider,queryConstants){function decodeURIRule($injector,$location){$location.url().toString().indexOf("history=no")>0&&$location.replace().url(_decodePathExcludingCombineQuery($location.url()))}function _slicePath4qp(_path,_qp){var _ret={},_indexOfQM=null,_urlOfPath=null,_queryStrOfPath=null,_qsWithoutQp=null,_qsWithQp=null,_pathContainsQp=!1;if(_path){if(_indexOfQM=_path.indexOf("?"),_indexOfQM>=0)if(_urlOfPath=_path.match(/[^?]+/g)[0],_queryStrOfPath=_path.substring(_indexOfQM+1),_queryStrOfPath&&_qp&&_queryStrOfPath.indexOf(_qp)>=0){var queryParams=_queryStrOfPath.match(/[^&]+/g);_qsWithoutQp=queryParams.filter(function(qse){return qse.indexOf(_qp)<0}).join("&"),_qsWithQp=queryParams.filter(function(qse){return qse.indexOf(_qp)>=0}).join("&"),_pathContainsQp=!0}else _qsWithoutQp=_queryStrOfPath;else _urlOfPath=_path;_ret={errorInParsing:!1,pathContainsQp:_pathContainsQp,urlOfPath:_urlOfPath,qsWithoutQp:_qsWithoutQp,qsWithQp:_qsWithQp}}else _ret={errorInParsing:!0};return _ret}function _decodePathExcludingCombineQuery(_path){var _pathDec=null,_CQ="combineQuery",_slicedPath=_slicePath4qp(_path,_CQ);return!_slicedPath.errorInParsing&&_slicedPath.pathContainsQp?(_pathDec=decodeURIComponent(_slicedPath.qsWithoutQp),_pathDec=_slicedPath.urlOfPath.concat("?",_pathDec,"&",_slicedPath.qsWithQp)):_pathDec=decodeURIComponent(_path),_pathDec}queryConstants.appendRouteUrl(!0),queryConstants.parameters();$urlRouterProvider.rule(decodeURIRule)}angular.module("xpl.search").config(searchRoutes),searchRoutes.$inject=["$stateProvider","$urlRouterProvider","queryConstants"]}(),function(){function searchService($http,userService,api,breadcrumbService,facetService,utilService,tealiumService,$stateParams){function getQueryResult(query){return $http.post(api.search,sanitizeQuery(query)).success(getQueryResultSuccess).error(getQueryResultFailure)}function getBreadcrumbs(subtype){if(searchService.queryResult.breadCrumbs){if(!subtype)return searchService.queryResult.breadCrumbs;var breadCrumbs=searchService.queryResult.breadCrumbs.filter(function(crumb){return crumb.type==subtype});return breadCrumbs.length?breadCrumbs[0].children.map(function(bc){return bc.reference=utilService.brackets2customHtmlEntity(bc.reference),bc.value=utilService.brackets2customHtmlEntity(bc.value),bc}):void 0}}function getQueryResultSuccess(data){searchService.selected=[],searchService.queryResult=data,searchService.searchBreadcrumb=getBreadcrumbs("search"),userService.setUser(data.userInfo),breadcrumbService.breadcrumbs=data.breadCrumbs,setBreadCrumbRefinementsToStateParams(data.breadCrumbs),facetService.facets=data.facets}function getQueryResultFailure(error){}function setBreadCrumbRefinementsToStateParams(crumbs){crumbs&&crumbs.forEach(function(value){"refinement"===value.type&&value.children.forEach(function(obj){push("refinements",new Array(obj.value))})})}function push(facet,value){return Array.isArray($stateParams[facet])?(Array.isArray(value)||(value=[value]),$stateParams[facet]=$stateParams[facet].concat(value.filter(function(item){return $stateParams[facet].indexOf(item)<0}))):$stateParams[facet]=value,this}function sanitizeQuery(query){return query}function removeFacet(value){return facetService.removeFacet(value)}function removeBreadcrumb(value){return breadcrumbService.removeBreadcrumb(value)}function setAlert(name){var uri="/rest/search/alert/?label="+encodeURIComponent(name);return $http.get(uri)}var searchService={queryResult:void 0,selected:[],getBreadcrumbs:getBreadcrumbs,getQueryResult:getQueryResult,searchBreadcrumb:void 0,removeBreadcrumb:removeBreadcrumb,removeFacet:removeFacet,setAlert:setAlert};return searchService}angular.module("xpl.search").factory("searchService",searchService),searchService.$inject=["$http","userService","api","breadcrumbService","facetService","utilService","tealiumService","$stateParams"]}(),function(){function searchState($httpParamSerializer,$stateParams,$state,searchConstants,searchService,utilService){function clear(facet){return $stateParams[facet]&&delete $stateParams[facet],this}function clearAll(){return Object.keys($facets).forEach(function(key){clear($facets[key])}),this}function go(to,params,options){$state.go(to,params,options)}function page(value){$stateParams[$facets.page]=value,$state.go($state.$current,$stateParams)}function pop(facet,value){return Array.isArray($stateParams[facet])?(Array.isArray(value)||(value=[value]),$stateParams[facet]=$stateParams[facet].filter(function(item){return value.indexOf(utilService.brackets2customHtmlEntity(item))<0})):clear(facet),this}function push(facet,value){return Array.isArray($stateParams[facet])?(Array.isArray(value)||(value=[value]),$stateParams[facet]=$stateParams[facet].concat(value.filter(function(item){return $stateParams[facet].indexOf(item)<0}))):$stateParams[facet]=value,this}function sort(_currentSort){_currentSort.isDefault?$stateParams[$facets.sort]=void 0:$stateParams[$facets.sort]=_currentSort.value,update()}function update(){clear($facets.page),clear($facets.newsearch),$state.go($state.$current,$stateParams)}function refresh(){$state.go($state.$current,$stateParams)}function getSearchQueryString(){var params=angular.copy(this.$params),validParams=Object.keys($facets).map(function(k){return $facets[k]});return Object.keys(params).forEach(function(key){void 0!==params[key]&&validParams.indexOf(key)!==-1||delete params[key]}),$httpParamSerializer(params)}var $facets=searchConstants.facets,$properties=searchConstants.properties,$rows=searchConstants.rows,$sortBy=searchConstants.sortBy,$showTypes=searchConstants.showTypes,$defaultShowTypeArrayIndex=searchConstants.defaultShowTypeArrayIndex,$subscribedShowTypeArrayIndex=searchConstants.subscribedShowTypeArrayIndex,$searchFieldKey=searchConstants.searchFieldKey,$defaultResultsLayout=searchConstants.defaultResultsLayout,$defaultRows2renderInitially=searchConstants.defaultRows2renderInitially,searchState={$facets:$facets,$properties:$properties,$rows:$rows,$sortBy:$sortBy,$showTypes:$showTypes,$defaultShowTypeArrayIndex:$defaultShowTypeArrayIndex,$subscribedShowTypeArrayIndex:$subscribedShowTypeArrayIndex,$defaultResultsLayout:$defaultResultsLayout,$defaultRows2renderInitially:$defaultRows2renderInitially,$params:$stateParams,$searchFieldKey:$searchFieldKey,clear:clear,clearAll:clearAll,go:go,page:page,pop:pop,push:push,sort:sort,update:update,refresh:refresh,getSearchQueryString:getSearchQueryString};return searchState}angular.module("xpl.search").service("searchState",searchState),searchState.$inject=["$httpParamSerializer","$stateParams","$state","searchConstants","searchService","utilService"]}(),function(){function xplResult($filter,downloadPdfService,searchService){function link(scope){function pdfPopup(url,name){var width=650,height=400,left=screen.width/2-width/2,top=screen.height/2-height/2;return window.open(url,name,"location=no,toolbar=no,directories=no,status=no, menubar=no,scrollbars=yes,resizable=yes,top="+top+"px,left="+left+"px,width="+width+"px,height="+height+"px"),!1}function isSelected(){return scope.selectedItems.indexOf(scope.record.articleNumber)>-1}function toggleSelect(){isSelected()?(scope.selectedItems=scope.selectedItems.filter(function(x){return x!=scope.record.articleNumber}),scope.bulkSelectedItems=scope.bulkSelectedItems.filter(function(item){return item.articleNumber!=scope.record.articleNumber})):(scope.selectedItems.push(scope.record.articleNumber),scope.bulkSelectedItems=scope.records.filter(function(r){return scope.selectedItems.indexOf(r.articleNumber)>-1}).map(function(r){return downloadPdfService.getBulkSelectedItem(r.articleNumber,r.title,r.pdfSize,r.accessType,r.bookPdfMountpoint)}))}scope.queryString="",location.search&&(scope.queryString=location.search.substring(1,location.search.length)),scope.multimediaLink="/xpl/abstractMultimedia.jsp?arnumber="+scope.record.articleNumber+"&isnumber="+scope.record.isNumber,scope.user.showMeta="title-only"!==scope.user.preferences.resultsLayout,scope.user.openAbstract="title-citation-abstract"===scope.user.preferences.resultsLayout,scope.pdfPopup=pdfPopup,scope.isSelected=isSelected,scope.toggleSelect=toggleSelect}var directive={link:link,restrict:"E",scope:{bulkSelectedItems:"=",records:"=",record:"=",selectedItems:"=",user:"="},templateUrl:"search/results/result.html"};return directive}angular.module("xpl.search").directive("xplResult",xplResult),xplResult.$inject=["$filter","downloadPdfService","searchService"]}(),function(){function ResultsActionsController(downloadPdfService){function $onInit(){}function toggleSelection(){if(allSelected())return $ctrl.selectedItems.length=0,void($ctrl.bulkSelectedItems.length=0);$ctrl.selectedItems.length=0,$ctrl.bulkSelectedItems.length=0;for(var i=0,l=$ctrl.records.length;i<l;i++){var r=$ctrl.records[i];r.showCheckbox&&($ctrl.selectedItems.push(r.articleNumber),$ctrl.bulkSelectedItems.push(downloadPdfService.getBulkSelectedItem(r.articleNumber,r.title,r.pdfSize,r.accessType,r.bookPdfMountpoint)))}}function allSelected(){return $ctrl.selectedItems.length>0&&$ctrl.selectedItems.length===$ctrl.records.filter(function(r){return r.showCheckbox}).length}var $ctrl=this;$ctrl.$onInit=$onInit,$ctrl.allSelected=allSelected,$ctrl.toggleSelection=toggleSelection}var xplCmptResultsActions={bindings:{records:"=",selectedItems:"=",bulkSelectedItems:"=",totalRecords:"<"},controller:ResultsActionsController,templateUrl:"search/results/results-actions.component.html"};ResultsActionsController.$inject=["downloadPdfService"],angular.module("xpl.widget").component("xplCmptResultsActions",xplCmptResultsActions)}(),function(){function resultsContainerResizerService($window,responsivenessService,searchConstants){function resizeContainer(){$window.clearTimeout(timeoutResizeContainer),timeoutResizeContainer=$window.setTimeout(function(){if(timeoutResizeContainer=null,responsivenessService.isMobile()){var resultsContainer=$window.document.getElementById(searchConstants.resultsContainerIdName);resultsContainer.style.height=getFacetsDrawerHeight()+"px",$window.removeEventListener("resize",onWindowResize),$window.addEventListener("resize",onWindowResize)}},timeoutWaitTime)}function focusContainer(){$window.clearTimeout(timeoutFocusContainer),timeoutFocusContainer=$window.setTimeout(function(){timeoutFocusContainer=null;var facetsHeader=$window.document.getElementById("mobile-facets-header");facetsHeader.setAttribute("tabindex","0"),facetsHeader.focus()},timeoutWaitTime)}function resetContainerHeight(){var resultsContainer=$window.document.getElementById(searchConstants.resultsContainerIdName);resultsContainer.style.height="auto",removeWindowResizeListener()}function removeWindowResizeListener(){responsivenessService.isMobile()&&$window.removeEventListener("resize",onWindowResize)}function getFacetsDrawerHeight(){var facetsDrawer=$window.document.getElementById(searchConstants.facetsDrawerIdName);return facetsDrawer.offsetHeight}function onWindowResize(){$window.clearTimeout(timeoutResizeWindow),timeoutResizeWindow=$window.setTimeout(function(){timeoutResizeWindow=null,responsivenessService.isMobile()?resizeContainer():resetContainerHeight()},timeoutWaitTime)}var resultsContainerResizerService={resizeContainer:resizeContainer,resetContainerHeight:resetContainerHeight,focusContainer:focusContainer,removeWindowResizeListener:removeWindowResizeListener};return resultsContainerResizerService;var timeoutResizeContainer,timeoutResizeWindow,timeoutFocusContainer,timeoutWaitTime}angular.module("xpl.search").factory("resultsContainerResizerService",resultsContainerResizerService),resultsContainerResizerService.$inject=["$window","responsivenessService","searchConstants"]}(),function(){function xplCmptSearchResults(){return{controller:ResultsComponent,controllerAs:"vm",replace:!0,restrict:"E",scope:{},templateUrl:"search/results/results-component.html"}}function ResultsComponent($log,$state,$stateParams,facetService,googleAdTargetingService,resultsContainerResizerService,searchConstants,searchService,searchState,userService,tealiumService,utilService){function initialize(){searchService.getQueryResult($state.params).then(queryResultSuccess)["catch"](catchPromiseFailure),resultsContainerResizerService.removeWindowResizeListener()}function appendRecords(){(vm.records.length<1||cache.data.records.length)&&(vm.records=vm.records.concat(cache.data.records.splice(0,10)))}function changePage(){$state.go($state.current.name,{pageNumber:vm.page})}function tealiumCall(){if(tealiumService.isTealiumEnabled()){var tealiumUtagData={publisher:tealiumService.getPublisher(),search_keyword:utilService.get($state.params,"queryText",""),search_refinements:tealiumService.getRefinements(vm.data),search_search_within:tealiumService.getSearchWithin(),search_results_count:vm.data.totalRecords,search_type:vm.data.searchType,sheet_name:utilService.get(tealiumTagsData,"data.data4angular.pageTags.serp.sheet_name","notFound"),sheet_type:utilService.get(tealiumTagsData,"data.data4angular.pageTags.serp.sheet_type","notFound")};tealiumService.view(tealiumUtagData)}}function queryResultSuccess(response){vm.rowCount=$state.params.rowsPerPage||25,vm.page=$state.params.pageNumber||1,vm.user=userService.getUser(),vm.data=response.data,vm.standardsDictionaryTerms=searchService.removeFacet("Standards Dictionary Terms"),vm.searchTerms=searchService.removeBreadcrumb("search"),vm.contentTypeFacet=facetService.extractContentTypeFacet(vm.data.facets),vm.facets=vm.data.facets,vm.breadcrumbs=vm.data.breadCrumbs,$stateParams.refinements&&($stateParams.refinements=utilService.flattenArrayObject(vm.breadcrumbs.filter(function(elem){return"refinement"===elem.type}),["children","value"])),!vm.data.subscribedContentApplied||$stateParams[searchState.$facets.subscribed]||$stateParams[searchState.$facets.fileCabinet]||($stateParams.subscribed="true"),angular.copy(response.data.records,cache.data.records),appendRecords(),vm.loading=!1,vm.tealiumCall(),vm.googleAdTargeting=getGoogleAdTargetingInfo()}function catchPromiseFailure(error){$log.error(error),vm.error=!0,vm.loading=!1}function getGoogleAdTargetingInfo(){var queryString=searchState.$params[searchState.$facets.query],searchString="string"==typeof queryString?queryString:"",user=vm.user,search=searchString,puNumber=searchState.$params[searchState.$facets.punumber]?searchState.$params[searchState.$facets.punumber]:"",contentId="",publisher="";return googleAdTargetingService.getTargetingInfo(user,search,puNumber,contentId,publisher)}function toggleMobileFacets(){vm.isFacetsMobileActive=!vm.isFacetsMobileActive,vm.isFacetsMobileActive?(resultsContainerResizerService.focusContainer(),resultsContainerResizerService.resizeContainer()):resultsContainerResizerService.resetContainerHeight()}function closeMobileFacets(){vm.isFacetsMobileActive=!1,resultsContainerResizerService.resetContainerHeight()}var cache={data:{records:[]}},vm=this;vm.error=!1,vm.records=[],vm.loading=!0,vm.user={},vm.selectedItems=[],vm.bulkSelectedItems=[],vm.standardsDictionaryTerms={children:[]},vm.googleAdTargeting={},vm.isFacetsMobileActive=!1,vm.resultsContainerIdName=searchConstants.resultsContainerIdName,vm.appendRecords=appendRecords,vm.changePage=changePage,vm.toggleMobileFacets=toggleMobileFacets,vm.closeMobileFacets=closeMobileFacets,vm.tealiumCall=tealiumCall,initialize()}angular.module("xpl.search").directive("xplCmptSearchResults",xplCmptSearchResults),ResultsComponent.$inject=["$log","$state","$stateParams","facetService","googleAdTargetingService","resultsContainerResizerService","searchConstants","searchService","searchState","userService","tealiumService","utilService"]}(),function(){function xplStandardsDictionary(){var directive={restrict:"E",scope:{listing:"="},templateUrl:"search/standards-dictionary/standards-dictionary.html"};return directive}angular.module("xpl.search").directive("xplStandardsDictionary",xplStandardsDictionary)}();