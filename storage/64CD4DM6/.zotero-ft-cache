Heart Rate Estimation Using Wrist-acquired Photoplethysmography Under Diﬀerent Types of Daily Life
Motion Artifact
by ZHE LIN
A Thesis Submitted to The Hong Kong University of Science and Technology
in Partial Fulﬁllment of the Requirements for the Degree of Master of Philosophy
in Computer Science and Engineering
July 2015, Hong Kong
HKUST Library Reproduction is prohibited without the author’s prior written consent

Acknowledgment
In the past two years of my postgraduate study, I have been fortunately learnt from and worked with many great people. I want to take this opportunity to express my gratitude towards them.
First, I would love to thank my thesis supervisor Professor Qian Zhang. When I ﬁrst entered HKUST, I had little experience of conducting research. In the two years with continuously guidance from Professor Zhang, I had developed the sense of how conducting research is like. She helped me improve the methodology of doing research work and adjust the direction of my research when it deviated from the right path. Without the support from Professor Zhang, I would not be able to ﬁnish my ﬁrst concrete piece of reach work. Moreover Professor Zhang had taught me things besides research, things about being conﬁdent of ourselves, how to communicate with others eﬀectively, how to organize a presentation, interpersonal skills and many more. All these valuable experience help me become a more mature and independent person. The lessons I learnt from Professor Zhang will always guide me though my future path.
Second, I want to thank my senior group member Doctor Jin Zhang for many detail suggestion she gave me during my ﬁrst research work and the comfort she oﬀered me when the research was not going well. I also want to thank all the other group members. I always inspire by them and receive many helps. We also spent a lot of good times together. I will remember each of them.
Finally, I want to thank my parents for raising me up. All my achievements would not happen without them.
iv

Contents

Title Page

i

Authorization Page

ii

Signature Page

iii

Acknowledgments

iv

Contents

v

List of Figures

vii

List of Tables

viii

Abstract

ix

1 Introduction

1

1 Background . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1

2 Related Work . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2

3 Challenges and Contribution . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3

2 Methondology

6

1 Overall Design . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6

v

2 Photoplethysmograph Principle . . . . . . . . . . . . . . . . . . . . . . . . . . . 6 3 Active Noise Cancellation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9 4 Heart Rate Searching Algorithm . . . . . . . . . . . . . . . . . . . . . . . . . . . 10 5 Extra Branch Estimate Heart Rate During Walking . . . . . . . . . . . . . . . . . 14

3 Experiment

18

1 Material and Setup . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18

2 Motion Classiﬁcation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20

3 Subjects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21

4 Evaluation Results

23

5 Discussion

28

6 Conclusion

30

Bibliography

32

vi

List of Figures
2.1 Flow chart of the proposed method . . . . . . . . . . . . . . . . . . . . . . . . . . 7 2.2 5 seconds PPG signal under diﬀerent condition: . . . . . . . . . . . . . . . . . . . 7 2.3 Block diagram of the constructed adaptive ﬁlter . . . . . . . . . . . . . . . . . . . 9 2.4 30s PPG spectrum under diﬀerent conditions: . . . . . . . . . . . . . . . . . . . . 11 2.5 Heart Rate Changing Pattern Under Regular Motion . . . . . . . . . . . . . . . . . 15 3.1 Experiment scenario . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19 3.2 Motion distribution during experiments . . . . . . . . . . . . . . . . . . . . . . . 20 4.1 Comparison of heart rate generated by our proposed algorithm and a naive heart
rate searching algorithm in diﬀerent experiments: . . . . . . . . . . . . . . . . . . 26 4.2 Bland-Altman plots of heart rate errors in diﬀerent experiments: . . . . . . . . . . 27
vii

List of Tables
viii

Heart Rate Estimation Using Wrist-acquired Photoplethysmography Under Diﬀerent Types of Daily Life
Motion Artifact
ZHE LIN
Department of Computer Science and Engineering The Hong Kong University of Science and Technology
Abstract
Wearable devices are becoming more and more popular in recent year. Many of them are embedded with powerful processor and sensors which could enable a vast of new applications. One issue that researchers and engineers are concerned about is how to leverage the power of wearable devices to monitor our physical conditions so that we could use it to provide guidance to maintain a healthy life. Heart rate is one of the most signiﬁcant vital sign of human which is tightly related to both of our physical and mental condition. Reﬂective wrist photoplethysmograph (PPG), obtained by a watch or wristband, can provide a natural and unconstrained way for daily life heart rate monitoring. However, reﬂective wrist PPG often suﬀers from poor signal quality and various distortions due to daily life motion artifact. In this thesis, we analyze the inﬂuence of motion artifact on reﬂective wrist PPG signals, and propose a method to extract reliable heart rate from such distorted PPG signals. The proposed method consists of adaptive ﬁltering, heart rate selection, and motion identiﬁcation. Experimental results show that our proposed method can generate reliable heart rate values from wrist PPG signals with diﬀerent types of motion artifact.
ix

CHAPTER 1
INTRODUCTION
1 Background
Recent year we witness an trend of growth of wearable device on the market like Google Glass, Apple Watch and many diﬀerent brand of wrist bands. These wearable devices are embedded with powerful processor and sensors which could enable many new function. Leveraging the power of wearable devices to monitor people’s health condition become a hot topic in the industry and research ﬁeld. There has been some try like all kinds of wrist bands on the market. These wrist bands are able to track human daily life activities like the how many step you walk in a day, how much time you remain active, how much calories you burnt a day and so on. These result could provide certain information to access a person’s active level and tell him/her if him/her should increase the amount of exercise in a day to be healthier. It is a nice try, however, if we want to have more comprehensive understanding of our health condition, we still need more information about ourselves. Heart rate is one of the most signiﬁcant vital signs that are related to human health. Heart rate monitoring are often conducted in the clinical environment where the heart rate of the patient is recorded for the doctor to give diagnosis. Monitoring heart rate is not only important for the patient but also beneﬁcial for common people. With the development of the sensor technology,
1

some simple portable devices [1], [2] emerged on the market, enabling people to measure their own heart rate at home. Some products are developed for longterm heart rate monitoring in daily life [3] Wearable devices for health monitoring would be a trend for telehealth in the future.
Potoplethysmographs (PPG) is often used for heart rate measurement [4]. The basic principle of PPG is that diﬀerent light absorption rate caused by changes of blood ﬂow in the microvascular vessel could be detected by photodiode (PD). According to diﬀerent traverse path of the received light, PPG could be classiﬁed into two diﬀerent modes: reﬂected mode and transmitted mode. In the transmitted mode, the light transmits through the tissue, and is received by the PD placed on the opposite side of the body. In the reﬂected mode, the PD and the light source are located on the same side of the body. PD receives the light reﬂected by the skin. The transmitted mode can achieve a relatively better signal compared to the reﬂected mode. Since the light needs to transmit through the tissue, PPG obtained by the transmitted mode can only be measured from limited parts of the body, such as ﬁnger or toe. And it require wearing a ﬁngertip which still cause inconvenience for the subject. Reﬂected mode PPG does not have the limited placement problem of the transmitted mode PPG. However, reﬂected mode is more sensitive to motion artifact and pressure disturbances. Physical activity introduces motion artifact which distorts the PPG signal and makes it harder to extract useful physiological parameters.
2 Related Work
In [5], the authors designed an earpiece PPG sensor to record the PPG signal from ear. In [6], the authors used forehead reﬂectance PPG to monitor heart rate. Since the movement caused by head is comparatively simpler than those by other parts of the body, PPG acquired from the head suﬀer
2

from less motion artifact. Also, the tissue of the forehead and the ear is thin enough to produce a good PPG signal. Despite these advantages, wearable devices on our forehead or ear that use reﬂective PPG to monitor heart rate may give people an odd look. Hence, reﬂective PPG acquired from the forehead or the ear are more suitable for usage in the clinical environment. In [7], the authors analyzed the correlation of the PPG and the acceleration signal in frequency domain, and proposed a method to estimate heart rate using the reﬂective PPG signal acquired from the ﬁnger. Their method could produce an acceptable heart rate under motion artifact. However, a ﬁngertip is needed to acquire PPG acquired from the ﬁnger. Wearing a ﬁngertip will greatly aﬀect the users comfort level as many of our daily life activities involve ﬁnger movement.
Amongst all the common body parts for PPG measurement, wrist is an ideal one for long-term measurement in our daily life. PPG sensor could be embedded into a watch or a wristband that are worn by the users most naturally. It neither make people look odd (like the sensors on the earlobe or head), nor limit users activities (like the sensors on the ﬁngertip). In [8], the authors tried to estimate heart rate from the PPG signals obtained from the wrist during walking. Their method is similar to the method in [7], which compares the acceleration and PPG in frequency domain to eliminate motion artifact.
3 Challenges and Contribution
The major challenge to extract heart rate from the PPG obtained from the wrist is to deal with the motion artifact. In [9], the author compared the motion artifact eﬀect on diﬀerent measurement site and reported that PPG acquired from the wrist has the worst signal quality in terms of motion artifact compared with ﬁnger, upper arm and forearm. Various methods had been proposed
3

to deal with motion artifact in PPG such as singular value decomposition (SVD) [10], independent component analysis (ICA) [11],empirical mode decomposition [12], wavelet decomposition [13][14],minimum correlation discrete saturation transform [15],multi scale principal component analysis[16] and active noise cancellation [17] [18] [19] [20]. These methods try to reconstruct the periodic waveform of PPG signal thus the heart rate could be calculated in time domain. These methods are only applied to the PPG from the ﬁnger which had much less motion artifact and better signal quality than the signal from the wrist. In some preliminary test, we collect reﬂected PPG with motion artifact from wrist and applied some the methods above but these methods could not reconstruct PPG waveform. In recent works [7] [8], acceleration signal had been leveraged to deal with motion artifact in PPG in the frequency domain. Their basic assumption is that, in terms of spectrum, the eﬀect of motion artifact is equivalent to adding an independent component (caused by motion artifact) to the PPG signal. And this component can be estimated by the acceleration signals spectrum. They use the acceleration signals spectrum to remove the motion artifact component in the distorted PPG signals spectrum and detect the heart rate. However, as far as we know, no literature could be found to support this assumption. Also, in [8], the authors only validated their method under running scenario. Whether the proposed method is useful for other types of motion artifact is unknown.
In some preliminary tests we conducted, we gained the following observation. In most motion distorted PPG signals spectrum, heart rate component still exists clearly. If we could diﬀerentiate heart rate component from the motion artifact, we could extract reliable heart rate from the distorted PPG signal. Our major contribution are three folds:
• We design a novel heart rate detection algorithm which could identify heart rate component
4

under various types of motion artifact. • We leverage active noise cancellation method to enhance the signal quality for the postpro-
cessing of our algorithm. • Experimental results show that our proposed method can generate reliable heart rate values
from wrist PPG signals with diﬀerent types of motion artifact.
5

CHAPTER 2
METHONDOLOGY
1 Overall Design
Fig. 2.1 shows the main procedures of our heart rate extraction. To start with, raw PPG and acceleration signals are captured simultaneously. Raw PPG signals are then fed into the adaptive ﬁlter to reduce the noise outside the heart rate frequency band. After that, ﬁltered signals are divided into small segments for Fast Fourier Transform (FFT) to obtain the spectrum of the ﬁltered PPG segments. Meanwhile the acceleration signals go through a walking detection algorithm to identify whether the user is walking. Based on the result from the walking detection algorithm, we will select a heart rate detection algorithm to process the generated ﬁltered PPG spectrum. Finally, we will get the estimated heart rate from the heart rate detection algorithm. Next, we will describe each procedure in detail.
2 Photoplethysmograph Principle
In chapter 1, we have described the basic principle of PPG. In this session we will introduce the basic principle of PPG and show some characteristic of PPG signal in both time and frequency domain.
6

Figure 2.1: Flow chart of the proposed method
(a) Clean PPG from ﬁnger
(b) Clean PPG from horizontally placed wrist;
(c) Clean PPG from vertically placed wrist;
(d) Motion artifact distorted PPG from wrist.
Figure 2.2: 5 seconds PPG signal under diﬀerent condition: 7

When light travels through biological tissues, it will be absorbed and reﬂected by diﬀerent substances including skin, bone, artery, vein and capillary. Changes in these tissues (like blood ﬂow) will result in diﬀerent intensity of the received light at the PD, which forms the PPG signals that consist of two components: direct current (DC) and alternating current (AC). The DC component corresponds to static signals reﬂected from the static substances of body tissues (such as skin and bone), and slowly changed signal caused by respiration. The AC component reﬂects the quasiperiodic changes of the blood volume that are caused by the systolic and diastolic phases of the cardiac cycle. Therefore, the AC component contains the most useful information of the cardiac activity which could reveal the heart rate.
Fig. 2.2(a) shows a piece of ﬁve seconds PPG signals acquired from the ﬁnger without motion artifact. The periodic pattern corresponding to the cardiac cycle is well-distinguishable. Fig. 2.2(b)(c) show two pieces of ﬁve seconds PPG signals acquired from wrist with the forearm placing horizontally and vertically without motion artifact. Compared with the signals from the ﬁnger, signals from the wrist maintain the periodic pattern, but the amplitude of each peak is much weaker. We also observe that when the forearm is placed vertically, the PPG signals are worse than it is placed horizontally. Therefore, heart rate during walking is harder to detect because the arms are swinging vertically. We will address this problem in the following sections. Fig. 2.2(d) is a piece of ﬁve seconds PPG signals acquired from wrist during running. The periodic pattern is completely distorted by the motion artifact.
8

Figure 2.3: Block diagram of the constructed adaptive ﬁlter
3 Active Noise Cancellation
Since the raw data of PPG contains motion artifact and other undesirable noise. To enhance the signal quality for postprocessing the algorithm, we leverage the active noise cancellation technique. Active noise cancellation is usually achieved by using an adaptive ﬁlter. The adaptive ﬁlter itself can adjust the ﬁlter coeﬃcients to process noise with an unknown band or the noise that varies over time. As noise caused by daily life motion matches such characteristics, adaptive ﬁlter is the ideal choice for motion artifact cancellation in our method. Fig. 2.3 is the block diagram of the constructed adaptive ﬁlter. The raw PPG signals, containing the pulsatile component S (n) and the noise component N(n), are the input of the adaptive ﬁlter. To generate the synthetic reference signal in the adaptive ﬁlter, we need to remove the pulsatile component 0.83 - 4.16 Hz corresponding to heart rate 50 - 250 beats per minute (bpm) from the raw PPG signals spectrum. By setting the coeﬃcients of the raw PPG signals spectrum to zero and applying inverse Fourier transform to this modiﬁed spectrum, we can obtain the synthetic noise reference signal. Another important thing to be determined is the adaptive algorithm of the ﬁlter. We choose the widely-used least mean square (LMS) algorithm, which has a high level of stability and a low ﬁlter order. The LMS algorithm is
9

used to update the set of coeﬃcients w(n) of the ﬁlter. Multiplying the reference signal R(n) with the ﬁlter coeﬃcients, we can get the estimated artifact N (n). The ﬁltered PPG signals S (n) is generated by subtracting the estimated artifact N (n) from the original distorted PPG signals. Then the LMS algorithm will use S (n) as a feedback to update the ﬁlter coeﬃcients. The above procedure will run iteratively. The proposed adaptive ﬁlter generates S (n);N (n) and w(n) as follows:

S (n) = S (N) + N(n) − N (n)

(1)

L

N (n) = ωiR(n − i)

(2)

i=0

ωi(n + 1) = ωi(n) + 2µS (n)R(N − i), i = 0, 1, 2, . . . , L

(3)

in which L is the ﬁlter order. S (n) + N(n) is the original distorted PPG signals. S (n) is the motion artifact compensated signal. N (n) is the estimated synthetic noise reference signal and R(n) is the synthetic noise reference signal.

4 Heart Rate Searching Algorithm
The heart rate searching algorithm is the most important component of our method. In Fig. 2.2(d) we can see that the periodic pattern corresponding to each pulse is completely distorted by the motion artifact. Even if we apply some signal processing technics like SDV, ICA, wevelet decomposition, it is not possible to reconstruct the PPG waveform that contains the periodic pattern. It is impossible for us to calculate the heart rate directly in the time domain. Therefore we divide the ﬁltered PPG signals into small segments and apply the FFT algorithm to obtain the spectrum in order to ﬁnd the heart rate in the frequency domain.
10

(a) Clean PPG from wrist;
(b) PPG with 30s motion artifact;
(c) PPG during walking.
Figure 2.4: 30s PPG spectrum under diﬀerent conditions: 11

After the raw PPG signals have been processed through the adaptive ﬁlter, the motion artifact that resides outside the heart rate band is reduced. However, some daily life activity will introduce motion artifact with the frequency that overlaps with the heart rate band. Fig. 2.4(a) shows the spectrum of a 30 seconds clean PPG signals. In the heart rate band, the highest peak the highest peak is generated by heart rate and since the clean PPG has a quasi-periodic waveform, we could also observe two harmonic peaks of the heart rate peak which is located in the two and three times frequency of the heart rate peak. Fig. 2.4(b) shows the spectrum of a 30 seconds PPG signals during running. We can observe that the motion artifact generates the highest peak at around 1:5 Hz which corresponds to the frequency of swinging arms. The peak at around 3 Hz (two times of the frequency of the highest peak) is the harmonic of the motion artifact. Heart rate peak is preserved but is not the one with the strongest magnitude. This ﬁgure correspond to the common case in the motion distorted PPG spectrum that heart rate peak and other peaks caused by motion artifact coexist in the spectrum. So we can still design a method to identify which one is the heart rate peak.
In Fig. 2.2(d), we have shown that the PPG signals acquired from vertically placed arm has a very poor signal quality. This makes the heart rate peak in the PPG signals during walking undistinguishable. In Fig. 2.4(c), the heart rate peak has low magnitude and is submerged in motion artifact and other noises. This problem exists in over half of the data we gathered from diﬀerent subjects. Thus, we need to treat the PPG signals during walking as a special case, and add a extra branch in our heart rate searching algorithm in order to provide a reliable heart rate value.
The heart rate searching algorithm is designed to locate the peak corresponding to the heart rate which is mixed with motion artifact. For the walking case, we design a modiﬁed version to tackle poor signal quality. Before conducting the FFT, We used the 3-axis acceleration signals to identify
12

whether the user is walking. The x, y, z axis acceleration time series are divided into 2 seconds segments, and we will calculate the mean of the samples in each segment. Since walking is a regular motion, the values of the 3-axis acceleration change steadily in three intervals correspondingly. If the mean of the 3-axis acceleration value is within the intervals, then the user activity is classiﬁed as walking. If the user activity is not classiﬁed as walking, the algorithm will execute the normal procedure. Current heart rate will be calculated using the 30 seconds PPG signals spectrum.
Given the spectrum of the ﬁltered PPG signals, we need to ﬁrst locate all the possible peaks of heart rate. From the gathered data, we observe that, for most of the time during motion, the heart rate peak is within the 3 highest peaks in the heart rate band. Thus, we begin by ﬁnding the highest peak p1 and the second highest peak P2. If the distance between P2 and P1 is smaller than the threshold 0.3 Hz, P2 will be discarded, and we will ﬁnd the next highest peak for P2. The distance threshold is set to avoid selecting peaks that are too close to each other. P3 is the next highest peak after P2, also conforming with the distance condition. After P1, P2, P3 are selected, the one with the shortest distance to the previous selected peak Pi−1 will be chosen. Since every heart rate is calculated by a 30 seconds long PPG signal and we update the heart rate every second using the latest 30 seconds PPG signal. Two consecutive heart rate value is calculated by 29 seconds identical PPG signal only 1 second in the 30 seconds signal is diﬀerent, so the variance of two consecutive heart rate value should be little. Thus we refer to the previous heart rate value to identify the current heart rate peak. In some rare cases, the heart rate peak might not contain in the highest peaks in the PPG spectrum. We add a step to calculate the exponential weighted average of the last 10 seconds heart rate. By adding this step, we could reduce the error if such situation occurs. And calculating the exponential weighted average could also make the heart rate output smoother. We also set a saltation penalty to avoid dramatic heart rate change within a short period of time. Finally, the heart
13

rate is calculate by the frequency of the modiﬁed Pi. The main procedure will update heart rate value every second.
5 Extra Branch Estimate Heart Rate During Walking
For the PPG signals during walking, the above algorithm will result in great error because the heart rate peak is usually submerges in the motion artifact and other noises. If we use the procedure above to calculate heart rate, the high three peaks selected in the PPG spectrum will have a large probability that miss the heart rate peak. If this situation happens continuously the heart rate value will have error larger and larger.
We handle this problem based on three strategies. The ﬁrst is based on the heart rate changing pattern shown in Fig. 2.5 During regular motion like walking, the heart rate will go through two stages: rising period and stable period. During the rising period, the heart rate will go up rapidly within the ﬁrst 30 seconds. The duration of rising period varies in diﬀerent individuals and for diﬀerent motion intensity. If the motion intensity does not change much, such as walking with a steady velocity, the heart rate will enter a stable period that only has little heart rate variation. As the heart rate changes rapidly during rising period, the energy of heart rate disperses and cannot accumulate a strong magnitude in the spectrum. But in the stable period, heart rate varies little so it can form a distinguishable peak in the spectrum. We diﬀerentiate rising period and stable period at the point of 40 seconds during walking. Then we will conduct FFT using the ﬁrst 60 seconds of PPG during stable period (40 seconds to 100 seconds).
We can not locate the heart rate by ﬁnding the peak with the shortest distance with the previous peak, because during walking, heart rate is updated less frequently. So we introduce second strat-
14

Figure 2.5: Heart Rate Changing Pattern Under Regular Motion
egy, the normal heart rate during walking is between 60-120 bpm. With this knowledge, we can narrow the searching range to 1-2Hz. Also, the major motion artifact caused by walking is mostly less than 1Hz, so the heart rate peak will be the dominant component within the 1-2Hz band. Thus, we will select the highest peak within a 1-2Hz to generate the heart rate in the stable period.
The third strategy is that we increase the processing length. In the previous procedure each heart rate value is calculated by a 30 seconds long PPG signal. But in walking case, 30 seconds is still too short for heart rate to form a clear peak in the spectrum. So we increase the processing length to 60 seconds.
The ﬁrst 60 seconds heart rate during stable period will be all set to the same value. After that, heart rate will be updated every 10 seconds using the same strategy. We compromise the updating frequency for a reliable heart rate value. The 40 seconds rising period heart rate will be calculated by using the last heart rate before walking and the ﬁrst heart rate in the stable period. Since the rising period lasts less than a minute and the heart rate is monotonically increasing, it is suﬃcient to use the above two values and the linear ﬁtting to reconstruct the heart rate in the rising period.
Since we used a simple algorithm to classify walking and other motions, in some rare cases, the classiﬁcation could go wrong. If this situation happens, the method will not switch to the branch
15

that process the signal while walking, the main procedure will go on executing. There will be two possible result. First, the spectrum of PPG still have a heart rate peak within the three highest peaks, then the method is able to produce a accurate heart rate value. But, more likely, the heart rate peak will not be in the three highest peaks since the signal quality is poor and it will result in a messy spectrum. If we encounter this case, there also will be two possible result. First, even the main procedure select a wrong heart rate peak, however, the wrong heart rate peak is locate near by the real heart rate frequency. in this case, after calculating the weighted average the estimated heart rate value will be close to the real heart rate value. There is a step in the main procedure which will compare the current selected heart rate peak’s frequency to the previous heart rate frequency. We set a threshold value as 30 bpm to identify wether the current selected heart rate peak’s frequency has too much variance to the previous heart rate frequency. If the wrong heart rate peak is locate far away the real heart rate frequency that exceeds the threshold value. Then the method will deﬁne the current selected heart rate peak as a false one and discard it. Then the current heart rate value will be set to the value of previous heart rate result.
16

Algorithm 1: Heart Rate Searching Algorithm

1: Incoming PPG signals with body status tag;

2: if Body status is non-walking then

3: Update 1s PPG and Conduct 30s FFT;

4: Select 0.83 - 3.33Hz band of spectrum;

5: Let P denote the set of frequency values in the heart rate band and Pmax denote the frequency in P with the

maximum magnitude;

6: P1 = Pmax, P = P\P1;

7: P2 = Pmax, P = P\P2;

8: while |P1 − P2| < 0.3 do

9:

P2 = Pmax, P = P\P2;

10: end while

11: P3 = Pmax, P = P\P3;

12: while |P1 − P2| < 0.3 and |P2 − P3| < 0.3 do

13:

P3 = Pmax, P = P\P3;

14: end while

15: Pi = arg min |p − Pi−1|;

p∈{P1 ,P2 ,P3 }

16:

Smooth Pi as: Pi = 29Pi−9 +

8 j=0

Pi−

j2−

j−1;

17: if |Pi − Pi−1| > 0.5 then

18:

Pi = Pi−1;

19: end if

20: Calculate heart rate Hri by Pi;

21: else

22: if Body status is walking then

23:

Let P0 be the last stable frequency before walking.

24:

if Walking duration is fewer than 100s then

25:

Record PPG;

26:

end if

27:

if Walking duration is 100s then

28:

Conduct 60s FFT on 40s-100s PPG during walking;

29:

Select 1-2 Hz band of spectrum;

30:

Pstable = Pmax;

31:

Calculate walking stable heart rate Hrstable by Pstable for 40s-100s during walking;

32:

Calculate walking rising heart rate Hrrising for 0s-40s during walking by linear ﬁtting on P0 and Pstable;

33:

end if

34:

if Walking duration is greater than 100s then

35:

Update 10s PPG and conduct 60s FFT;

36:

Select 1-2Hz band of spectrum;

37:

Pistable = Pmax;

38:

Calculate walking stable heart rate Hristable by Pistable for these 10s during walking.

39:

end if

40: end if

41: end if

17

CHAPTER 3
EXPERIMENT
1 Material and Setup
We conduct experiments aim at measuring real wrist reﬂected PPG signal from diﬀerent subjects. We asked the subjects simulate diﬀerent daily life motion so we could collect the motion distorted PPG signal to test our proposed method.
The experimental PPG monitoring system consists of two PPG sensors, two control boards and one 3-axis accelerometer. The PPG sensor we used is called Pulse Sensor [21], which is a plugand-play device developed by an open source hardware project. We chose Bluno Nano [22] as the control board, which is designed based on another open source hardware Arduino Uno. It is embedded with BT 4.0 (BLE) module so that the acquired data can be exported via Bluetooth. The accelerometer we used is ADXL345 module from Analog Devices. The accelerometer used I2C protocol to communicate with the control board.
Fig. 3.1 shows the experiment scenario. One Pulse Sensor is attached on the left arm wrist to record the wrist PPG signals. It is connected to the Bluno Nano control board through dupont wire. The accelerometer is also attached on the left wrist next to the Pulse Sensor and connected to the Bluno Nano control board through dupont wire. Another Pulse Sensor is attached on the right hand
18

Figure 3.1: Experiment scenario ﬁnger, also connected to the Bluno Nano control board through dupont wire. The other Bluno Nano control board is connected to the laptop. The analog signals acquired by the Pulse Sensor and the accelerometer will be processed by the MCUs ADC function of the control board with a sampling rate of 125Hz. Then the signals will be transmitted out in real time and received by the Bluno Nano that connected to the laptop. The laptop will record the data and we use Matlab to process the PPG and acceleration data oﬀ-line.
19

Figure 3.2: Motion distribution during experiments
2 Motion Classiﬁcation
Daily life activities contain various sophisticated motions triggered by hundreds of joints and skeletal muscle on human body. We mainly focus on the motions that will aﬀect wrist PPG signals. We classify daily life motions into two categories: arm motion and body motion. The arm motion does not contain the motions from other parts of the body and it only lasts for a shorts period of time (a few seconds). The intensity of arm motion is relatively low compared to body motion. For body motion, we refer to walking and running. Body motion is regular, and usually lasts from tens of seconds to several minutes, or even longer.
We further divide arm motion into six types. The classiﬁcation criteria is based on the diﬀerent orientation of arm movement under diﬀerent activities. For the ﬁrst three types, the motion of the forearm is only driven by the elbow joint, while the upper arm remains steady.
• Arm motion 1: move the forearm horizontally.
20

• Arm motion 2: move the forearm up and down. • Arm motion 3: move the forearm in circle.
The other three types arm motion contain the movement from both forearm and upper arm. The shoulder joint and elbow joint also participate in the movement simultaneously.
• Arm motion 4: move the arm left and right (similar to wiping window). • Arm motion 5: move the arm up and down (similar to shaking hand). • Arm motion 6: move the arm front and back (similar to punching).
Fig. 3.2 shows the motion distribution in diﬀerent motion cases. In arm motion experiment, we record a seven minutes consecutive PPG signal contains the above six types of arm motion. Each motion is performed four to six seconds at the start of each minute and repeat once at half the minute. The arm keeps static at remaining time.
For walking and running experiments, we asked the subjects to walk and run in a comfortable style as they do ordinarily. The duration of recorded PPG signal is seven minutes long; at the beginning of the second second the subject start walking or running and it lasts for three minutes. The last three minutes the subject sits statically. Due to the Bluetooth has a limited transmission range, walking and running is performed in situ.
3 Subjects
In total sixteen healthy subjects (6 female 10 male) had participated in the preliminary and formal test. One of the subject is 43 years old. One of the subject is 55 years old. The remaining
21

subjects are all twenties. We acquired at least ﬁve subjects data in the formal arm motion, walking and running experiments each.
22

CHAPTER 4
EVALUATION RESULTS
To generate the correct heart rate as reference, we collected the PPG from right hands ﬁnger. The ﬁnger PPG is acquired with the wrist PPG simultaneously and the right hand is remained motionless during the whole experiment. Heart rate is calculated by a naive heart rate searching algorithm which select the highest peak within the heart rate band from the FFT spectrum. Since the PPG signal collected from ﬁnger is clean and with good quality, such naive algorithm is capable of generating a reliable heart rate. Fig. 11 shows the qualitative performance of our proposed method. Fig. 12 gives quantitative results.
We apply the naive heart rate searching algorithm on the wrist PPG of arm motion and running and compare it to the designed algorithm to illustrate how the motion artifact aﬀect the estimation of heart rate. Fig. 4.1(a)(b) show the estimated heart rate in the case of arm motion and running respectively. The red curve is the reference heart rate estimated by the ﬁnger PPG using the naive algorithm, green curve is heart rate estimated by our proposed algorithm with wrist PPG and blue curve is heart rate estimated by naive algorithm with wrist PPG. In the arm motion case, the motion artifact is evenly distributed among the whole measurement. We could see large errors (over 20 bpm) occur at several places which last for a few seconds because of the motion artifact caused by arm motion. The heart rate estimated by our proposed algorithm ﬁt the reference heart rate
23

tightly. In the running case, naive algorithm causes errors continuously during the running period. The heart rate estimated by our proposed algorithm is almost ﬁt with the reference heart rate, only slight error (within 5 bpm) occurs during 90 100s.
In Fig. 4.1(c) we use the normal procedure of the algorithm to process the walking PPG and compare the estimated heart rate to the result from the walking process part of the algorithm. Red curve is the reference, green curve is the result of the walking process part and the blue curve is the result of the normal part. We could see blue curve is almost part from the reference during the whole walking period. The errors are larger than 20 bpm even though it is generated by the normal heart rate selection part of our proposed algorithm. The reason had stated before, heart rate peak is submerged in the spectrum and the normal selection procedure is bootless. The walking process part of the algorithm compromises the updating frequency for reliability. So we could see the heart rate during the walking period is a straight line which could not reﬂect the subtle change but the error is acceptable.
The three cases in Fig. 4.1 represent the general result from our experiment. Under diﬀerent types of motion, our proposed algorithm could extract heart rate that changed with the reference closely with acceptable error.
The aggregate heart rate error results are showed in the Bland-Altman plots. Fig. 4.2(a)(b)(c) corresponds to the arm motion, running and walking case. Each plot contains the 1950 pairs of estimated-reference heart rate errors from ﬁve diﬀerent subjects. In the arm motion case, errors are evenly distributed in diﬀerent heart rate zones, most of the errors are between -7.1 and 5.3 bpm which are in 95% agreement (mean1.96SD). In running case, the errors in higher heart rate zone (greater than 110 bpm) are larger than those in the lower heart rate zone because higher heart rate appears during the subject is running that causes motion artifact. Some errors are larger than 10
24

bpm but most of the errors are between -7.6 and +7.7 bpm. Several errors larger than 20 bpm occur. Consider the amount of points plot in the ﬁgure, the probability of larger error over 20 bpm is less than 1%. The errors distributed in the walking case are close to those in running case. Some errors larger than 10 bpm occur at the lower part of the ﬁgure. Errors within 95% agreement are between -7.6 and +6.6 bpm. In all cases, most of the errors within 95% reliability are within 10 bpm. Large errors exist but have a probability less than 1%. Thus our proposed algorithm is considered capable of generating an acceptable heart rate under diﬀerent types of motion artifact.
In [8], the author proposed a method estimating heart rate in frequency domain and evaluated their method using the PPG data while running. Since we have use similar wrist-acquired PPG data so we use the result of our running case to compare with the result in [8]. The author of [8] used two criteria to evaluate their method result namely correlation coeﬃcient and standard deviation of error. The correlation coeﬃcient r =0.98 and the standard deviation of error SD = 8.7 bpm in their result. We also calculate these two criteria. In our method the correlation coeﬃcient r =0.98 and the standard deviation of error SD = 3.9 bpm. We have same correlation coeﬃcient result with [8] but we have better value of standard deviation of error.
25

(a) arm motion experiment, red curve: reference heart rate, green curve:heart rate estimated by our proposed algorithm, blue curve: heart rate estimated a naive algorithm;
(b) running experiment, red curve: reference heart rate, green curve:heart rate estimated by our proposed algorithm, blue curve: heart rate estimated a naive algorithm;
(c) walking experiment, red curve: reference heart rate, green curve:heart rate estimated by the walking part of our proposed algorithm, blue curve: heart rate estimated by the normal part of our proposed algorithm.
Figure 4.1: Comparison of heart rate generated by our proposed algorithm and a naive heart rate searching algorithm in diﬀerent experiments:
26

(a)
(b)
(c)
Figure 4.2: Bland-Altman plots of heart rate errors in diﬀerent experiments: 27

CHAPTER 5
DISCUSSION
In this chapter, we are going to discuss several issues that occurred during conducting this work which are related to diﬀerent aspects of our proposed method of heart rate estimation.
The ﬁrst issue is the phenomenon of signal quality variance caused by diﬀerent placement orientation of the arm. In the second chapter, we showed two pieces of clean wrist-acquired PPG time series. One is from horizontally placed wrist, the other is from vertically placed wrist. We found out the signal quality of the latter is worse. Such phenomenon caused a very bad signal quality during walking as the arm is swinging in a vertical direction. We could not ﬁnd literature that address this phenomenon. But we hypothesise it is caused by the alignment of the direction of the gravity and the direction of the blood ﬂow in the artery. If the cause of this phenomenon could be identiﬁed, it may help us choose proper ﬁlter to process the signal during walking and adjust the heart rate estimation method thus improve the accuracy of the calculated heart rate.
The second issue is the limited variety of subjects participated in the experiment. Among the 16 subjects, most of them are twenties. Only two of the subjects are thirties and forties. We did not collect any data from children and senior citizen. Since individual variance may aﬀect the signal quality thus aﬀect the output of the estimated heart rate. There might be variation of the error rate in the evaluation part if we involve children and senior citizen in our experiment.If we could test
28

the algorithm on more diverse age subjects, we will have more comprehensive evaluation result. The third issue is the complexity of our method. Our proposed method is used to process the
PPG signal from the wrist. It will most likely execute on a wearable device like watch or wrist. The complexity of the method will aﬀect the computation capability and the power consumption. Diﬀerent software ﬁlter algorithm and FFT algorithm will aﬀect the method’s complexity as well as the processing length of the PPG signal. With lower complexity, we could save the computation resource of the micro process as well as the power of the wearable device. However, reduce the complexity of diﬀerent component of the method might also decrease the accuracy of the estimated heart rate. So we must trade of between the complexity and accuracy to ﬁnd a balanced point.
29

CHAPTER 6
CONCLUSION
In this thesis, we ﬁrst motivated by the ﬂexibility of reﬂected PPG sensor which could enable a way for unconstraint daily life heart rate monitoring. We collected motion artifact distorted reﬂected PPG data from diﬀerent subjects and applied some existing signal processing method like SDV, ICA, wavelet decomposition try to reconstruct the waveform of PPG but it did not work well.
So we developed a new method which estimates heart rate in frequency domain of PPG. We choose adaptive ﬁlter with a synthetic reference to eliminate the noise outside the heart rate band and use FFT to obtain the PPG spectrum. Our heart rate detection algorithm is able to locate the heart rate peak in the spectrum which is mixed with motion artifact buy referring to the previous estimated heart rate. We also added a special branch in the algorithm to deal with the very poor signal quality during walking which increase the processing length and calculated the heart rate in stable period of walking.
We used some open source hardware namely Pulse Sensor, Bluno Nano to construct the data measurement system. Experiments had been carried out to collect PPG signal distorted by diﬀerent types of motion artifact including arm motion, walking and running. 16 subjects had participated in the experiment. The evaluation results showed that most of the heart rate error of the three diﬀerent motion cases are all within 8 bpm which showed the method has a acceptable error rate.
30

Our proposed method can be further applied to wearable devices like wrist band or watch so that daily life long-term heart rate monitoring could be achieved.
31

Bibliography
[1] Alivecor, “Mobile ECG.” http://www.alivecor.com/why-use-it/. [2] Omron, “HCG801.” http://www.omron-healthcare.com/eu/en/our-products/
electro-cardiograph/hcg-801/. [3] Garmin, “Soft strap premium heart rate monitor.” https://buy.garmin.com/en-
US/US/shop-by-accessories/fitness-sensors/soft-strap-premium-heartrate-monitor/prod15490.html/. [4] R. Youseﬁ, M. Nourani, S. Ostadabbas, and I. Panahi, “A motion-tolerant adaptive algorithm for wearable photoplethysmographic biosensors,” Biomedical and Health Informatics, IEEE Journal of, vol. 18, no. 2, pp. 670–681, 2014. [5] E. S. Winokur, D. D. He, and C. G. Sodini, “A wearable vital signs monitor at the ear for continuous heart rate and pulse transit time measurements,” in Engineering in Medicine and Biology Society (EMBC), 2012 Annual International Conference of the IEEE, pp. 2724–2727, IEEE, 2012. [6] M. Grubb, J. Carpenter, J. A. Crowe, J. Teoh, N. Marlow, C. Ward, C. Mann, D. Sharkey, and B. R. Hayes-Gill, “Forehead reﬂectance photoplethysmography to monitor heart rate:
32

preliminary results from neonatal patients,” Physiological measurement, vol. 35, no. 5, p. 881, 2014. [7] H. Han and J. Kim, “Artifacts in wearable photoplethysmographs during daily life motions and their reduction with least mean square based active noise cancellation method,” Computers in biology and medicine, vol. 42, no. 4, pp. 387–393, 2012. [8] H. Fukushima, H. Kawanaka, M. S. Bhuiyan, and K. Oguri, “Estimating heart rate using wrist-type photoplethysmography and acceleration sensor while running,” in Engineering in Medicine and Biology Society (EMBC), 2012 Annual International Conference of the IEEE, pp. 2901–2904, IEEE, 2012. [9] Y. Maeda, M. Sekine, and T. Tamura, “Relationship between measurement site and motion artifacts in wearable reﬂected photoplethysmography,” Journal of medical systems, vol. 35, no. 5, pp. 969–976, 2011. [10] K. A. Reddy and V. J. Kumar, “Motion artifact reduction in photoplethysmographic signals using singular value decomposition,” in Instrumentation and Measurement Technology Conference Proceedings, 2007. IMTC 2007. IEEE, pp. 1–4, IEEE, 2007. [11] B. S. Kim and S. K. Yoo, “Motion artifact reduction in photoplethysmography using independent component analysis,” Biomedical Engineering, IEEE Transactions on, vol. 53, no. 3, pp. 566–568, 2006.
33

[12] M. Raghuram, K. V. Madhav, E. H. Krishna, N. R. Komalla, K. Sivani, and K. A. Reddy, “Hht based signal decomposition for reduction of motion artifacts in photoplethysmographic signals,” in Instrumentation and Measurement Technology Conference (I2MTC), 2012 IEEE International, pp. 1730–1734, IEEE, 2012.
[13] M. Raghuram, K. V. Madhav, E. H. Krishna, and K. A. Reddy, “On the performance of wavelets in reducing motion artifacts from photoplethysmographic signals,” in Bioinformatics and Biomedical Engineering (iCBBE), 2010 4th International Conference on, pp. 1–4, IEEE, 2010.
[14] C. Lee and Y. Zhang, “Reduction of motion artifacts from photoplethysmographic recordings using a wavelet denoising approach,” in Biomedical Engineering, 2003. IEEE EMBS AsianPaciﬁc Conference on, pp. 194–195, IEEE, 2003.
[15] Y.-S. Yan and Y.-T. Zhang, “An eﬃcient motion-resistant method for wearable pulse oximeter,” Information Technology in Biomedicine, IEEE Transactions on, vol. 12, no. 3, pp. 399– 405, 2008.
[16] M. R. Ram, K. V. Madhav, E. H. Krishna, K. N. Reddy, and K. A. Reddy, “Use of multiscale principal component analysis for motion artifact reduction of ppg signals,” in Recent Advances in Intelligent Computational Systems (RAICS), 2011 IEEE, pp. 425–430, IEEE, 2011.
34

[17] S. H. Kim, D. W. Ryoo, and C. Bae, “Adaptive noise cancellation using accelerometers for the ppg signal from forehead,” in Engineering in Medicine and Biology Society, 2007. EMBS 2007. 29th Annual International Conference of the IEEE, pp. 2564–2567, IEEE, 2007.
[18] S. Kunchon, T. Desudchit, and C. Chinrungrueng, “Comparative evaluation of adaptive ﬁlters in motion artifact cancellation for pulse oximetry,” in Signal Processing & Its Applications, 2009. CSPA 2009. 5th International Colloquium on, pp. 307–311, IEEE, 2009.
[19] M. R. Ram, K. V. Madhav, E. H. Krishna, K. N. Reddy, and K. A. Reddy, “Adaptive reduction of motion artifacts from ppg signals using a synthetic noise reference signal,” in Biomedical Engineering and Sciences (IECBES), 2010 IEEE EMBS Conference on, pp. 315–319, IEEE, 2010.
[20] M. R. Ram, K. V. Madhav, E. H. Krishna, N. R. Komalla, and K. A. Reddy, “A novel approach for motion artifact reduction in ppg signals based on as-lms adaptive ﬁlter,” Instrumentation and Measurement, IEEE Transactions on, vol. 61, no. 5, pp. 1445–1457, 2012.
[21] Pulsesensor, “Pulse sensor.” https://pulsesensor.myshopify.com/. [22] Dfrobot, “Bluno nano.” https://www.dfrobot/.
35

