电子科技大学
UNIVERSITY OF ELECTRONIC SCIENCE AND TECHNOLOGY OF CHINA
硕士学位论文
MASTER THESIS

论文题目 面向穿戴应用的心电信号处理方法及软件实现

学科专业

学

号

作者姓名

指导教师

控制科学与工程 201521070305 占峰松
夏侯士戟 副教授

分类号 UDC 注 1

密级

学位论文
面向穿戴应用的心电信号处理方法及软件实现
（题名和副题名）

占峰松
（作者姓名）

指导教师

夏侯士戟 电子科技大学

副教授 成都

（姓名、职称、单位名称）

申请学位级别 硕士 学科专业 控制科学与工程

提交论文日期 2018.04.10 论文答辩日期

2018.05.07

学位授予单位和日期 电子科技大学

2018 年 6 月

答辩委员会主席

胡江平

评阅人

陈东义

黄志奇

注 1：注明《国际十进分类法 UDC》的类号。

Wearable application-oriented ECG signal processing method and software implementation

A Master Thesis Submitted to University of Electronic Science and Technology of China

Discipline: Author:
Supervisor: School:

Control Science and Engineering Fengsong Zhan
Prof. Xiahou Shiji School of Automation Engineering

独 创 性 声 明

本 人声 明 所 呈 交 的 学位 论文 是本 人在 导 师 指 导 下 进 行 的 研 究 工 作 及取得 的 研 究 成 果 。 据 我 所知 ， 除 了 文 中 特 别 加 以 标 注和 致 谢 的 地 方   夕 卜 ， 论 文 中 不 包含 其他 人 己 经 发表 或 撰 写 过 的 研 宄 成 果 ， 也 不 包含 为   获得 电 子科 技大 学或 其 它 教 育 机构 的 学 位 或 证书 而使 用 过 的 材料 。 与  

我 一 同 工 作 的 同 志 对 本 研 究 所做 的 任何 贡献 均 已 在 论文 中 作 了 明 确 的

说 明 并表 示 谢 意 。  

 ＊ ，  

＾ 作 者签名 ：

 ４＾５

曰期

＿

年 ６ 月 、 日   丨

论 文 使 用 授权  
本 学 位 论文 作 者完 全 了 解 电 子科 技大 学 有 关保 留 、 使 用 学位 论 文   的 规 定 ， 有 权保 留 并 向 国 家 有 关 部 门 或 机构 送 交论 文 的 复 印 件 和 磁盘 ，   允许 论文 被查 阅 和 借 阅 。 本人 授权 电 子 科技 大学 可 以 将 学 位 论文 的 全   部 或部 分 内 容编 入有 关 数据 库 进 行 检 索 ， 可 以 采 用 影 印 、 缩 印 或扫 描 等 复 制 手 段保存 、 汇 编 学位 论 文 。
（ 保 密 的 学 位 论文在解 密 后 应遵 守此 规定 ）

作 者签



导师签名 ：

期 日

：

  

年 月 ６

（

日  

｜

摘要
摘要
随着人们生活水平的提高、生活节奏的加快，心脏疾病的发病率迅速上升，成 为威胁人类身体健康的主要因素之一。心脏疾病发作迅速，发作时间不确定，需 要长时间监测人体的心脏活动来加以应对。心电图是记录心脏每一心动周期所产 生的电活动变化的图形，是诊断心脏疾病的主要依据，且具有方法简便，诊断可 靠，对病人无损害的优点。
利用可穿戴计算技术能够将织物电极、模拟前端、处理器和通信电路等集成在 胸带等形式的衣物中，实现长期持续的心电监测。本文的主要工作是面向这类可 穿戴心电监测系统，设计相关的心电信号处理方法，并进行软件实现。系统可实 时地采集、存储和处理心电信号，对心电信号进行特征提取，计算心电特征参数， 根据预置或用户自定义的策略，实时的检测出异常的心电信号片段。
本文的主要研究内容如下： (1) 结合心电信号处理与分析的相关技术理论，对软件系统进行需求分析，完 成软件系统的总体设计，按照功能将软件系统分为：心电信号数据采集与存储、 心电信号预处理、心电信号特征提取、心电信号分析和可视化及用户交互等主要 功能模块，并分别陈述各功能模块的设计要求。 (2) 软件系统各功能模块的详细设计，具体包括：在心电信号采集和存储模块 实现了硬件数据传输、心电数据包解析和数据存储等功能；在心电信号预处理模 块中引入小波变换法去除基线漂移，引入经验模态分解与主成分分析相结合的方 法去除肌电干扰，并利用 MIT-BIH 公开数据库对两种算法进行了验证分析；在心 电信号特征提取模块中引入差分阈值法和小波变换法提取心电信号的关键特征参 数；在心电信号分析模块中使用逻辑分支判断法检测异常心电信号片段等等。此 外，还完成了心电信号波形实时显示、用户交互组件等用户界面模块的详细设计。 (3) 利用 Python 程序设计语言，编码实现整个软件系统，然后对软件系统作功 能测试，经验证软件系统每个功能模块均达到了设计要求。通过实验采集的心电 信号数据，将信噪比、均方差、心率敏感性和心率变异性作为评判指标对软件系 统作性能分析，计算结果表明，在静止和慢走的情况下，心电信号预处理的效果 较好，R 波的定位非常准确。使用 MIT-BIH Arrhythmia 数据库中的数据检验异常 心电信号检测算法，计算得到异常检测的准确率为 93.3%。 在此研究基础上，本文在心电信号分析模块中提出了用户自定义诊断功能，用 户通过配置诊断规则来添加新的异常心电信号检测类型。
关键词：心电图，预处理，特征提取，异常检测
I

ABSTRACT
ABSTRACT
With the improvement of people’s living standards and the quickening pace of life, the morbidity of heart disease is rising rapidly and it becomes one of the major factors that threaten human’s health. Heart attack is rapid and its attack time is uncertain, it needs long lasting monitoring of human’s heart activity. Electrocardiogram is a graph that records the change of electrical activity generated by each cardiac cycle of the heart. It is the main basis for diagnosing heart disease, and has the advantages of briefness, reliable diagnosis, and no harm to the patient.
Using wearable computing technology to integrate fabric electrodes, analog front ends, processors, and communication circuits in chest strap or other forms of clothing to enable long lasting ECG monitoring. The main work of this paper is designs related ECG signal processing methods for such wearable ECG monitoring system and completes software implementation. The system can collect, store and process ECG signals in real time, extract features, calculate ECG feature parameters, and detect abnormal ECG signal segments in real time according to preset or user-defined strategies.
The research contents of this paper are summarized as follows： (1) Combine the related technical theories of ECG signal processing and analysis to do requirement analysis on the software system, and complete the overall design of it.The software system can be divided into modules according to its functions, including: ECG signal data acquisition and storage, preprocessing, feature extraction, ECG signal analysis, visualization and user interaction. The design requirements for each functional module has been stated. (2) Design each functional module of the software system separately, including: the process of ECG signal transmission, the process of ECG data package parsing, and the process of ECG data storage implementation; the implementation process of using wavelet transform to remove baseline drift and using a method by combining empirical mode decomposition and principal component analysis to eliminate EMG interference, and use the ECG data in MIT-BIH database to simulate the above two algorithms; the implementation process of ECG feature extraction using differential threshold method and wavelet transform; the implementation process of using logic branch judgement
II

ABSTRACT
method to detect the abnormal ECG signal segments; the overall layout of the software system, real-time display of ECG waveforms and the components that implement user interaction.
(3) Coding to implement the whole software system by using Python programming language, do functional test on the software system, and verify that each functional module of software system meets the design requirements. The signal-to-noise ratio, mean square error, heart rate sensitivity and variability are used as indicators to evaluate the performance of the software system using ECG data acquired by experiments. The calculation results show that in the case of resting and slow walking, the effect of ECG signal preprocessing is good, and the R-wave location achieves high accuracy. Using the data from the MIT-BIH Arrhythmia database to test abnormal ECG detection algorithms, the accuracy of the anomaly detection is 93.3%.
Based on the research, the ECG signal analysis of software system proposes a user-defined diagnostic function and adds a new kind of detected abnormal ECG signal by configuring a diagnostic rule. Keywords: ECG, preprocess, feature extraction, abnormal detection
III

目录
目录
第一章 绪 论 ·······················································································1 1.1 研究背景与意义 ................................................................................................ 1 1.2 国内外研究现状 ................................................................................................ 2 1.2.1 可穿戴心电监测装置的研究现状 .......................................................... 2 1.2.2 心电信号处理方法的研究现状 .............................................................. 3 1.3 本文的主要研究内容 ........................................................................................ 4 1.4 本文的组织结构 ................................................................................................ 4
第二章 总体设计与相关技术理论 ·····························································5 2.1 可穿戴心电信号采集系统概述 ........................................................................ 5 2.2 心电信号处理与分析的相关技术 .................................................................... 6 2.2.1 心电信号预处理 ...................................................................................... 6 2.2.2 心电信号特征提取 .................................................................................. 7 2.2.3 心电信号分析 .......................................................................................... 8 2.3 软件系统需求分析与总体设计 ........................................................................ 9 2.3.1 需求分析 .................................................................................................. 9 2.3.2 相关技术指标 .........................................................................................11 2.4 本章小结 .......................................................................................................... 13
第三章 可穿戴心电检测软件系统的设计 ··················································14 3.1 心电信号采集与存储模块的详细设计 .......................................................... 14 3.2 心电信号预处理方法的对比分析 .................................................................. 17 3.2.1 去基线漂移方法的对比分析 ................................................................ 17 3.2.2 去肌电干扰方法的对比分析 ................................................................ 19 3.3 心电信号预处理模块的详细设计 .................................................................. 20 3.3.1 去基线漂移算法的设计 ........................................................................ 20 3.3.2 去肌电干扰算法的设计 ........................................................................ 23 3.3.3 仿真分析 ................................................................................................ 26 3.4 心电信号特征提取模块的详细设计 .............................................................. 28 3.4.1 基于差分阈值法的心电波形检测 ........................................................ 29 3.4.2 基于小波变换的心电波形检测 ............................................................ 31 3.4.3 特征参数的计算 .................................................................................... 34
IV

目录
3.5 心电信号分析模块的详细设计 ...................................................................... 35 3.5.1 常见异常心电信号诊断的设计 ............................................................ 35 3.5.2 用户自定义心电信号诊断的设计 ........................................................ 39
3.6 可视化与用户交互模块的详细设计 .............................................................. 41 3.7 本章小结 .......................................................................................................... 42 第四章 可穿戴心电检测软件系统的实现 ··················································44 4.1 开发环境的介绍 .............................................................................................. 44 4.2 心电信号采集与存储模块的实现 .................................................................. 45 4.3 心电信号预处理模块的实现 .......................................................................... 48 4.4 心电信号特征提取模块的实现 ...................................................................... 51 4.5 心电信号分析模块的实现 .............................................................................. 53 4.6 可视化与用户交互模块的实现 ...................................................................... 55 4.7 本章小结 .......................................................................................................... 58 第五章 系统测试与分析 ·······································································59 5.1 系统功能验证 .................................................................................................. 59 5.2 系统性能分析 .................................................................................................. 63 5.3 本章小结 ........................................................................................................... 66 第六章 总结与展望 ·············································································67 6.1 总结 .................................................................................................................. 67 6.2 展望 .................................................................................................................. 67 致 谢 ······························································································68 参考文献 ···························································································69
V

第一章 绪论
第一章 绪 论
1.1 研究背景与意义
我国自 1971 年开始实行计划生育以来，有效的减缓了人口的增长速度，但同 时也迎来了一个无法回避的问题，即人口老龄化问题。全国第六次人口普查的结 果显示，我国超过 65 岁的人口约为 1.19 亿，占总人口的 8.9%，这些数字意味着 我国已经步入了人口老龄化社会。随着年龄的增长，人体各个器官组织的机能会 出现衰退，容易受到各种疾病的困扰，因此老年人的健康问题一直是人们所关注 的一个热点问题。
心脏病是一种非常常见，并且严重威胁人类健康的疾病，尤其是老年人，我 国每年有几十万的人死于心脏病。心脏活动会产生电激动，电激动从心脏经人体 组织传导至体表，而心电图是记录心脏电活动变化的波形，反映了心脏兴奋产生、 传导和恢复的过程[1]。心电图是诊断心脏病的重要依据，在判断疗效上也起着重要 的作用。
常规的心电图检查有三种方式[2]，第一种是静息心电图检查，即人在静息状态 下通过心电图机从体表获取心脏每一活动周期的电活动变化。这种方式简单经济， 波形清晰，技术最为成熟，大部分心脏疾病都能检查出来。但是有一部分疾病， 其患者在做静息心电图检查时没有明显的症状，即心电图是正常的，因此这种情 况下采用静息心电图检查是不可行的。第二种方式是 24 小时动态心电图，俗称 “Holter 监测”，患者需要背上一个特制的仪器，仪器自动持续记录患者 24-72 小 时心电图的变化，可以通过重点分析患者有症状时段的心电图变化来提高诊断的 准确性。Holter 监测的缺点是需要长时间背一个仪器，并且采集的心电信号受到的 干扰较大，给分析带来了极大的困难。第三种方式是心电图运动试验，先通过一 定量的运动增加心脏负荷，然后观察心电图变化来进行临床评估。此方法简便实 用，费用低廉，无创伤，但是一定要注意控制运动幅度，否则可能产生严重的后 果甚至是死亡。第一和第三种方式均只采集和分析了一段短暂的心电信号，第二 种方式最长也只能持续监测 3 天，因为湿电极中含有导电凝胶，与皮肤长期接触 容易引起皮肤过敏。由于心脏疾病发作的突发性和不确定性，因此有必要找到一 种可长期监测心电信号的方式。
近年来，随着可穿戴计算技术的快速发展，对健康和医疗领域也产生了重大 的影响。通过将传感器嵌入到服饰、鞋帽、胸带等，来检测人体的各种生理信号， 进而实现对人体健康的实时监护。传统的湿电极含有导电凝胶，不宜长期与皮肤 接触。金属材料不耐腐蚀，在微电流作用下极化现象明显，干扰和噪声较大。金
1

电子科技大学硕士论文
属干电极的穿戴舒适性较差，运动伪迹明显。织物电极质地柔软，穿戴舒适，能 较好的贴合于人体皮肤，减小噪声和运动伪迹，适合用于长期监测心电信号。
将织物电极嵌入到衣服或胸带上，就可以持续的获取人体日常活动下的心电 信号，然后对获取的心电信号进行实时处理和分析，一旦发现心电异常可以及时 进行救治。许多心脏病患者都是因为救治不及时而死亡，如果有了这种可穿戴心 电信号检测系统，可以及时检测出心电异常，从而减少心脏病患者的死亡率。当 然可穿戴心电信号检测系统也面临着许多的问题，织物电极与皮肤的接触不如湿 电极紧密，与皮肤之间的阻抗特别大，因此引入的噪声也更复杂，信号处理与分 析的难度也会加大。
1.2 国内外研究现状
可穿戴心电监测装置能够长期监测人体的心电信号，其采用的心电信号处理方 法是人们的研究重点，国内外学者对可穿戴心电监测装置和心电信号处理方法的 研究从未停下脚步，涌现出了许多研究成果。
1.2.1 可穿戴心电监测装置的研究现状
从上世纪末开始，微处理器、微传感器、通讯技术和电子织物得到迅猛的发 展，许多学者开始将目光放在了研究新型的可穿戴心电检测装置上。通过将心电 检测装置穿在患者身上，可以长期监测人体的心脏活动状况，以便及时发现心电 信号异常，并且不影响患者的正常生活，为医生的快速准确诊断提供了极大的帮 助。经过各大高校和研究机构的不懈努力，可穿戴心电检测装置的研究涌现了许 多优秀的成果。
2003 年，Noury 等人研制了一种智能衣，可用于测量心率、呼吸、温度和运 动状态[3]。2005 年，意大利米兰理工大学研制了一款可采集多种生理信号的穿戴 式背心，包括心电、呼吸、温度及运动等，适合用于日常心肺功能的检测[4]。2006 年，飞利浦欧洲研究院研制了一种可获取心电和位置信息的穿戴式胸带，在胸带 中加入了 GPRS 传感器[5]。2008 年，Yang 等人研制了一种利用无线通讯进行数据 传输的心电监护帖，主要用于监测用户的心率变异性[6]。2010 年，葡萄牙阿威罗 大学研制了一种智能夹克，可采集心电、呼吸、温度、血氧饱和度等信息，主要 用于对重病患者和老年人的日常监护[7]。2013 年，Alexande 等人研制了一款多功 能监护帖，其内部包含微控制器和加速度计等模块，可监测人体心电、呼吸率等 人体生理特征参数[8]。
国内在可穿戴心电监护领域也取得了一定的成果。2004 年，中科院提出了基
2

第一章 绪论
于智能手机的穿戴式心电监测系统[9]，在智能手机上对心电信号进行处理，同时设 计了一套远程诊断服务平台共享心电信号处理后的结果供医生诊断。2007 年，哈 尔滨工业大学开发了腕带式健康监护系统[10]，其功耗特别低，使用周期长，可采 集心电、血压和温度。2012 年，澳门大学研制了穿戴式无线生物信号采集系统[11]， 可检测心电、脑电及肌电信号。2012 年，清华大学研制了一种集成有三轴加速度 计的智能心率带[12]，可以采集人体心电信号，通过一定的算法计算出心率，并将 心率发送给与之配对的智能手表。
1.2.2 心电信号处理方法的研究现状
由于受仪器、环境或人体自身的影响，在采集心电信号的过程中不可避免的会 引入一些噪声，常见的噪声包括：工频干扰、基线漂移和肌电干扰。为了去除心 电信号中的噪声，国内外学者提出了很多种方法[13]，如：主成分分析、独立成分 分析、神经网络、自适应滤波、经验模态分解和小波变换等。2004 年，CaiKun 提 出了一种改进的中值滤波法，有效地抑制了基线漂移[14]。2006 年，MA Mneimneh， EE Yaz，MT Johnson 和 RJ Povinelli 等人将自适应卡尔曼滤波用于去除基线漂移[15]， 去噪效果明显优于传统的去基线漂移方法，尤其是 ST 段。 2008 年，MaoLing 和 JiHu 提出运用两级形态学滤波器消除基线漂移的方法[16]，此算法是基于心电信号 的形态特征，采用两级形态学滤波器，分别选用不同的结构元素，在去除基线的 同时能很好的保留心电信号的原始形态。近些年来，小波变换法在心电去噪中的 应用越来越成熟。F.Nazan Ucar 提出基于多分辨率正交小波变换的去噪算法[17]， P.M.Agent 探索了用软阈值去除心电信号噪声[18]，E.Ercelebi 提出通过提升小波实 现心电信号去噪。Donoho 提出采用小波阈值去噪法去除心电信号中的肌电干扰[19]， 先对小波系数作阈值化处理，然后用阈值处理后的系数作信号重构。2006 年， Binwei Weng，Manuel Blanco-Velasco 和 Kenneth E. Barner 提出了基于 EMD 的心 电信号消噪方法[20]。该方法能在尽最大可能保留有效信号的同时，较好的去掉高 频干扰。
通过对心电信号波形的检测，可以得到许多反映心脏活动状况的信息参数，其 中最重要的是 QRS 波群的检测。目前 QRS 波群的检测方法有很多，其中最常用的 有阈值法、模板匹配法和小波变换法等[22]。Pan 等人提出的阈值法是一种比较经典 的方法[23]，其运算量小，容易实现且速度快。Collins 等人采用模板匹配法进行 QRS 波群检测[24]，先存储心电信号的模板，将待检测心电信号与模板中的心电信号进 行比较。Senhadji L 等人首先提出运用小波变换提取 QRS 波群[25]。Trahanias 利用 数学形态学的方法进行 QRS 波群的检测[26]，将此方法用于 CSE DS-1 数据库的测
3

电子科技大学硕士论文
试，其灵敏度达到了 99.38%。丁哨卫等人提出将小波分析与自适应滤波算法相结 合来检测 QRS 波群[27]，增强了对心电噪声的抗性。Vijaya 将人工神经网络的方法 应用于心电信号的波形检测[28]，能够高精度的检测到 QRS 波群。
1.3 本文的主要研究内容
本文主要是针对穿戴式的心电监测系统设计一个软件系统，用于实时采集、存 储和处理心电信号，及时发现异常的心电信号片段，减轻心脏疾病对人类健康的 危害，主要研究内容如下：
(1) 结合心电信号处理与分析的相关技术理论，对软件系统作需求分析，完成 软件系统的总体设计，按功能对软件系统进行模块划分，并概述各功能模块的设 计要求。
(2) 分别设计并实现软件系统的各个功能模块，具体包括：心电信号数据的传 输、解析与保存，心电信号预处理（去除基线漂移和肌电干扰），心电信号特征提 取，异常心电信号片段的实时检测，心电信号可视化和用户交互等。
(3) 对软件系统进行整体测试，检验每一个功能模块是否达到设计要求，对软 件系统作性能分析，分析心电信号预处理算法的效果、心电信号波形检测和心电 信号异常分析的准确率。
1.4 本文的组织结构
本文总共分为六章，每一章具体内容分别如下： 第一章：绪论。主要介绍本课题的研究背景和意义，国内外的研究现状，概述 本文的主要研究内容。 第二章：总体设计与相关技术理论。首先概述可穿戴心电信号采集系统，然后 介绍了心电信号处理与分析的相关技术理论，最后描述可穿戴心电软件系统的整 体设计。 第三章：可穿戴心电检测软件系统的详细设计。将软件系统分为五个功能模块， 分别对每个功能模块进行详细设计，包括实现方法的选择、实现的具体步骤和在 软件系统中的呈现形式。 第四章：可穿戴心电检测软件系统的实现。首先介绍软件系统的开发环境，然 后分别描述每个功能模块的具体开发实现过程。 第五章：系统测试与分析。首先对软件系统的每个功能模块进行功能验证，接 着对软件系统作性能分析。 第六章：总结与展望。对本文工作进行总结与展望。
4

第二章 总体设计与相关技术理论
第二章 总体设计与相关技术理论
本章首先概述可穿戴心电信号采集系统，然后介绍心电信号处理与分析的相关 技术理论，主要包括：心电信号预处理、心电信号特征提取和心电信号分析，最 后进行可穿戴心电检测软件系统的总体设计，按功能对软件系统进行模块划分， 并简单描述各功能模块的设计要求。
2.1 可穿戴心电信号采集系统概述
本文是通过可穿戴式胸带来完成心电信号的采集，可穿戴式胸带主要由织物电 极、心电采集模块和普通胸带三部分组成。可穿戴式胸带的结构如下：将两个织 物电极对称的编织在一条普通的胸带上，通过导电布将织物电极与胸带上的一对 暗扣连接，把心电采集模块封装在一个长方体的小盒子中，引出其电源开关和充 电接口，将其正负极通过一对暗扣引出，然后将装有心电采集模块的小盒子扣在 胸带的暗扣上，从而实现织物电极与心电采集模块的连接。
在采集心电信号时，可穿戴式胸带应穿在人体胸部位置，织物电极位于人体乳 头下方 2~3cm，松紧要合适，如图 2-1 所示。首先打开心电采集模块的电源开关， 由织物电极获取人体体表的电位差，该电位差为模拟心电信号，模拟心电信号经 过心电采集模块的放大、A/D 转换和数据封装等一系列处理后，得到一组包含心 电信号信息的数据包，数据包的格式将在下一章详细讲述。然后心电采集模块通 过蓝牙将数据包发送给 PC 端，PC 端在接收数据包时需要解析出数据包中的有效 心电信号信息。
图 2-1 可穿戴式胸带实物图
5

电子科技大学硕士论文
2.2 心电信号处理与分析的相关技术
心电信号的处理主要包括心电信号的预处理和特征提取，心电信号分析是指依 据心电特征参数检测心电信号中的异常片段。
2.2.1 心电信号预处理
心电信号是一种比较微弱的生理信号，一般情况下，心电信号的幅值范围为： 10 uv~5 mv。心电信号属于低频信号，大部分的频谱能量分布在 0.05~40Hz 之间[29]。 原始的 ECG 信号信噪比较低，在信号采集过程中会受到许多的干扰，主要包括： 工频干扰、基线漂移和肌电干扰。
工频干扰是由带电系统产生的一种干扰，它会以电磁波辐射形式的形态作用 于导联和人体之间的环形电路，使纯净的心电信号上出现正弦波以及类似正弦波 的波形，干扰的主要频率为 50Hz，含工频干扰的心电波形如图 2-2 所示。
图 2-2 含工频干扰的心电信号
基线漂移干扰是心电信号中常常出现的情况，在信号采集的时候产生基线漂移 是无法避免的，因为它是由采集者的呼吸或电极移动所致，它的幅度只能够达到 心电信号幅度的 15%左右，一般频率低于 1Hz[30]，含基线漂移的心电信号波形如 图 2-3 所示。
图 2-3 含基线漂移的心电信号
肌电干扰是指由于肌肉纤维的颤抖导致体表的电位发生变化，使得体表的电 极测得的电势差受到影响。肌电干扰的持续时间较短，频谱范围比较广，一般在 5~2000Hz，集中分布在 30~300Hz，频率特性相当于白噪声，含肌电干扰的心电信 号如图 2-4 所示。
6

第二章 总体设计与相关技术理论
图 2-4 含肌电干扰的心电信号
工频干扰的频率为 50Hz，由于频率是固定的，所以去除比较简单，一般用 50Hz 的陷波器来去除工频干扰。基线漂移为低频干扰，与心电信号的频率有部分重叠， 常用的方法有 FIR 或 IIR、中值滤波、小波变换、形态学滤波等。肌电干扰的频率 范围分布比较广，相对于心电信号来说大部分属于高频干扰，一般采用低通滤波 法、小波变换法和经验模态分解法等进行滤除[31]。
2.2.2 心电信号特征提取
典型的心电信号波形如图 2-5 所示。心电信号的一个心动周期主要由 P 波， QRS 波群和 T 波构成。不同的波段对应着心脏不同的活动状况，P 波代表心房肌 除极时的电位变化，QRS 波群代表心室肌除极时的电位变化，T 波反映的是心室 后期复极化过程中的电位变化[32]。
图 2-5 典型心电信号波形图
心电信号的特征提取是指利用心电信号的波形特征和一定的数学方法找到 P、 QRS、T 波的起始点、终点和峰值点等基准点，然后根据这些基准点的位置计算出 诸如时间间隔、幅值、斜率等心电特征参数，并将这些特征参数构成一个特征集，
7

电子科技大学硕士论文

以便根据特征集对心电信号进行分类。一般要求选取的特征在不同的心电信号之 间有较大的差异性，并通过时域和频域特征的差异性对心电信号进行分类。常用 于心电分类的特征如表 2-1 所示[33]。

表 2-1 常用的心电信号特征

心电信号特征

特征定义

RR 间期

连续两个 R 波波峰的时间间隔

PR 间期

P 波起点到 Q 波起点的时间间隔

QT 间期

Q 波起点到 T 波终点的时间间隔

P 波幅值

P 波波峰处的幅值

R 波幅值

R 波波峰处的幅值

T 波幅值

T 波波峰处的幅值

P 波持续时间

P 波起始点到终点的时间间隔

QRS 波宽度

Q 波起始点到 S 波终点的时间间隔

T 波持续时间

T 波起始点到终点的时间间隔

ST 段斜率

S 波终点与 T 波起点之间连线的斜率

心电信号特征提取的关键在于基准点的准确检测。其中 R 波的特征最为显著， 因此一般都是先找到 R 波的波峰，然后以 R 波波峰为基准，分别向左右两侧延伸 搜索其他基准点。目前已经提出了很多种心电信号特征提取的方法[34]，如：差分 阈值法、模板匹配法、小波分析法、神经网络法、形态学方法等。差分阈值法算 法简洁，处理速度快，非常适合实时检测；模板匹配法原理简单，但对高频噪声 和基线漂移很敏感；小波变换法具有良好的时频局域化特性，检测准确性高，但 是计算量偏大；神经网络法能够实现很好的判别效果，但是训练时间较长。

2.2.3 心电信号分析
心电信号分析是指利用心电信号波形形态上的差异，对心电信号进行分类， 从而检测出异常的心电信号，完成心脏疾病的诊断。QRS 波群是心电信号中最显 著的一段波形，包含了丰富的病理信息。心脏病患者的 QRS 波群形状与常人相比 通常有较大差异，因此 QRS 波群的形态通常用来作为心电信号分析的重要依据。 同时，P 波和 T 波也是判断部分心脏疾病的重要指标。

8

第二章 总体设计与相关技术理论
QRS 波群的形态主要由 Q、R、S 波幅值，QRS 波群宽度等特征参数决定，而 P、T 波的形态主要由 P、T 波幅值及其各自的持续时间等特征参数决定，因此， 可以依据上述心电信号特征参数对心电信号进行分类。目前，常用于心电信号分 类的方法有：逻辑分支判断法、基于统计学的方法、基于神经网络的方法和支持 向量机等。
逻辑分支判断法主要是结合医生的诊断经验确定不同心脏疾病的判定规则集， 然后依据判定规则合集计算出相应的特征参数，并判断心电信号是否满足合集中 的所有规则。基于统计学的方法是通过对心电信号数据分析并建立合适的模型来 完成心电信号的分类，模型的好坏不仅决定着运算的复杂度还影响着分类的准确 性。基于神经网络的方法主要是利用神经网络自学习的特性对心电信号进行分类， 其输入可以是心电数据本身，也可以是心电特征参数。基于神经网络的方法前期 的训练比较耗时，运算较为复杂，但分类效果还不错。支持向量机是先通过一定 数量的训练样本集找到不同种类样本之间的分界超平面，然后依据测试集数据的 分布情况对其进行分类。支持向量机最关键的是核函数的选取，同时还要注意特 征集的合理选取及适当的训练集样本。
由于逻辑分支判断算法与日常医生进行诊断的流程一致，方法简便，运算量小， 用时较少。因此，本文选用逻辑分支判断法进行心电信号分析。心脏疾病的种类 数不胜数，情况较为复杂，本文主要是依据心率、R 波幅值、RR 间期、S-T 段方 向等心电信号特征参数有针对性的进行室性心动过速、室性心动过缓、房性室性 早搏、二联律三联律等几种常见类型的判断。
2.3 软件系统需求分析与总体设计
结合心电信号处理与分析的相关技术和实际情况对软件系统作需求分析，阐述 软件系统的所有功能，并对软件系统进行总体设计。
2.3.1 需求分析
心脏病具有发作迅速，发作时间不确定等特点，因此需要长期动态的监测人 体心电信号。目前，医院多采用 Holter 来动态的监测人体心电信号，但 Holter 动 态仪体积大、比较重、携带不方便，不适合日常活动下的心电监测。本文利用可 穿戴技术将织物电极和心电采集模块嵌入到一条胸带上来完成日常活动下的心电 监测。织物电极与普通衣物材质相同，在日常生活中长期穿戴也不会引起不适， 且使用的心电采集模块体积小、重量轻、功耗低，因此可穿戴式心电检测胸带比 较适合用于长期动态的监测人体心电信号。织物电极与人体皮肤之间的接触不如
9

电子科技大学硕士论文
湿电极与皮肤接触紧密，在日常活动下织物电极容易与皮肤产生相对滑动，同时 还会受到垂直方向上的压力，因此采集的心电信号中会掺杂更多的噪声。不同的 织物电极采集的心电信号差异也比较大，因此需要针对可穿戴心电检测胸带设计 一个软件系统，用于处理和分析心电信号数据，实时地检测出异常的心电信号。 Python 是目前比较流行的语言，其所有内容均是免费开源的，而且 Python 中包含 有丰富的第三方库，非常适合用于信号处理与分析。Python 中还包含有多种图形 用户界面开发工具，使用方便，设计出的界面比较美观。因此，本文选用 Python 来开发可穿戴心电检测软件系统。
可穿戴心电检测软件系统的目标是实时地检测异常的心电信号，主要功能包括： 心电信号采集、心电信号存储、心电信号预处理、心电信号特征提取、心电信号 分析、心电信号可视化和用户交互。
1. 心电信号采集功能。心电胸带采集到信号后，需要将数据通过蓝牙等无线 传输方式发送到 PC 端。因此，本系统的心电信号采集模块需要集成蓝牙设备发现、 配对、数据传输等相关功能，此外，PC 端接收到的心电数据为按照一定格式封装 好的数据包，需要根据该格式设计相应的数据解析程序，提取出有效的心电信号 数据。
2. 心电信号数据存储功能。该部分主要实现离线数据存储功能，为后续的心 电信号处理和分析等部分提供数据支持。为简化系统设计，本文采用将数据写入 TXT 文本文件的方式实现存储功能。
3. 心电信号预处理功能。实际应用中，心电信号采集过程会受到多种形式的 干扰，主要包括：工频干扰、基线漂移和肌电干扰等。需要在进行特征提取前去 除掉这些干扰，否则会增加特征提取的难度并影响其准确性，从而影响到最终的 分析结果。本文分别采用不同的方法来针对性的去除以上三种干扰，然后在用户 界面的相应区域之中实时的绘制出预处理后的心电信号波形。由于是实时的对心 电信号进行预处理，需要每次对一段固定长度的心电信号进行预处理，并保持与 原始心电信号一致的速率来刷新心电波形。
4. 心电信号特征提取功能。心电信号是一个准周期信号，主要由 P 波、QRS 波群和 T 波组成。特征提取是指利用心电信号各特征波的形态特征和一定的数学 方法找到各特征波的起始点、终点和波峰等基准点，然后通过这些基准点的位置 和幅值信息，可以计算得到许多具有代表意义的心电信号特征参数。本文针对心 电信号处理和分析任务中所需的心电特征参数，包括心率、RR 间期、QRS 波宽度、 R 波幅值等开展心电信号特征提取工作。和心电信号预处理模块相似，该部分也需 要每次对一段固定长度的心电信号进行特征提取，并且在系统界面的文本框显示
10

第二章 总体设计与相关技术理论
心电特征参数，每隔一个周期对其进行一次更新。 5. 心电信号分析功能。心电信号分析是指依据特征提取阶段得到的特征参数
和医学上的判别规则，对心电信号进行异常判断，当检测到异常心电信号时，会 立刻在系统界面上弹出警报窗口。心脏疾病的种类比较繁多，情况比较复杂，本 文主要是针对几种比较常见的心律失常的检测，如：心动过速、心动过缓、房性 室性早搏等。其中，异常心电信号片段的检测是对心电信号逐个心拍进行分析判 断实现的。
6. 心电信号可视化功能。心电信号可视化是指实时绘制原始心电信号数据和 预处理后的心电信号数据的波形，并显示在软件系统界面的对应坐标区域。心电 采集模块的采样率为 512Hz，设置坐标区域内可绘制心电波形的最大采样点个数， 当心电波形充满整个坐标区域时，每隔一个固定周期刷新一次整个坐标区域的波 形。由于每个个体的心电信号幅值大小不等，为避免幅值较大的心电信号波形超 出坐标系范围，可以将坐标轴的 y 轴设计成刻度是可调节的，根据心电信号幅值 大小调节 y 轴刻度。心电信号是一个准周期信号，且各个波段的波形都有各自的 特点，心电信号的可视化可以直观的看出织物电极采集的心电信号质量以及心电 信号预处理的效果。
7. 用户交互功能。用户交互是指用户通过向软件系统输入信息或指令，软件 系统接收到用户的信息或指令后会作出相应的响应。在软件系统的多个模块中均 存在着用户交互，心电采集模块中需使用下拉菜单配置 COM 口和波特率，心电存 储模块中需要通过按钮来控制数据存储的起始和结束时刻。心电预处理模块中使 用单选框来选择要去除的噪声，心电特征提取模块中需要在文本框中显示特征参 数，在心电信号分析模块中可以通过单击按钮进入一个配置诊断信息的界面，配 置完后会保存诊断信息和加载诊断规则，如果检测到异常心电信号片段会弹出一 个提示窗口。
2.3.2 相关技术指标
(1) 心电采集与存储相关指标 心电信号数据的采样率不低于 200Hz，在传输过程中 PC 端的 COM 口是随机 分配的，波特率为 57600，在解析心电数据包时，计算心电信号幅值时至少保留小 数点后两位小数，单位为 mv。保存心电信号数据时，文件以当前时刻命名，保存 在计算机中指定的位置，文件属性设置为只读，每一行仅保存一个心电数据。假 设保存的心电数据不超过 24 小时，计算得到文件大小不超过 200M。 (2) 信噪比 SNR 和均方误差 MSE
11

电子科技大学硕士论文

经过预处理后，心电信号变得更为干净，通常将信噪比 SNR 和均方误差 MSE 作为评价心电信号预处理效果的指标[35]，信噪比是指信号自身的能量与噪声的能 量之间的比值，单位为 dB，其计算公式如式(2-1)所示。

N
SN R  10 log( x 2 (i)
i 1

N
 ( x(i) - x(i))2 )
i 1

(2-1)

均方误差表示去噪后的心电信号与原始心电信号之间的差异性，同时也反映了 心电信号的失真情况，其计算公式如式(2-2)所示。

1N

2

MSE   x i - x i

N i1

(2-2)

其中 N 为心电信号采样点的个数，x(i)为原始心电信号，x̃(i)为去噪后的心电 信号。SNR 的值越大，表示去噪后的心电信号越干净，去噪效果越好。MSE 的值 越小，表示心电信号失真越小，去噪效果越好。
(3) 心率敏感性 SEN 和心率变异性 VAR 在心电信号的特征提取过程中，R 波的准确定位至关重要。R 波的检测情况可 分为以下四种： TP：正确的检测到 R 波。 FP：将其他波误检成到了 R 波。 FN：漏检了 R 波。 TN：正确的检测到一段信号里没有 R 波 通常用心率敏感性和心率变异性两个指标[36]作为 R 波检测算法优劣的评判标 准。心率敏感性 SEN 和心率变异性 VAR 越大，意味着 R 波检测算法越好，对 R 波的定位越准确。心率敏感性的定义如式(2-3)所示。

SEN  TP / TP  FN 100%

(2-3)

心率特异性的定义如式(2-4)所示。

VAR  TN / TN  FP 100%

(2-4)

(4) 分类准确率 CA 在作心电信号分析的时候，需要对心电信号进行分类，在分类的过程中，难 免会出现分类错误的情况，一般将分类准确率作为心电信号分类方法优劣的评判 准则。分类准确率 CA 的定义如式(2-5)所示。

CA = 分 类 正 确 的 测 试 心 电 个 数 /测 试 心 电 总 个 数 100%
(5) 可视化与用户交互相关指标

(2-5)

12

第二章 总体设计与相关技术理论
软件系统的用户主界面主要分为心电波形显示区和用户交互区，心电波形显示 区不小于 4 0 0  2 0 0 p p i ，用户交互区不小于 4 0 0  1 0 0 p p i 。在实时绘制心电波形时， 要单独创建一个线程接收原始心电数据，在此线程中开辟的缓冲区内存不小于 200M，在主线程中也需要一块缓冲区来保存预处理后的心电数据，此缓冲区内存 也不小于 200M。在绘制心电波形时，当波形充满画布后，波形要整体向左移动， 每隔一段时间刷新一次画布，刷新时间不大于 50ms。在用户交互区需实时显示心 电特征参数，其更新时间不大于 3s。
2.4 本章小结
本章首先介绍了可穿戴心电信号采集系统，包括采集到的心电信号的数据格 式。然后介绍了心电信号处理与分析的相关技术，主要包括：心电信号的预处理、 心电信号的特征提取和心电信号分析。最后对可穿戴心电检测系统进行需求分析， 同时提出了若干个评判可穿戴心电检测系统的相关技术指标。
13

电子科技大学硕士论文

第三章 可穿戴心电检测软件系统的设计

本章主要是对可穿戴心电检测软件系统各功能模块进行详细设计，包括：各功 能模块使用的方法、实现的流程以及最终呈现的形式。软件系统由以下功能模块 组成：心电信号采集与存储模块、心电信号预处理模块、心电信号分析模块和可 视化与用户交互模块，其工作示意图如图 3-1 所示。

可穿戴式心电检测胸带

蓝牙传输

软件系统

心 电 采
集

预 处 理

…

用 户 交
互

用户 图 3-1 软件系统工作示意图

3.1 心电信号采集与存储模块的详细设计
可穿戴式胸带采集到心电信号后，心电采集模块将数据通过蓝牙传输到 PC 端。 心电信号数据传输的流程如图 3-2 所示。
开始

打开蓝牙

打开串口

蓝牙配对连接
设置COM口和 波特率

数据传输成功 结束

图 3-2 心电信号数据传输流程图
首先，完成心电采集模块和 PC 端双方蓝牙的配对连接，连接成功后在 PC 端 为蓝牙分配一个 COM 口。设计一个下拉菜单用于选择正确的 COM 口，将波特率
14

第三章 可穿戴心电检测软件系统的设计

设置为 57600，然后在 PC 端打开对应的 COM 口，PC 端就能接收到从心电采集模 块发送过来的数据包。

通过可穿戴式胸带采集得到的心电数据是将原始心电信号数据按一定的格式

进行封装得到，它是由一个个的数据包组成的，每一个数据包对应着一个心电信

号的采样点，数据包的格式如图 3-3 所示。

Header

Data Payload CRC

SYNC

SYNC pLength

payload[]

chksum

图 3-3 心电信号数据包格式

每个数据包由三部分构成：Header、Data Payload 和 CRC。Header 包含 3 个字 节的内容，前两个字节为同步字节，其值为 0XAA，代表着一个数据包的起始位， 第三个字节其值为 0~255，表示 Data Payload 长度的字节数。Data Payload 中包含 了心电信号的幅值信息。CRC 是校验和，是用来检验数据包是否是有效的。如果 数据包是有效的，则继续对 Data Payload 部分进行解析，否则直接丢弃掉该数据包。 Data Payload 是由一系列的 DataRow 组成的。DataRow 的数据格式如图 3-4 所示。

EXCODE CODE vLength

value[]

图 3-4 DataRow 的数据格式

从图 3-4 中可以看到，每一个 DataRow 由四部分组成，EXCODE 和 CODE 的 值共同决定 value 代表的含义，不一定每个 DataRow 中都包含有 EXCODE。vLength 的值为 value 长度的字节数，value 中包含了真正的心电信号信息。不同的 CODE 值所对应的 value 含义的定义如表 3-1 所示。

EXCODE 0 0 0 0 0 0

表 3-1 不同的 CODE 值所对应的 value 含义的定义

CODE 0X02 0X03 0X08 0X80 0X84 0X85

vLength N/A N/A N/A 2 3 5

Value Meaning Signal Quality(0-sensor off,200-sensor on)
Real-time Heart Rate(Beats Per Minute) Don’t care
16-bit Raw Data(2’s Complement) Don’t care Don’t care

15

电子科技大学硕士论文

PC 端接收到心电采集模块发送的心电信号数据包后，要根据数据包的封装格 式从中解析出有效的心电信号数据，作为心电信号的幅值。解析心电信号数据包 的流程如图 3-5 所示。

开始
逐字节读取串 口数据
当前字节内 容为0xAA
Y 下一字节内 容为0xAA
Y 读取pLength字
节的内容L
读取后续L个字 节的数据

累加计算L个字节的数 据和checksum
checksum和0xFF作与运 算和取反运算
N

N

checksum和CRC

字节内容相等

N

Y

依据表3-1计算出有效 心电信号数据

结束

图 3-5 心电信号数据包解析流程图
心电信号数据的解析过程如下： 1. 逐个字节的读取从心电采集模块发送过来的数据，直至第一次遇到内容为
0XAA 的字节； 2. 如果下一个字节的内容仍为 0XAA，读取 pLength 字节的内容 L，否则返回
到步骤 1； 3. 接着读取 L 个字节的数据，将其每个字节的数据累加得到校验和，记为
checksum； 4. 将 checksum 和 0XFF 作与运算，然后对得到的结果取反后再和 0XFF 作与
运算； 5. 读取 CRC 字节的内容，并与步骤 4 得到的结果进行比较，若不相等，返回
到步骤 1； 6. 参考表 3-1 解析 Data Payload 部分的内容，得到心电信号各采样点的幅值； 心电信号存储模块是用来保存一段时间的心电信号数据，在就诊时提供给医生
16

第三章 可穿戴心电检测软件系统的设计
参考。通过鼠标点击按钮来控制保存心电信号数据的起始和结束时刻，鼠标第一 次点击按钮时开始保存数据，再次点击时结束保存数据。保存心电信号数据的流 程如图 3-6 所示。

开始
打开新建txt文 件
向txt文件中写入心 电信号数据

关闭txt文件
数据保存 完成
结束

图 3-6 保存心电信号数据流程
由图 3-6 可知，保存心电信号数据的步骤如下： 1. 开始保存数据时，用鼠标单击“保存数据”按钮，此事件会触发一个函数， 函数功能为打开一个新建的 txt 文件，并向 txt 文件中写入解析后的心电信号数据。 2. 结束保存心电信号数据时，再次单击按钮，此时会调用另一个函数，函数 功能为停止向 txt 文件中写入心电信号数据并关闭该文件，心电信号数据保存完成。
3.2 心电信号预处理方法的对比分析
利用可穿戴心电采集系统采集心电信号数据，分别使用不同的预处理方法处理 获取到的心电信号数据，通过计算信噪比和均方差来评判心电信号的去噪效果， 选择其中去噪效果较好的方法用于设计可穿戴心电检测软件系统预处理模块。在 采集心电信号数据时，实验者可以自由活动，无需按要求做指定的动作，每个测 试者采集 10min 的心电信号数据。
3.2.1 去基线漂移方法的对比分析
从采集的心电信号数据中挑选一段包含明显基线漂移的心电信号，分别采用形 态学滤波和小波变换法处理挑选出的心电信号，通过观察去噪后的心电波形及计 算信噪比和均方差来比较上述两种方法的去基线漂移效果。选取的包含基线漂移 的心电信号波形如图 3-7 所示，采用形态学滤波和小波变换法去基线漂移后的心电 波形分别如图 3-8 和 3-9 所示。

17

电子科技大学硕士论文
图 3-7 含基线漂移的心电信号
图 3-8 形态学滤波去基线漂移后的心电信号
图 3-9 小波变换法去基线漂移后的心电信号
图 3-7 为挑选出的包含基线漂移的原始心电信号波形，其数据长度为 10000 个 采样点，从图中可以看到，心电信号的基线随着时间的增长会缓慢发生变化，波 形上下起伏。图 3-8 为用形态学滤波去基线漂移后的心电信号波形，心电波形非常 整齐，被拉平在了零值水平线上，但是某些部位的波形存在些许变形。图 3-9 为采 用小波变换法去基线漂移后的心电信号波形，波形整齐的排列在零值水平线上， 并且很好的保留了原始心电信号的形态。
分别计算使用两种不同方法去基线漂移的信噪比和均方差，其结果如表 3-2 所 示。从表中可以看到，小波变换法对应的信噪比要高于形态学滤波，均方差略低 于形态学滤波，小波变换法整体去噪效果优于形态学滤波，因此本文选用小波变 换法来去除基线漂移。
18

第三章 可穿戴心电检测软件系统的设计

表 3-2 两种不同方法去基线漂移后的信噪比(SNR)和均方差(MSE)

去基线漂移方法 形态学滤波 小波变换

SNR(dB) 28.72 30.26

MSE 0.00462 0.00385

3.2.2 去肌电干扰方法的对比分析
从采集的心电信号数据中选取一段包含肌电干扰的心电信号，分别采用小波变 换法和 EMD 与 PCA 结合的方法来处理挑选出的心电信号，通过比较两种去噪方 法的心电波形以及对应的信噪比和均方差来判断去肌电干扰的效果。选取的包含 肌电干扰的心电信号波形如图 3-10 所示，采用小波变换法和 EMD 与 PCA 结合的 方法去肌电干扰后的心电波形分别如图 3-11 和 3-12 所示。

图 3-10 包含肌电干扰的心电信号

图 3-11 小波变换法去肌电干扰后的心电信号
图 3-12 EMD 与 PCA 结合的方法去肌电干扰的心电信号
19

电子科技大学硕士论文

图 3-10 是包含肌电干扰的心电信号波形，数据长度为 6000 个采样点，从图中 可以看到，原始心电信号中包含明显的高频噪声，在波形中存在着许多的毛刺。 图 3-11 是利用小波变换法去肌电干扰后的心电波形，从图中可以看出，原始心电 信号中的大部分毛刺已去除干净，波形形态保留得比较好。图 3-12 是利用 EMD 与 PCA 相结合的方法去除肌电干扰后的心电信号波形，从图中可以看出，原始心 电信号中的毛刺去除得更为彻底，波形更为光滑，波形形态也未发生变形。
分别计算使用两种不同方法去肌电干扰的信噪比和均方差，其结果如表 3-3 所 示。从表中可以看到，EMD 与 PCA 结合的方法对应的信噪比要高于小波变换法， 均方差略低于小波变换法，EMD 与 PCA 结合的方法的整体去肌电干扰效果优于小 波变换法，因此本文选用 EMD 与 PCA 结合的方法来去除肌电干扰。

表 3-3 两种不同方法去肌电干扰后的信噪比(SNR)和均方差(MSE)

去肌电干扰方法 小波变换法
EMD 与 PCA 结合

SNR(dB) 34.28 36.52

MSE 0.00346 0.00315

3.3 心电信号预处理模块的详细设计
心电信号预处理模块的主要功能是去除心电信号中掺杂的噪声，并尽可能的 保留有效的心电信号信息。上一章已经介绍过，心电信号中最常见的干扰分别为： 工频干扰、基线漂移和肌电干扰。其中工频干扰的去除较为简单，可以直接用一 个 50Hz 的陷波器进行滤除，而基线漂移和肌电干扰的去除相对比较复杂。因此， 本文着重讲解去基线漂移和肌电干扰算法的设计。
3.3.1 去基线漂移算法的设计
基线漂移是由于采集者呼吸或电极相对皮肤表面滑动引起的，一般频率比较低。 随着国内外学者的不断研究，涌现了许多去除基线漂移的方法，其中基于小波变 换的去基线漂移方法取得了不错的效果，并且还处在不断研究与发展中。小波变 换是在短时傅立叶变换的基础上衍生而来的，短时傅立叶变换的窗口大小是固定 不变的，而小波变换的窗口大小是随着频率的增大而减小。小波变换是进行信号 时频分析和处理的理想工具，可以将问题某些方面的特征凸显出来，通过伸缩平 移运算可以在不同尺度上对信号作分析，从而达到高频处时间细分，低频处频率 细分。
本文选择用小波阈值收缩法来去除基线漂移，其实现流程如图 3-13 所示。
20

第三章 可穿戴心电检测软件系统的设计

开始
确定小波基和分 解层数
对心电信号进行 小波分解
确定小波阈值和 阈值函数

对小波系数作阈 值处理
小波信号重构
去基线后的 心电信号
结束

图 3-13 小波阈值收缩法去基线漂移流程图
1. 小波基的选择 小波基函数的选择十分重要，选用不同的小波基函数对心电信号进行分解,可 以突出心电信号的不同特征，影响最终的去噪效果。sym4 小波对称性好，支撑长 度较小，消失矩高，且与心电信号相似性高，适合用于作为去除基线漂移的小波 基，本文最终确定小波基为 sym4。 2. 小波分解层数的确定 与小波基类似，小波分解层数也是小波阈值收缩去噪法中的一个重要参数， 影响着最终的去噪效果。小波分解层数主要是根据心电信号噪声的频率分布状况 来确定的。QRS 波群的频率主要集中在 3~40Hz，P、T 波的频率范围主要集中在 0.7~10Hz，而基线漂移频率一般低于 1Hz。本文的心电采集系统的采样频率为 512Hz，因此对心电信号进行 9 尺度分解，即小波分解层数选定为 9，可以较好的 去除基线漂移干扰。对心电信号进行 sym4 小波 9 层分解后，各个尺度的频率分布 情况如表 3-4 所示。 3. 阈值的确定和阈值函数的选取 对心电信号进行小波分解后，一般情况下有效信号的小波系数较大，噪声的 小波系数较小，设定阈值的主要目的就是将有效信号的小波系数和噪声的小波系 数区分开，然后用阈值函数对小波系数进行处理，在去除干扰的同时应尽可能的 保留有效心电信号。因此，在小波阈值收缩去噪法中最重要的一个环节就是确定 恰当的阈值和选择合理的阈值函数，它们都直接影响着最终的去噪效果。

21

电子科技大学硕士论文

表 3-4 心电信号在各尺度的频率分布

分解尺度

近似信号频率带宽(Hz)

细节信号频率带宽(Hz)

1

0-128

128-256

2

0-64

64-128

3

0-32

32-64

4

0-16

16-32

5

0-8

8-16

6

0-4

4-8

7

0-2

2-4

8

0-1

1-2

9

0-0.5

0.5-1

选取阈值的方法有很多，目前常用的有：固定阈值估计、极值阈值估计、无

偏似然阈值估计和启发式阈值估计。每种方法都有其各自的特点，极值阈值估计

和无偏似然估计方法在去噪过程中会尽量的保留心电信号成分，可能造成噪声去

除不干净，但是这两种方法在高频噪声分布较少的情况下去噪效果较好。而固定

阈值估计法和启发式阈值估计法噪声去除较为干净，但容易将部分有效的心电信

号误认为噪声而去除掉。固定阈值估计方法简单，处理速度快，去噪效果也不错，

因此本文选用固定阈值估计法来去除基线漂移。

常用的阈值函数有硬阈值法和软阈值法，还有一些方法是这两种方法的基础上

做了部分改进。硬阈值法是将绝对值小于给定阈值的小波系数的值变为零，其余

小波系数的值保持不变，如式(3-1)所示。

  jk

ˆ jk





 0

,   jk
,   jk

(3-1)

软阈值法是对于绝对值小于给定阈值的小波系数，将其值设置为零，否则将小 波系数的模值减去阈值，如式(3-2)所示。

    


s

g

n

 jk

 jk



ˆ jk







0

,  jk   ,  
jk

(3-2)

选用硬阈值法进行去噪，可以较好的保留心电信号的局部特征，但是处理过后 的小波系数连续性较差，软阈值法得到的小波系数连续性较好，重构后得到的信 号容易丢失边缘信息，造成边缘模糊。本文提出了一种改进的阈值函数，将软硬

22

第三章 可穿戴心电检测软件系统的设计

阈值法相结合，完善了两种方法的不足。选用的阈值函数如式(3-3)所示。

  


s

g

n

 jk



2 jk



2

ˆ jk







0

,  jk   ,  
jk

(3-3)

4. 小波分解和小波信号重构

小波分解实质上是对心电信号数据作离散小波变换运算，其中选用的小波为

sym4，小波分解得到的结果为心电信号在各尺度上的近似系数和细节系数。小波

信号重构就是对经过阈值函数处理的心电信号各尺度的近似系数和细节系数作逆

离散小波变换，同样选用的小波还是 sym4，最终得到去基线漂移后的心电信号。

因此，用小波阈值收缩法去基线漂移的基本步骤为：

(1) 选用 sym4 作为小波基，分解层数确定为 9，对心电信号数据作小波分解。

(2) 用固定阈值估计法确定阈值，将一种改进的阈值函数作用于分解后各个尺

度的小波系数。

(3) 用处理后的小波系数进行信号重构，得到去基线漂移后的心电信号。

将去除基线漂移的算法封装成一个函数，函数的形参为原始心电信号数据。

设计一个复选框来控制确定是否去除基线漂移，用一个监听函数监听复选框的勾

选情况，若勾中复选框，则调用去基线漂移的函数。

3.3.2 去肌电干扰算法的设计

肌电干扰主要是由人体肌肉的颤抖引起的，持续时间较短，频谱范围分布比

较广，一般在 5~2000Hz，集中分布在 30~300Hz，频率特性相当于白噪声。肌电干

扰与心电信号的频率存在部分重合，给肌电干扰的去除带来了很大的困难，近些

年来提出了多种去除肌电干扰的方法，如：基于傅里叶变换的滤波器，基于小波

变换的阈值去噪法和经验模态分解法等。本文将选择使用一种结合经验模态分解

(Empirical Mode Decomposition)与主成分分析(Principal Component Analysis)的算

法来去除肌电干扰。

结合 EMD 与 PCA 算法去除肌电干扰的基本流程如图 3-14 所示。首先对心电

信号数据作 EMD 分解，得到一系列的内在模态函数(Intrinsic Mode Function)分量

i 1



t



,

i 2



t



,…,

i m



t



和剩余项

r m



t



。对分解得到的

IMF

分量，使用

PCA

技术进行

降维，选取其中 L 个主分量用于重构心电信号，去除掉混杂在信号中的噪声。最

后将选取的 L 个主分量和剩余项 rm (t ) 相加,重构得到去肌电干扰的心电信号 x (t) 。

23

电子科技大学硕士论文
开始
EMD分解
PCA技术处理 IMF分量
重构心电信号
结束
图 3-14 结合 EMD 与 PCA 去肌电干扰流程图
EMD 算法是依据信号自身的时间尺度特性将信号分解成一组 IMF 分量与一个 剩余值的和。EMD 分解得到的 IMF 分量要满足如下两个条件：
(1) 零点数与极点数之差不超过 1； (2) 数据均匀的分布在 x 轴的两侧，其平均值为零。 EMD 算法首先是将心电信号分解为一个 IMF 分量和一个剩余值，其中 IMF 分量为高频成分，剩余值为低频成分，接着继续对剩余值进行分解，得到一个新 的 IMF 分量和剩余值，如此反复，直到剩余值变成单调、单一而稳定的信号。EMD 分解的基本流程如图 3-15 所示。

开始
求信号的局部极大 值和极小值
用三次样条差值求 得上下包络线
计算上下包络线的 均值

信号与均 N 值之差满足IMF判定
条件 Y
N 剩余值为单调函数
Y EMD分解
完成
结束

图 3-15 EMD 分解算法流程图

24

第三章 可穿戴心电检测软件系统的设计

由图 3-15 可知，心电信号 EMD 分解的基本流程为：

(1) 计算心电信号 x  t  的局部极大值和极小值，利用三次样条插值法构造出

x

t



的上下包络线

x m

t



和

x l



t



。

(2) 求取上下两条包络线的均值： m1  t  =  xm  t  + xl  t   / 2 ，并计算 x  t  与

m

1



t



的差值：

c 1



t



=

x t - m1

t 。

(3) 将 c1  t  看作一个新的信号替换 x  t  ，重复步骤(1)和步骤(2)直到计算得到

的差值满足 IMF 分量的两个条件为止，求得的第一个 IMF 分量记为 i1  t  ，剩余值

为：

r 1



t





x



t





i
1



t



。

(4) 用 r1  t  替换 x  t  ,重复步骤(1)(2)(3),得到一系列的 IMF 分量，直到第 n 次

迭代后得到的剩余值

r n



t



为单调函数，整个迭代过程结束，心电信号

x



t



的

EMD

分解完成。

对心电信号作 EMD 分解后，利用 PCA 技术对 IMF 分量进行降维，从中选取

心电信号的主要成分。PCA 的基本原理就是将一个高维向量 x，通过一个特殊的

特征向量矩阵 U 对 x 进行转换，将其投影到一个低维的向量空间中，得到一个低

维向量 y，并且仅仅损失了一些次要信息。PCA 技术只保留心电信号的主要成分，

用其线性组合来表示信号，通过降维不仅简化了数据，还去掉了引入到信号中的

噪声，得到了较为干净的心电信号。PCA 提取主成分分量的基本步骤如图 3-16 所

示。

开始
构建原始矩阵X
计算协方差 矩阵V
计算矩阵V的特征 值和特征向量

取较大的L个特征值对应 的特征向量构成矩阵W
将矩阵X与矩阵W相乘得 到新的矩阵Y
结束

图 3-16 PCA 提取主成分分量流程图

(1)

构建原始矩阵。设某一阶的 IMF 为一个 n 维向量 x i





x, i1

x i2

, ...,

x iN



，其中

N 为采样点的个数，i=1,2,…,M，M 为 IMF 的阶数，所有的 IMF 分量可以构成一

个 N  M 的原始矩阵。

25

电子科技大学硕士论文

x N M



x 11

 

 

x 1N

x M1







x MN

 

(2) 计算矩阵 x N  M 中每一列的均值，记为： x1 , x 2 , ..., x M ，将矩阵 x N  M 中的每个 元素减去其所在列的均值，得到一个新的矩阵 x N  M 。

xN M



x 11



x 1

 

 

x 1N



x 1

x x

M1

M







x MN



x M

 

求矩阵 x N  M

协方差矩阵V M M

。

VM M



xT N M



xN M

(3) 计算矩阵V M  M 的 M 个特征值，并将其按从大到小的顺序进行排列，记为：

 ,  ,..., 

12

M

 1



 2





 M

 ，对应的

M

个特征向量，记为：

p, 1

p ,..., 2

p M

。

(4) 取前 L(L<M)个主成分来重构原始信号，其余的成分主要是由噪声构成的，

应当直接舍弃，由满足要求的前 L 分量组成的矩阵为W 。 M L



p 11



W M L





 

pM 1

p 1L







pML

 

(5)

将原始矩阵 x N  M

与矩阵W 相乘，得到新的矩阵 y 。

M L

N L

yNL  xN M  W M L

矩阵 y 的 L 列数据是原矩阵 x 经过 PCA 技术提取的 L 个主成分，每一列

N L

N M

对应着一个新的 IMF 分量。

利用 PCA 技术完成 IMF 分量的主成分分量提取后，就可以进行最后一步的心

电信号的重构，将 IMF 分量经主成分分量提取后得到的 L 个主分量与剩余项 rn  t  相加，即可得到去肌电干扰后的心电信号 x   t  。
与去基线漂移类似，将去肌电干扰的算法封装成一个函数，函数的形参为原

始心电信号数据。设计一个复选框来决定是否去除肌电干扰，用一个监听函数监

听复选框的勾选情况，若勾中复选框，则调用去除肌电干扰的函数。

3.3.3 仿真分析
本文利用 Python 实现前面设计的去除基线漂移和去除肌电干扰的算法，去基 线漂移选用 MIT-BIH 标准心电数据库中 109 号数据中的一段心电信号进行仿真，

26

第三章 可穿戴心电检测软件系统的设计
程序运行在 win7 64 位系统下。MIT-BIH 中 109 号数据去基线漂移前后的波形图如 图 3-17 和图 3-18 所示。
图 3-17 109 号心电信号
图 3-18 小波变换去基线效果图
本文选取的心电数据为 109 号数据中的前 4000 个采样点，信号的采样率为 360Hz，从图 3-17 中可以看出，信号中包含有基线漂移，波形上下起伏且波形整 体向 y 轴负方向偏移。从图 3-18 中可以看到，经过小波变换后，心电信号的各个 心动周期整齐的排列在 x 轴水平线上，信号的波形形态也得到了较好的保留。
去肌电干扰是选用 MIT-BIH 心电数据库 104 号数据中的一段心电信号进行仿 真，依据肌电干扰噪声的特性，通过在原始信号中人为地加入 15db 的高斯噪声来 模拟肌电干扰，然后采用 EMD 与 PCA 结合的算法对加噪的心电信号进行处理。 104 号数据的原始信号和加噪后的信号波形图分别如图 3-19 和 3-20 所示，对加噪 信号作处理后的波形图如图 3-21 所示。
图 3-19 104 号原始心电信号
27

电子科技大学硕士论文

图 3-20 加噪后的 104 号心电信号

图 3-21 EMD 与 PCA 去噪结果

从图中可以清晰的看到，加噪后的心电信号中含有较多的毛刺，经过 EMD 与 PCA 算法处理后，信号中的毛刺基本去除干净，其幅值稍微有所衰减，其特征点 与原始信号一一对应，波形形态与原始信号的形态保持一致。
本文选用信噪比和均方差对上述两种算法的去噪效果作定量分析，利用第二章 给出的公式计算出信噪比和均方差的值，其计算结果如表 3-5 所示。

数据来源 MIT/BIH 109 MIT/BIH 104

表 3-5 两种去噪算法的信噪比和均方差

去噪方法 小波变换 EMD 与 PCA

信噪比(SNR) 35.42 30.27

均方差(MSE) 0.00416 0.00207

3.4 心电信号特征提取模块的详细设计
心电信号是一个准周期信号，每一个心动周期由 P 波、QRS 波和 T 波构成。 不同的波段反映了人体不同心脏部位的不同活动情况，其形态也就千差万别了。 其中 QRS 波群的波形具有幅值高、斜率大等特点，在所有波段中最容易被检测。 同时 QRS 波群中包含着丰富的病理信息，因此对 QRS 波群的准确定位是心电信号 特征提取的首要问题，并且其他波形的检测大多是在 QRS 波群检测的基础上进行 的。目前已经提出了很多关于特征点检测的算法，其中应用最广泛的就是差分阈 值法和小波变换。差分阈值法算法简洁，处理速度快，对噪声较为敏感；小波变
28

第三章 可穿戴心电检测软件系统的设计

换法具有良好的时频局域化特性，对噪声的抗性较好，检测准确性高，但是计算 量较大。

3.4.1 基于差分阈值法的心电波形检测
差分阈值法检测 QRS 波群的基本思想为：QRS 波群是心电信号中特征最明显 的地方,其波形处上升斜率和下降斜率的模值较大，可通过对心电信号序列求一阶 导数来检测 QRS 波群。一般情况下，R 波波峰附近位置就是心电信号斜率变化最 大的地方，因此可以通过心电波形斜率的变化信息来定位 QRS 波群。
差分阈值法根据其阈值是否固定可分为：固定阈值和可变阈值差分阈值法。 不同个体的心电信号差异较大，同一个体不同时刻的心电信号也可能发生较大改 变，因此有时可能难以找到一个合适的固定阈值。并且采用固定阈值差分阈值法 在检测 R 波波峰容易对高耸 P 波和 T 波产生误检，而对于幅值较小的 R 波又容易 造成漏检。综上所述，本文选用可变阈值的差分阈值法来进行心电信号的 QRS 波 群检测，其实现流程如图 3-22 所示。

开始
差分运算
平方运算 计算自适应
阈值 R波峰值点检测

R波峰值点校验
Q、S波峰值点 检测
Q波起点、S波 终点检测
结束

图 3-16 差分阈值法 QRS 波群检测流程图
由图 3-22 可知，差分阈值法检测 QRS 波群的基本实现步骤如下： (1) 差分和平方运算 对心电信号序列 x(n)作差分运算得到一个新的序列 dx(n)，得到了 QRS 波序列 的斜率信息，同时进一步突出了 QRS 波的峰—峰值，接着对差分序列 dx(n)做平方 运算得到序列 dx2(n)，进一步增强了 ECG 信号的高频分量； (2) 自适应阈值的计算
29

电子科技大学硕士论文

首先确定初始阈值，选取前 10s 的心电信号数据，将其分为 5 段，每段心电信 号长度为 2s，找到每段心电信号对应的 dx2(n)序列的最大值，分别记为1, 2,…,5。 初始阈值ℎ0的计算公式如式(3-4)所示。

5

 th  0 .4 y  0 .0 8 y

0

i

i 1

(3-4)

在前 10s 内检测 R 波均使用初始阈值 th0，之后每隔 2s 更新一次阈值，记更新 前的阈值为 thi，下一更新区间的 dx2(n)序列的最大值为σ，则阈值的更新计算公式 如式(3-5)所示。

thi1



0 .4 th i



0 .6

(3-5)

(3) R 波峰值点的检测 将 dx2(n)序列中的值依次与阈值进行比较，直到找到一段连续的序列，使得其 值均大于阈值，R 波的波峰就在这段连续序列中，然后找到对应的连续心电信号序 列，连续心电信号序列中的最大值位置就是 R 波波峰。找到一个 R 波波峰之后， 记录其时刻和幅值，继续向后寻找下一个 R 波波峰。 (4) R 波峰值点校验 为了提高算法检测的精确度，还需要检查 R 波的漏检和误检情况，主要依据 就是当前 RR 间期的大小。如果当前 RR 间期大于 1.6 倍的平均 RR 间期，说明很 有可能漏检了一个 R 波，这时需要先减小设定的阈值，然后在当前 R-R 波峰之间 搜索新的 R 波。如果当前 RR 间期小于 0.4 倍的平均 RR 间期，说明可能误检了一 个 R 波，去掉其中的一个伪 R 波。 (5) Q、S 波峰值检测 从 R 波波峰处开始向左搜寻 Q 波，在向左的一个 0.1s 的窗口内找心电序列的 第一个极值，即为 Q 波波谷，若找不到则无 Q 波；同理从 R 波波峰处开始向右搜 寻 S 波，在向右的一个 0.1s 的窗口内找心电序列的第一个极值，即为 S 波波谷， 若找不到则无 S 波。 (6) Q 波起点及 S 波终点的检测 QRS 波群的宽度是一个很重要的心电信号参数，而要计算出 QRS 波群的宽度 必须先找到 Q 波起点和 S 波终点的位置。Q 波起点的检测是以 Q 波波峰处的位置 为起点向左查找，找到的第一个与基线相交的点就是 Q 波起点。同理，S 波终点 的检测是以 S 波波峰处的位置为起点向右查找，找到的第一个与基线相交的点即 是 S 波终点。 P、T 波的检测是在 QRS 波群检测的基础上进行的，在一个心动周期中，P 波

30

第三章 可穿戴心电检测软件系统的设计

在 R 波的左侧，T 波在 R 波的右侧。在 R 波波峰向左 0.1s 和 0.25s 之间加一个窗， 找到窗内所有的极大值点，其中幅值最大的极值点即为 P 波波峰，记录 P 波波峰 处的时刻和幅值；在 R 波波峰向右 0.1s 和向右 0.3s 之间加一个窗，找到窗内所有 的极大值点，其中幅值最大的极值点即为 T 波波峰，记录好 T 波波峰处的时刻和 幅值。
以 P 波波峰处为起点向左搜索，找到的第一个与基线的交点即为 P 波起点， 向右搜索找到的第一个与基线相交的点即为 P 波终点。同理，以 T 波波峰处为基 准开始向左搜寻，找到的与基线相交的第一个点为 T 波起点，向右搜寻找到的与 基线相交的第一个点即为 T 波终点。

3.4.2 基于小波变换的心电波形检测

心电信号的不同波段对应分布在不同的频率范围内，经小波分解后不同波段 的信息分布在不同尺度的小波系数上，因此对心电波形的检测需要在特定尺度的 小波系数上检测心电信号特定的波段。
设  t  是低通函数且具有平滑性， y  t  是信号 f  t  经  t  作平滑处理后的信 号， z 1  t  为 y  t  的一阶导数，由拉普拉斯变换可知， z 1  t  直接由 d  t  / dt 对 f  t  作处理得到；同理 f  t  的二阶导数 z 2  t  可以通过 d 2  t  / d t 对 f  t  作处理 得到。整个等效过程如图 3-23 所示。

f(t)

y(t)

z(1)(t) f(t)

z(1)(t)

 (t)

d/dt

dθ(t)/dt

f(t)

y(t)

z(2)(t) f(t)

z(2)(t)

 (t)

d2 /dt2

d 2θ(t)/dt 2

图 3-23 导数等效过程

假定  t  为一个平滑函数，令 1  t   d   t  / d t ，   2  t   d 2  t  / d t 2 ，由小 波函数的容许准则可知， 1  t  和 2  t  均可做为小波变换中的小波基。如果用 于小波变换的小波基是来自于平滑函数的一阶导数或者二阶导数，那么小波变换 的系数可以反映出信号的极值点和转折点。因此，采用平滑函数的一阶导数或二 阶导数作为小波基对心电信号作小波分解，对信号瞬变点的检测就可以转换为对 小波系数中的极值点或过零点的检测来实现。采用小波变换法进行波形检测的基 本流程如图 3-24 所示。

31

电子科技大学硕士论文

开始
选择小波基和 分解尺度
作小波分解
在对应尺度系 上找模极值对

设定正负阈值
R波峰值点检测
R波峰值点校验 Q、S波峰值点
检测

Q波起点和S波 终点检测
P、T波峰值点 检测
P、T波起始点 和终点检测
结束

图 3-24 小波变换法波形检测流程图
1. 选择小波基和分解尺度 用小波变换法进行心电信号波形的检测，首要的任务是选取合适的小波函数 和确定分解尺度。由上述小波变换法进行心电波形检测的原理可知，应选取一个 平滑函数  t  的一阶导数或者二阶导数作为小波基，一般平滑函数  t  为高斯函 数或 B 样条函数，本文选用双正交二次 B 样条小波为小波基，具有较强的正则性， 且是平滑函数的一阶导数。由于采集模块的采样率为 512Hz，QRS 波群的频率分 布在 3~40Hz，其信息主要分布在第 4~5 层细节系数上，P、T 波的频率集中分布在 0.7~10Hz，属于低频段，信息主要分布在第 6 层细节系数上，因此分解尺度确定 为 6 层。 2. 进行小波分解 确定了小波基和分解尺度后，对心电信号数据作离散小波变换运算，得到心 电信号各个尺度上的细节系数和近似系数。 3. 在对应尺度上找模极值对 心电信号经双正交二次 B 样条小波 6 层分解后，心电信号中的瞬变点会在 1~6 层的细节系数上生成对应的模极值对和模极值点，通过在不同尺度的细节系数上 寻找模极值对和模极值来完成各波形的检测。根据 R 波的频率分布及对心电信号 不同尺度细节系数的观察，第 5 层细节系数上 R 波的幅值最大，噪声分布较少， 因此选择在 cd5 上检测 R 波。 4. 设定正负阈值 搜寻出 cd5 系数上的所有正负模极值，分别找出最大和最小的 5 个模极值，5 个最大模极值的平均值记为 th1，5 个最小模极值的平均值记为 th2，最终确定正阈 值为 thr1=0.6*th1,负阈值为 thr2=0.6*th2。
32

第三章 可穿戴心电检测软件系统的设计
5. R 波峰值点检测 R 波峰值点检测的基本步骤如下： (1) 剔除掉步骤 3 中检测出的正模极值中小于正阈值 thr1 的极值点和负模极值 中大于负阈值 thr2 的极值点，同时消除掉间隔大于 100ms 的正负模极值对，避免 多余和孤立模极值对的干扰。 (2) 每一对正负模极值之间都有一个过零点，每一个过零点对应着一个 R 波峰 值点，因此找到一对正负模极值之间的过零点就意味着找到了一个 R 波峰值点。 (3) 信号中的极值点与细节系数上的过零点存在着一定的偏移，第 j 层细节系 数上的点存在着 2 j1  1 个采样点的延迟，因此将过零点向右平移 15 个采样点即可 得到正确的 R 波峰值点位置。 6. R 波峰值点校验 在 R 波检测过程中可能存在 R 波漏检和误检的情况，因此需要对检测到的 R 波峰值点进行校验。如果当前 RR 间期大于 1.6 倍的平均 RR 间期，说明很有可能 漏检了一个 R 波，这时需要先减小设定的阈值，然后在当前 R-R 波峰之间搜索新 的 R 波。如果当前 RR 间期小与 0.4 倍的平均 RR 间期，说明可能误检了一个 R 波， 去掉其中的一个伪 R 波。 7. Q、S 波峰值点的检测 Q 波和 S 波为高频低幅波，主要分布在第 2~3 尺度的细节系数上，对 cd2 和 cd3 进行比较，cd3 的幅值要远大于 cd2 的幅值，且 cd2 所覆盖的频率段上仅有少 量的心电信号的存在,因此 Q 波和 S 波的检测确定在 cd3 上。Q 波、S 波和 R 波是 紧密相连的，因此由其生成的模极值对也是相邻的。首先用步骤(5)的方法在第 3 尺度细节系数上找到由 R 波生成的模极值对，然后以 R 波生成的首模极值点为基 准，在向左 80ms 的时间窗口内搜索第一个过零点，以 R 波生成的尾模极值点为起 点，在向右 110ms 的时间窗口内搜索第一个过零点，Q 波和 S 波的波峰与寻找到 的两个过零点一一对应。将过零点向右平移 3 个采样点就能得到 Q、S 波的峰值点 位置。 8. Q 波起点和 S 波终点的检测 Q 波所生成的模极值对的首模极值点是由 Q 波起点生成，S 波所生成的模极值 对的尾模极值点是由 S 波终点生成。但是 Q 波起点和 S 波终点与首尾模极点左右 两侧的过零点一一对应，因此可以通过寻找其左右侧波形的过零点来定位 Q 波起 点和 S 波终点的位置，检测步骤如下： (1) 从步骤 7 中检测到的 Q 波模极值对过零点位置开始向左搜索，在向左 80ms 的窗内找到的第一个模极值点即为 Q 波生成的模极值对的首模极值点，从检测到
33

电子科技大学硕士论文
的 S 波波峰处开始向右搜索，在向右 100ms 的窗口内找到第一个模极值点即为 S 波生成的尾模极值点；
(2) 从上一步搜索到的 Q 波首模极值点向左 60ms 内的窗口内搜索过零点，从 搜索到的 S 波尾模极值点向右 120ms 内的窗口内搜索过零点；
(3) 将上一步找到的两个过零点分别向右平移 3 个采样点，平移后的位置即为 Q 波起点和 S 波终点的位置。
9. P、T 波峰值点的检测 P 波和 T 波的幅值较小，包含的频率也非常低，主要分布在 cd6 上。P 波，T 波检测的基本步骤为： (1) 在第 6 层细节系数上搜索由 R 波生成的模极值对； (2) 从 R 波生成的首模极值点处向左搜索，在向左 1/3RR 间期区域内搜寻模 极值对，检测到的模极值对为 P 波生成，从 R 波生成的尾模极值点位置向右搜索， 在右侧 1/2RR 间期区域内搜寻模极值对，检测到的模极值对为 T 波生成； (3) 在步骤(2)中检测到的两个模极值对之间寻找过零点，这两个过零点是由 P 波和 T 波的波峰所生成； (4) 将步骤(3)中的过零点向右平移 31 个采样点，即可得到 P 波波峰和 T 波波 峰对应的位置； 10. P、T 波起点和终点的检测 同 Q 波起点和 S 波终点的检测类似，P、T 波的首模极值点是由 P、T 波的起 点生成，P、T 波的尾模极值点是由 P、T 波的终点生成。P、T 波的起点和终点的 检测步骤如下： (1) 找到 P 波和 T 波生成的首模极值点，将其向右平移 3 个采样点后得到的即 为 P 波和 T 波的起点位置； (2) 依据检测到的 P、T 波的起点和峰值点位置以及 P、T 波的近似对称性， 可以计算出 P、T 波终点的近似位置，然后在计算得到的位置附近找到幅值与 P、 T 波起点相等的位置即为最终的 P、T 波终点位置；
3.4.3 特征参数的计算
通过前面两节的方法可以检测到 P 波、QRS 波群和 T 波，包括其起点、终点 和峰值点。有了这些瞬变点的时刻和幅值后，就可以计算出许多重要的心电信号 特征参数，如：RR 间期、QT 间期、QRS 波宽度等，这些特征参数是后期进行心 电信号分析的重要依据。因此，心电信号特征参数计算的准确性依赖于心电信号 各瞬变点检测的准确性，同时会直接影响心电信号异常分析的结果。
34

第三章 可穿戴心电检测软件系统的设计
下面介绍部分心电信号特征参数的计算方式：RR 间期的值为当前 R 波波峰时 刻与上一个 R 波波峰时刻的差值，其倒数代表着瞬时心率的大小。平均 RR 间期 的大小定义为连续 10 个 RR 间期的均值，同理其倒数代表着平均心率的大小。QRS 波群的宽度为 S 波终点时刻与 Q 波起点时刻的差值。PR 间期为 Q 波起点时刻与 P 波起点时刻的差值。QT 间期为 T 波终点时刻与 Q 波起点时刻的差值。P 波持续时 间为 P 波终点时刻与 P 波起点时刻之间的差值。T 波持续时间为 T 波终点时刻与 T 波起点时刻之间的差值。ST 段斜率为 S 波终点与 T 波起点之间连线的斜率。
心电特征参数计算完成后，将部分有代表性的特征参数实时显示在可穿戴心电 检测软件系统的界面上。为每个特征参数创建一个文本框来显示其数值，每隔 2s 更新一次特征参数的数值。
3.5 心电信号分析模块的详细设计
心电信号分析模块主要有两种功能，一种是常见的异常心电信号诊断功能，另 一种是用户自定义的心电信号诊断。常见的异常心电信号诊断是指通过实时的检 测人体心电信号判断用户是否出现几种常见的心律失常症状。用户自定义的心电 信号诊断是指除了上述几种常见类型的异常心电信号诊断之外，用户还可以添加 其他类型的异常心电信号诊断，使得心电分析模块的功能更丰富和灵活，具体设 计将在后续部分作详细介绍。
3.5.1 常见异常心电信号诊断的设计
心脏疾病种类繁多，心律失常是其中最为常见的一种疾病。心律失常是由于窦 房结激动异常、激动产生于窦房结之外或激动的传导受阻，导致心脏跳动过快或 者过慢的异常情况。心律失常根据产生的原因不同或表现的症状不同可分为：室 性心动过速、室性心动过缓、房性室性早搏、二联律三联律等。下面分别介绍上 述几种常见类型异常心电信号的表现特征和诊断过程。
1. 室性心动过速 室性心动过速是指发生在希氏束分叉以下的束支、心肌传导纤维、心室肌的快 速性心律失常。室性心动过速表现为：心率大于 100 次每分钟，QRS 波较宽且波 形发生畸变，S-T 段方向与 R 波方向相反，持续时间大于 0.12s。 本文主要根据 R 波幅值、RR 间期、S-T 段方向、瞬时心率等特征参数来判断 心电信号是否为室性心动过速。室性心动过速的判断条件如下：出现连续 3 个以 上的室性过速心拍，且最后一个过速心拍的 RR 间期小于 3 / 4 个正常 RR 间期，下 一个心拍的 RR 间期大于 1.25 倍的正常 RR 间期。室性心动过速的判断流程图如图
35

3-25 所示。

电子科技大学硕士论文

开始 N

N

连续3个以上室

性过速心拍

Y

最后一个过速

N

心拍RR间期小于0.75倍的

正常RR间期

Y

下一RR间期大于 1.25倍正常RR间期
Y 室性心动
过速
结束

图 3-25 室性心动过速判断流程图
心动过速心拍是指满足如下条件的心拍：RR 间期小于 0.5s，R 波幅值与正常 R 波幅值之差大于 0.15mv，正常 RR 间期均值与 RR 间期之差大于 0.12s。过速心拍 的判断流程如图 3-26 所示。

开始

N

当前RR间期

小于0.5s

Y 计算正常RR间
期的均值

当前R波幅值 减去正常R波幅值大于
0.15mv
Y 心动过速
心拍

N
非心动过 速心拍

N

正常RR间期 均值减去当前RR间期

大于0.12s

Y

结束

图 3-26 心动过速心拍判断流程图
首先依据 RR 间期和 R 波幅值，判断当前心拍是否为心动过速心拍，如果当前 心拍为心动过速心拍，下一步判断 S-T 段方向与 R 波方向是否相反，若方向相反 判定此心拍为室性过速心拍。接着依据最后一个室性过速心拍和其后面一个心拍 的 RR 间期来判定是否为室性心动过速。
36

第三章 可穿戴心电检测软件系统的设计

2. 心动过速 心动过速是指平均心率超过 75 次达到 100 次每分钟以上。运动、劳动和情绪 激动等状况下，人体的心率会有所增大。因此，将心动过速的判断条件确定为： 连续 6 个以上心拍的瞬时心率超过 120 次每分钟，且其 S-T 段方向均与 R 波方向 相同。心动过速判断流程图如图 3-27 所示。

开始

N

瞬时心率大于

120

Y

N

R波与ST段

方向相同

Y

异常心拍加1

N

连续异常心拍

个数大于6

Y
心动 过速

结束

图 3-27 心动过速判断流程图
3. 心动过缓 心动过缓是指由于心脏病变引起的心率搏动异常缓慢的现象。若正常成年人 心动过缓，其心率一般低于 60 次/分钟。心动过缓患者心率不是一直很低，而是平 时心率可能一直表现正常，在某一时刻突然下降到每分钟 40 次以下，还有一部分 身体特别健康的人心率也比较低，如运动员等。因此，本文判断心动过缓的条件 为：连续 6 个心拍的瞬时心率低于 50 次每分钟，并且其 S-T 段方向均与 R 波方向 相同。心动过缓判断流程图如图 3-28 所示。 4. 过早搏动 过早搏动是指异位起搏点过早冲动引起的心脏提前搏动，可发生在窦性或异位 性心律的基础上。过早搏动偶尔才会发作一次，一般在一个或数个正常心跳后发 生。过早搏动又分为室性早搏和房性早搏，其中室性早搏的危害较大，可能会诱 发室速室颤等情况，甚至会导致心脏性猝死。

37

电子科技大学硕士论文

开始

N

瞬时心率小于

50

Y

N

R波与ST段

方向相同

Y

异常心拍加1

N

连续异常心拍

个数大于6

Y
心动 过缓

结束

图 3-28 心动过缓判断流程图
本文依据 ECG 信号的 R 波幅值、RR 间期等判断心电信号是否为过早搏动。 然后根据 S-T 段与 R 波方向是否相同，分为室性早搏和房性早搏，其判断流程图 如图 3-29 所示。
开始

一个正常心拍 接一个过速心拍
Y
过速心拍R波 与ST段方向一致
Y 房性 早搏

N
N
室性 早搏

结束
图 3-29 过早搏动判断流程图
5. 室性二联律和三联律 二联律是指一个心脏正常搏动之后紧接着出现一个期前收缩。正常心跳后出现 室性期前收缩称为室性二联律，房性期前收缩称为房性二联律。三联律是指每连 续两个正常心跳之后紧接着呈现出一个期前收缩。由于房性二联律三联律的发生
38

第三章 可穿戴心电检测软件系统的设计
并不是病理引起，因此本文只讨论室性二联律和三联律。 本文依据 ECG 信号的 R 波幅值、RR 间期、S-T 段方向等特征参数来判断心电
信号是否为室性二联律。若在一个正常心拍之后紧接着出现一个室性心动过速心 拍，两种心拍连续成对出现的次数超过 3，判定为发生室性二联律。室性三联律的 判断条件与二联律类似，因此本文以室性二联律为例，室性二联律的判断流程图 如图 3-30 所示。

开始 N

正常心拍和室

N

性过速心拍成对出现超

过3次

Y
最后一个过速 N 心拍RR间期小于0.75倍的
正常RR间期

Y

下一RR间期大于 1.25倍正常RR间期
Y 室性二
联律
开始

图 3-30 室性二联律判断流程图
根据对上述几种典型异常心电信号诊断过程的描述可知，针对某一种异常心电 信号的诊断应包含以下步骤：
(1) 规则的定义、表示、组合和存储； (2) 诊断过程的执行； (3) 诊断结果输出和解释；
3.5.2 用户自定义心电信号诊断的设计
用户自定义心电信号诊断是指用户可以在心电信号分析模块中添加其他异常 心电信号的诊断功能，使得心电信号分析模块的功能更丰富和灵活。由上一小节 内容可知，用户自定义心电信号诊断的基本流程如下：首先需要确定添加的异常 心电信号类型，并自定义其诊断规则。添加完异常心电信号类型和诊断规则定义 信息后，将其内容保存起来。在进行诊断的过程中，需要从文件中读取诊断规则， 然后依次将心电信号特征参数与诊断规则中的内容进行匹配，如果匹配成功，说 明检测到异常心电信号，最后输出并保存诊断结果。用户自定义心电信号诊断的 流程如图 3-31 所示。
39

电子科技大学硕士论文

开始

逐心拍检测心电 信号

配置诊断信息 保存诊断信息 保存诊断信息

检测到异常心电

N

信号片段

Y
输出并保存诊 断结果

结束

图 3-31 用户自定义心电信号诊断流程图
1. 配置诊断信息 诊断信息主要包括异常心电信号类型和诊断规则。异常心电信号类型的名称由 用户输入到一个文本框里。诊断规则是由一个个的判断条件组成，每一个判断条 件包括一个心电信号特征参数和特征参数需满足的条件。通过设计一个下拉菜单 来选择心电信号特征参数，将特征参数需满足的条件转换为数学表达式输入到一 个本文框中。 2. 保存诊断信息 在配置诊断信息的界面里有一个“保存”按钮，点击按钮会将诊断信息保存在 一个 excel 表格中，将异常心电信号类型的名称保存在第一行第一列，从第二行开 始保存诊断规则，每一行保存一个判断条件，第一列保存心电特征参数，第二列 保存需满足的条件。 3. 诊断过程的执行 诊断过程的执行包括读取诊断规则及特征参数与诊断规则的匹配。先从保存的 excel 表格中读取出诊断规则，然后依次将特征参数与诊断规则中的判断条件进行 匹配，直到所有判断条件都匹配完为止。 4. 输出并保存诊断结果 如果步骤 3 中心电特征参数符合诊断规则中所有判断条件的要求，说明检测到 了异常心电信号片段，在可穿戴心电检测软件系统主界面上弹出一个新的窗口显 示诊断结果，并将诊断结果保存在一个 txt 文件中；否则，说明未检测到异常心电 信号片段，无需作任何操作。

40

第三章 可穿戴心电检测软件系统的设计
3.6 可视化与用户交互模块的详细设计
可视化与用户交互模块的主要任务是设计可穿戴心电检测软件系统的用户界 面，用户可以通过界面上的控件向软件系统输入信息或指令，软件系统根据接收 的指令作出相应的响应。软件系统的主界面分为两部分，一部分是心电信号波形 显示区，另一部分是用户交互控制区。
心电信号的可视化主要是实时绘制预处理前后的心电信号波形，心电信号可视 化实现的基本流程如图 3-32 所示。

开始
创建绘图窗口，设 置x和y轴的刻度
新建子线程，开辟 缓冲区
将原始心电数据保 存至缓冲区

对缓冲区内数据作 预处理
在主线程中获取子线 程缓冲区内的数据
绘制预处理前后的 心电波形
结束

图 3-32 绘制心电信号波形的实现流程图
1. 在软件系统主界面的波形显示区域新建两个窗口，分别用来绘制预处理前 和预处理后的心电波形，给定窗口的大小，依据心电信号的采样率和幅值设置 x 和 y 轴的刻度，其 y 轴最大刻度会随着心电幅值的变化自动作出调整。
2. 创建一个子线程接收心电采集模块传输过来的心电数据包，解析完数据包 后，在子线程中开辟一个缓冲区来保存原始心电数据。
3. 每次从子线程的缓冲区中读取一段心电数据，采用前面介绍过的算法对其 作预处理，然后在主线程中开辟一个缓冲区用来保存预处理后的心电数据。
4. 分别从子线程和主线程的缓冲区中读取预处理前后的心电数据，并在各自 的窗口中绘制对应的心电波形。
用户交互主要是通过操作控件向软件系统发送用户指令，软件系统调用与之关 联的函数对接收到的指令作出响应。用户交互实现的基本流程如图 3-33 所示。

41

电子科技大学硕士论文
开始
创建pyqt中的 控件
将控件操作与对 应函数关联起来
通过操作控件 完成交互
结束
图 3-33 用户交互实现的流程图
1. 创建控件。软件系统中多个模块需要通过控件完成交互功能。在采集心电 信号时，创建一个下拉菜单来配置 COM 口和波特率，通过单击鼠标选择正确的 COM 口和波特率。创建一个按钮来控制串口的开闭，鼠标单击按钮可以实现串口 开闭状态的切换。心电信号数据的存储同样是通过一个按钮来实现，单击按钮确 定数据保存的起始和结束时刻。在心电信号预处理模块中，创建三个复选框分别 控制三种基本干扰的去除。在特征提取模块中，为每个特征参数创建一个文本框， 将计算得到的特征参数输出到文本框中。在进行心电信号异常分析时，当检测到 异常心电信号片段时，会弹出一个新的窗口显示诊断结果，并提醒用户及时采取 救护措施，同时还要创建一个按钮，单击按钮将弹出一个配置诊断信息的窗口， 用于添加用户自定义的异常心电类型。
2. 将控件操作与函数关联起来。下拉菜单控件中有一个监听函数可以获取选 中的菜单选项内容，将鼠标点击操作与之相关联。切换按钮控件需要将按钮两种 不同状态下的点击事件分别与两个不同的函数关联起来。复选框有勾选和未勾选 两种状态，勾选中才会调用去除相应干扰的函数，文本框与打印特征参数的函数 相关联，打开串口接收到心电数据后就会调用此函数。
3. 操作控件完成交互。将控件操作与对应函数关联后，用户利用控件向软件 系统输入指令后，软件系统会调用对应的函数作出响应从而实现交互功能。
3.7 本章小结
本章主要是分别介绍可穿戴心电检测软件系统各个功能模块的设计，包括：采 集与存储模块、预处理模块、特征提取模块、心电信号分析模块和可视化与用户
42

第三章 可穿戴心电检测软件系统的设计
交互模块。在采集与存储模块中，主要介绍了心电采集模块与 PC 端之间数据的传 输、心电数据包的封装格式与解析过程以及心电信号数据保存的过程。预处理模 块主要描述了去基线漂移和去肌电干扰两种不同算法的原理和实现的基本步骤。 特征提取模块的设计讲述了差分阈值和小波变换两种方法进行心电波形检测的实 现过程，并给出了部分特征参数的计算方式。心电信号分析模块的设计主要介绍 依据心电信号特征参数对室性心动过速、室性心动过缓、房性室性早搏、二联律 三联律等心律失常疾病的判定方法。最后介绍可视化与用户交互模块需要使用的 技术及其实现流程。
43

电子科技大学硕士论文
第四章 可穿戴心电检测软件系统的实现
本章首先介绍可穿戴心电检测软件系统的开发环境，然后分别描述每个功能模 块的具体编码实现，包括其使用的类、函数以及实现的具体过程。
4.1 开发环境的介绍
本文的可穿戴心电检测软件系统是基于 Windows 下的 PyQt4 实现的。PyQt4 是编写图形界面程序的一个工具包，是 Python 编程语言与 Qt 库的一种巧妙结合的 产物，Qt 是目前比较成功和强大的一个 GUI 库。PyQt4 是一组 Python 模块的实现， 有 440 个类和超过 6000 种方法。它还是一个几乎可以在所有主流操作系统上运行 的跨平台的工具包。PyQt4 有两种许可方式，开发者们可以选择 GPL 和商用许可， 其中 GPL 是开源免费的，商用是需要付费的。
PyQt4 模块中包含有大量的类，根据功能的不同可将其分为多个模块。其中常 用的模块有 QtCore、QtGui、QtNetwork 和 QtSql，QtCore 包含了 PyQt 非 GUI 功 能模块的核心部分，这个模块用来对时间、文件和目录、不同的数据类型、流、 URL、资源的媒体类型、线程和进程进行处理。QtGui 包含了图形相关的组件和类 库，包括按钮(button)、窗口(window)、状态栏(status bar)、工具栏(toolbar)、滑块 (slider)、位图(bitmap)、颜色(color)和字体(font)等。QtNetwork 模块包括网络编程 的类。这些类可以用来编写 TCP/IP 和 UDP 的客户端和服务器，它们使得网络编 程更容易和便捷。QtSql 模块提供操作数据库的类。
进行图形界面编程首先要创建一个主窗口，PyQt4 中提供了 QMainWindow 类 来创建主窗口。布局管理是如何在窗体中摆放窗口组件，是图形界面编程中非常 重要的一项工作，PyQt4 中有两种布局管理方式：绝对定位和使用布局类。绝对定 位是指用像素指定控件的位置和尺寸，使用绝对定位的一个最大问题是改变布局 需要完全重做，工作量较大，非常浪费时间。使用布局类进行布局管理更灵活， 更高效，基本的布局类有 QHBoxLayout 和 QVBoxLayout，分别用于横向和纵向排 列窗口组件。
窗口组件是图形界面程序的基本组成部分，PyQt4 工具包中包含了许多的窗口 组件，下面简单介绍其中几种比较常用的窗口组件。复选框 QCheckBox 有两种状 态，是一个带标签的框，复选框被选中或取消选中时，都将发射信号 stateChanged() 切换按钮 QPushButton 是指一个包含两种状态的按钮，按下和非按下，通过点击切 换这两种状态。文本编辑框 QLineEdit 用来输入和编辑单行文本，可以使用 setText()
44

第四章 可穿戴心电检测软件系统的实现
或者 insert()改变其中的文本，通过 text()获取文本内容。下拉菜单 QComboBox 是 由一个含有多个选项的列表组成的组合框，当一个选项被选择，会调用 onActivated() 方法。
事件是 GUI 程序的主要部分，所有 GUI 应用程序都是由事件驱动的。应用在 它的生命周期中产生不同事件交互，事件主要由用户产生，但是也可以由其他方 式产生，如：窗口管理器，定时器。事件模型有三要素，分别为：事件来源、事 件对象和事件目标。事件来源是指状态发生变化的对象，由它产生事件。事件对 象将状态的变化封装在了事件来源中。事件目标是指希望被通知到的对象。PyQt4 有一个独特的信号槽机制来处理事件。对象间的沟通由信号和槽来完成。当一个 特定的事件发生时，一个信号被发出；槽可以是任意的 Python 请求。当和槽相关 联的信号发出时，槽会被调用。

4.2 心电信号采集与存储模块的实现
1. 心电信号采集模块的实现 心电信号采集最终是从 PC 端的串口来读取心电数据，因此本文设计一个 serial 类用于完成串口的调式，同时设计一个 QComboBox 类用于获取创建 serial 类对象 时所需的参数，其 UML 类图如图 4-1 所示。

QcomboBox
-Item[12]:string +AddItems() +se tM axVi sibleI te m s() +setMaxCount() +setCurrentIndex() +currentIndex() +currentText()

serial
-BaudRate:int -COMNum:string +open() +read() +close()

图 4-1 心电采集 UML 类图

由图 4-1 可知，serial 类中包含 BaudRate 和 Port 两个数据，分别代表波特率和 串口号，波特率是指串口接收数据的速率，其大小应与发送数据的速率保持一致， 串口号是指 PC 端接收数据的串口编号。波特率和串口号的值是通过 QComboBox 类中的函数来获取。QComboBox 类的对象是一个下拉菜单列表，Item 数组中的数 据为下拉菜单列表中的菜单选项，向菜单列表中添加菜单选项使用 addItem()函数， 用户选中菜单选项后，调用 currentText()函数返回选中的菜单内容。首先创建两个 QComboBox 类分别来获取波特率和串口号的值，然后创建一个 serial 类的对象，

45

电子科技大学硕士论文
通过调用 serial 类的方法对 serial 对象进行操作，从而完成心电信号的采集。 QComboBox 类主要是用于获取创建 serial 类对象时所需的参数，每一个参数
对应着一个新建的 QComboBox 类对象，由于创建过程类似，下面以创建串口号对 应的 QComboBox 类对象为例，其代码如下： SerialCOMLable = QLable(u’串口号’) self.SerialCOMComboBox = QComboBox() self.SerialCOMComboBox.addItems([‘COM1’,’COM2’,…,’COM12’]) self.SerialCOMComboBox.setMaxVisibleItems(10) self.SerialCOMComboBox.setCurrentIndex(8)
其中 SerialCOMComboBox 为创建的 QComboBox 类对象，通过 addItems()方法 将可能出现的串口号添加到下拉菜单列表中，setMaxVisibleItems()方法设置下拉列 表最多同时显示 10 个选项，剩余的利用滑动滚轮显示，setCurrentIndex()方法是初 始时默认选择第 8 个选项。
serial 类的主要功能是打开串口，从串口中读取心电信号数据。其中打开串口 的代码如下： def OpenSerial(self):
ser = serial.Serial() ser.port = self.SerialCOMComboBox.currentText() ser.baudrate = self.SerialBaudRateComboBox.currentText() ser.open()
其中 ser 为创建的 serial 类对象，ser.port 代表 serial 类对象的编号，ser.baudrate 表示 serial 类对象的波特率，两者的值分别通过两个 QComboBox 类对象的 currentText()方法的得到。
打开串口后，就可以从串口中读取心电数据包，并解析出有效的心电信号，其 代码如下： while ser.isOpen():
d = ser.read(1) d_int = StringtoInt(d) …… if checknum == crc:
ecgdata.append(value*3.3/32767.0)
其中 value 表示的是从数据包中解析出的心电信号数据，checknum 代表的是计
46

第四章 可穿戴心电检测软件系统的实现

算得到的校验和，而 crc 是数据包给定校验和标志位数据，ecgdata 为保存心电信 号幅值的数组。
2. 心电信号存储模块的实现 心电信号的存储主要是通过对 File 类对象的读写操作来完成，同时用一个 QPushButton 类对象与对 File 类对象的读写操作关联起来。心电信号存储的 UML 类图如图 4-2 所示。

QPushButton
-Text:string +setGeometry() +setCheckable +setText() +setIcon() +connect()

File
+getName() +lengyh() +isHidden() +open() +read() +write() +close()

图 4-2 心电存储 UML 类图

心电存储模块的实现过程如下：先创建一个 File 类对象，调用 open()函数打开 一个 txt 文件，若 txt 文件不存在，在指定位置新建一个 txt 文件。然后创建一个 QPushButton 类对象，QPushButton 对象是一个切换按钮，用 setCheckable()函数将 切换按钮设置为是可按下的，通过 connect()方法将点击切换按钮事件与 File 类的 方法关联起来。切换按钮有两种状态，Text 的值可以反映出按钮的当前状态。当 Text 的值为“开始保存”时，点击按钮会调用 File 类的 open()和 write()方法，打开 一个新建的 txt 文件并向其中写入心电信号数据，并用 setText()方法更改 Text 的值。 当 Text 的值为“结束保存”时，点击按钮会调用 close()函数，保存数据后关闭 txt 文件，同时用 setText()方法改回 Text 的值。
心电存储的主要工作是创建一个文件，将心电信号数据写入文件中并保存。心 电存储的部分代码如下：
SaveButton = QPushButton(“保存数据”，self) SaveButton.setCheckable(True) if Text == “保存数据”:
SaveButton.setText(“结束保存”) file = open(datetime.now().date().isoformat()+'.txt', 'w') while Text == “结束保存”:
file.writelines(value+’\n’)

47

电子科技大学硕士论文
else: SaveButton.setText(“开始保存”) file.close() 其中 SaveButton 为创建的 QPushButton 类对象，初始时设置 Text 值为”保存数
据”，f 为新建的 File 类对象，点击不同状态下的按钮分别执行上述 if 和 else 语句 里的操作。

4.3 心电信号预处理模块的实现
1. 去工频干扰的实现 心电信号去工频干扰是用一个陷波器来完成，陷波器实际上相当于一个高通滤 波器和低通滤波器组合而成。为此设计了 wave 和 spectrum 两个类，通过调用两个 类中的方法来去除工频干扰，其类图如图 4-3 所示。

wave
-ys[]:double -ts[]:double -framerate:int
+CosSi gnal() +SinSignal() +SinC() +plot() +shift() +make_spectrum()

spectrum
+add() +len() +mul() +low_pas s() +high _pas s() +band_stop() +make_wave()

图 4-3 去工频干扰 UML 类图

去工频干扰的实现过程如下：首先利用 wave 类的构造函数创建一个 wave 类 对象，其中 ys 为解析后的心电信号数据，ts 是以 1/512s 为间距的等间隔时间序列， framerate 的值为 512。然后使用 make_specturm()方法将 wave 类对象转换成 spectrum 类对象，并调用 band_stop()函数去除 50Hz 的工频干扰，接着使用 make_wave 方 法将 spectrum 类对象变回 wave 类对象，返回的 wave 类对象的 ys 值即为去除工频 干扰后的心电信号数据，直接调用 wave 类的 plot()函数可以直接画出去工频干扰 的心电信号波形。
去工频干扰的主要原理是利用傅里叶变换将心电信号从时域转换到频域，然后 在频域中去除掉工频干扰所在的频率段，最后用反傅里叶变换将剩余的心电信号 从频域转换到时域，其核心代码如下：

48

第四章 可穿戴心电检测软件系统的实现

wave = Wave(ecgdata,t,framerate) spectrum = make_spectrum(wave) spectrum.band_pass(49.9,50.1) depowfreq_wave = make_wave(spectrum)
其中 wave 是利用心电信号数据创建的 Wave 类对象，spectrum 为心电信号的 频谱系数，band_stop 为一个带阻滤波器，49.9 和 50.1 分别为带阻滤波器的两个截 止频率，depowfreq_wave 为去工频干扰后的 Wave 类对象。
2. 去基线漂移的实现 本文选用小波变换法来去基线漂移，可以使用 pywt 模块中的类和方法来完成 去基线漂移，pywt 模块中常用的类和方法如图 4-4 所示。
pywt

类 wavelet

方法

dwt

idwt

wavedecn

waverecn

图 4-4 pywt 模块结构图

基于小波变换法去基线漂移的实现过程如下：首先使用 pywt 模块中 Wavelet 类的构造函数创建一个 Wavelet 类对象，其参数为小波基名称，本文选用的小波基 为 sym4。然后调用 wavedecn()函数对心电信号进行多层小波分解，wavedec()函数 包含的参数有：心电信号序列、Wavelet 类对象、模式和分解层数，模式有：zero、 constant、symmetric、periodic、smooth、periodization 和 reflect 六种，本文选用默 认模式 symmetric，分解层数确定为 9，函数返回心电信号在不同尺度上的近似系 数和细节系数。下一步用上一章给出的阈值函数对不同尺度的近似系数和细节系 数作处理。最后用 waverecn()方法对处理后的心电信号小波系数作信号重构， waverecn()方法包含的参数有：小波系数、Wavelet 类对象和模式，函数返回去基 线后的心电信号。
用小波变换法去除基线漂移的核心代码如下：
wavelet = pywt. Wavelet(‘sym4’) coeffs = pywt.wavedecn(ecgdata,wavelet, symmetric,9) …… debaseline_ecgdata = pywt.waverecn(coeffs,wavelet, symmetric)
其中 wavelet 为选用 sym4 创建的 Wavelet 类对象，coeffs 表示对心电信号数据
49

电子科技大学硕士论文

作 9 层小波分解得到的各尺度细节系数和近似系数，省略部分为对 coeffs 作阈值处 理的过程，debaseline_ecgdata 是去基线漂移后的心电信号数据。
3. 去肌电干扰的实现 本文使用一种 EMD 与 PCA 相结合的算法来去除肌电干扰，用 EMD 类主要用 于完成心电信号的 EMD 分解和信号重构，同时在使用 PCA 技术进行降维时涉及 到许多矩阵运算，需使用 matrix 类，其 UML 类图如图 4-5 所示。

matrix
-data[][]:double +min() +max() +sum() +diagonal() +mean() +getI() +getT()

EMD
+emd() +eemd() +emd2d() +emdrec() +eemdrec() +emd2drec()

图 4-5 去肌电干扰 UML 类图

使用 EMD 与 PCA 相结合算法去除肌电干扰的实现过程如下：首先创建一个一 个 EMD 类对象，然后使用 emd()方法对心电信号作经验模态分解，函数返回一系 列的 IMF 分量和一个剩余项。用 IMF 分量创建一个 matrix 类对象。matrix 类对象 是一个矩阵，通过 mean()函数计算矩阵每列元素的均值，将矩阵中每个元素减去 其所在列的均值。然后计算其协方差矩阵，计算过程中需使用 getT()函数。下一步 调用 linalg 类中的 eig()函数得到协方差矩阵的特征值和特征向量。用 sort()方法对 M-1 个特征值进行排序，选出较大的 k 个特征值，并将其对应的特征向量构成一 个矩阵。把原始矩阵与特征向量构成的矩阵相乘，得到的矩阵中的 k 列数据即为 PCA 技术降维后得到的 k 个主分量。最后使用 emdrec()方法作心电信号的重构。
去肌电干扰实现的部分代码如下：
emd = EMD() IMFs = emd.emd(ecgdata) mat = matrix(IMFs) row_mean = mat.mean(0) mean_mat = matrix.repeat(row_mean) mat = mat – mean_mat cov_mat = mat.getT()*mat w,v = numpy. linalg.eig(cov_mat)

50

第四章 可穿戴心电检测软件系统的实现
w = numpy.sort(w) …… mat_y = mat * mat_k …… deemg_ecgdata = emdrec(mat_y)
其中 emd 为创建的 EMD 类对象，IMFs 为分解后的 IMF 分量，mat 为创建的 原始矩阵，cov_mat 是协方差矩阵，w，v 是协方差的特征值和特征向量，mat_y 表示经 PCA 技术提取后的 k 个主分量组成的矩阵，deemg_ecgdata 是指去肌电干扰 后的心电信号数据。
4.4 心电信号特征提取模块的实现
1. 基于差分阈值法的波形检测的实现 使用差分阈值法进行波形检测，主要是利用心电波形的形态特征及其代表的数 学意义，可以用 numpy 等模块中的方法实现。差分阈值法进行心电波形检测的实 现过程如下：先调用 diff()函数计算心电信号的差分序列，再使用 square()方法得到 心电信号的差分平方序列。然后通过自适应阈值和 where()函数找到 R 波波峰所在 的区间，利用 max()和 index()方法定位到 R 波波峰。定位到 R 波波峰以后，以 R 波波峰为起点在一定的窗口内分别向左和向右搜索其他瞬变点，瞬变点大多为极 值点，对应为差分序列中符号发生变化的点，可通过循环比较相邻点的值寻找得 到。 由于其他波形的检测方法与 R 波类似，此处以 R 波检测为例，差分阈值法 R 波检测的部分代码如下： def RPeakDetect(ecgdata): y = numpy.diff(ecgdata) square_y = numpy.square(y) index = numpy.where(square_y> th)[0] …… for i in np.arange(0, len(board_index), 2):
tmp = ecgdata[board_index[i]: board_index[i+1]] RA = max(tmp) RPindex = np.where(tmp == RA)[0] + board_index[i]+1 return RPindex
其中，y 是心电信号的差分序列，square_y 是心电信号的差分平方序列，index
51

电子科技大学硕士论文
是 square_y 中所有大于阈值的序列号，board_index 中保存的是每个 R 波波峰所在 区间的边界点序列号，RA 和 RPindex 分别是 R 波波峰的幅值和序列号。
2. 基于小波变换法的波形检测的实现 使用小波变换法进行心电波形检测是对心电信号作多尺度分解，分别在不同 尺度的系数上检测不同的心电波段，主要是利用 pywt 模块和 numpy 模块中的方法 来完成。 采用小波变换法实现心电波形检测的过程如下：首先创建一个 Wavelet 类对象， 小波基为双正交 B 样条小波，然后使用 wavedecn()函数对心电信号作 6 层小波分 解，得到 6 层细节系数和 1 层近似系数。先通过循环比较 cd5 系数中相邻点间的 大小，找到所有正负模极值点，并计算出正负阈值。然后用 where()函数找到并剔 除掉不在正负阈值之间的极值点以及间隔大于 100ms 的模极值对。继续用 where() 函数在剩余的模极值对间寻找过零点，每个过零点对应一个 R 波波峰。定位准 R 波波峰后，以 R 波波峰为基准分别在对应尺度上检测其他波形。 由于其他波形的检测与 R 波类似，此处以 R 波检测为例，基于小波变换法进 行 R 波检测的部分代码如下： def RPDetect(ecgdata): wavelet = pywt. Wavelet(‘bior2’) coeffs = pywt.wavedecn(ecgdata,wavelet, symmetric,6) cd5 = coeffs[:,2] for i in range(len(cd5)-2):
if(cd5[i+1]>cd5[i] and cd5[i+1]>cd5[i+2]): extre_maxindex.append(i+1)
elif(cd5[i+1]<cd5[i] and cd5[i+1]<cd5[i+2]): extre_minindex.append(i+1)
…… for i in range(len(extre_maxindex)):
b = cd5[extre_minindex: extre_maxindex] RPindex.append(numpy.where(b == 0)[0]+15) return RPindex
其中 wavelet 为创建的 Wavelet 类对象，coeffs 为分解后的小波系数，cd5 为第 5 层细节系数，extre_maxindex 和 extre_minindex 分别保存 cd5 系数中的极大值和 极小值的索引，RPindex 是 R 波波峰处的索引值。
52

第四章 可穿戴心电检测软件系统的实现
4.5 心电信号分析模块的实现
1. 常见异常心电信号诊断的实现 常见异常心电信号诊断的实现主要分为：异常心电信号片段的检测、诊断结果 的输出和诊断结果的保存。其中异常心电信号片段的检测采用的是逻辑分支判断 法，将异常检测过程分解为一系列相连接的逻辑判断子过程，可以将这些逻辑判 断封装成一个函数。诊断结果的输出的实现是先定义一个继承自 QWidget 类的窗 口部件类，并在其构造函数中调用一个用于定义窗口布局和输出诊断结果的函数。 诊断结果的保存与前面介绍过的存储模块的实现类似，这里不再叙述。 每一种类型的异常心电信号诊断的实现过程大致相同，因此本文以室性心动过 速的诊断为例，其部分实现代码如下： def OverspeedHeartbeat(Heartbeat): if RR < 0.5 and RRavg – RR > 0.12 and RA – RAavg > 0.15:
flag = True else:
flag = False return flag def VT(): while True:
if OverspeedHeartbeat(Heartbeat) == True: count = count + 1 Heartbeat = Heartbeat + 1
if count > 3 and RR < 0.75* RRagv and nextRR > 1.25* RRagv: newWindow = SecondWindow() newWindow.show() newWindow.exec_() saveDiagResult() count = 0
OverspeedHeartbeat() 函 数 的 功 能 是 判 断 一 个 心 拍 是 否 为 过 速 心 拍 ， 其 中 Heartbeat 为当前心拍的编号，RR 为当前 RR 间期，RRavg 为正常 RR 间期均值， RA 为当前 R 波幅值，RAavg 为平均 R 波幅值。VT()函数的功能是对心电信号作 室性心动过速诊断，其中 count 表示连续过速心拍的个数，nextRR 为下一个 RR 间 期，newWindow 为新创建的一个窗口对象，用于输出诊断结果，saveDiagResult()
53

电子科技大学硕士论文
函数功能为保存诊断结果。 2. 用户自定义心电信号诊断的实现 用户自定义心电信号诊断的实现与常见心电信号诊断的实现相比，增加了配置
诊断信息、保存诊断信息和读取诊断规则的实现。配置诊断信息需使用 QLineEdit 类和 QcomboBox 类，创建 QLineEdit 类对象用于输入异常心电信号类型的名称和 诊断规则中的判断条件，创建 QcomboBox 类对象用于选取诊断规则中所需的心电 信号特征参数。保存诊断信息的实现首先需要使用 QLineEdit 类中的 text()方法和 QcomboBox 类中的 currentText()方法获取诊断信息的内容，然后使用 xlwt 模块中 的 Workbook 类创建一个 excel 表格，用 add_sheet()方法在 excel 表格中创建一个 sheet，最后用 write()函数将诊断信息写入到 excel 表格的一个 sheet 中,并用 save() 方法将 excel 表格保存在指定的位置。读取诊断规则其实就是对 excel 表格的读操 作，先调用 xlrd 模块中 open_workbook()方法打开 excel 表格，然后用 sheet_by_name() 方法打开 excel 中的 sheet 表，用 cell_value()方法得到 sheet 表中的内容。其余功能 的实现与常见心电信号诊断的实现类似，这里不再重复叙述。
配置诊断信息实现的部分代码如下： abnormal_lable = QLable(‘异常类型’) name_edit = QtGui. QLineEdit() FeaQComboBox = QtGui. QcomboBox() FeaQComboBox.addItems([‘RR’,’RA’,…,’PR’]) condition_edit = QtGui. QLineEdit()
其中 abnormal_lable 为创建的 QLable 类对象，初始化其值为“异常类型”， name_edit 是创建的 QLineEdit 类对象，用于输入异常心电信号类型的名称， FeaQComboBox 为创建的 QcomboBox 类对象，通过 addItems 来添加菜单选项， condition_edit 也是 QLineEdit 类对象，用于输入诊断规则中的判断条件。 保存诊断信息实现的部分代码如下： book = xlwt. Workbook() sheet = book.add_sheet(‘Diagrlues’) sheet.write(0,0, name_edit.text()) sheet.write(1,0, FeaQComboBox. currentText()) sheet.write(1,1, condition_edit. text ()) …… book.save(r‘C:\...\ Diagrlues.xls’)
54

第四章 可穿戴心电检测软件系统的实现
其中 book 是创建的 excel 表格，sheet 是在 excel 表格中创建的 sheet 表， name_edit.text()用来获取异常心电信号的类型名称，FeaQComboBox.currentText() 是用来获取选中的心电特征参数，condition_edit.text()用来获取相应特征参数应满 足的条件，用 write()函数向 sheet 表指定位置中写入诊断信息的内容，用 save()函 数将 excel 表格保存在指定位置。
读取诊断信息实现的部分代码如下：
book = xlrd.open_workbook(‘C:\...\ Diagrlues.xls’) sheet = book.sheet_by_name(‘Diagrlues’) cell_value1 = sheet.cell_value(0,0) cell_value2 = sheet.cell_value(1,0) cell_value3 = sheet.cell_value(1,1) ……
其中 book 是用来获取 Excel 表格的对象，sheet 是通过 sheet 表的名字获得 sheet 对象，cell_value1, cell_value2, cell_value3 分别是 sheet 表中第一行第一列、第二行 第一列和第二行第二列中的内容。
4.6 可视化与用户交互模块的实现
可穿戴心电检测软件系统的用户界面是在 PyQt4 工具的基础上开发实现的。 每一个利用 PyQt 开发的程序必须先创建一个 application 对象，application 是 QtGui 中的一个类。然后用 QtGui 中 QMainWindow 类实例化一个对象，作为用户界面的 主窗口，在实例化时可以指定主窗口的大小。在主窗口中创建一个 DockArea 类对 象，DockArea 类对象是一个停靠窗口容器。停靠窗口容器中可以容纳多个停靠窗 口，使用 Dock 类分别为心电波形显示区和用户交互控制区创建两个停靠窗口。下 面分别介绍心电波形显示区和用户交互控制区的实现。
心电信号波形的绘制选用的是 pyqtgraph 绘图库，pyqtgraph 提供了三种方式来 进行 pyqtgraph 图像的绘制和调用，分别是：命令行控制调用、直接显示图像窗口 和嵌入在 PyQt 部件中。由于可穿戴心电检测软件系统还需要很多用户交互功能， 因此选择使用将 pyqtgraph 图像嵌入在 PyQt 部件中的方式。pyqtgraph 库中常用的 绘图方法如图 4-6 所示。
本文选用的是 PlotWidget()方法，首先使用 Dock 类实例化一个 Dock 类对象， Dock 类对象为停靠窗口，然后用 pyqtgraph 中的 PlotWidget()方法实例化两个对象， 实例化的两个对象为图形窗口，图形窗口对象可以调用 setXRange()和 setYRange() 方法来设置 x 轴和 y 轴的刻度，还可以用 showGrid()方法来设置在图形窗口中是否
55

电子科技大学硕士论文
使用网格，并利用 Dock 类中的 addWidget()方法将两个图形窗口添加到停靠窗口中。 接着调用图形窗口对象的 plot()方法实例化一个曲线对象，调用曲线对象的 setdata() 函数来获取绘制波形的心电数据，并通过一个定时器来更新绘图，更新时间设置 为 10ms。
pyqtgraph

plot

PlotWidget

PlotItem

GraphicsLayout GraphicsWindow

图 4-6 pyqtgraph 库常用绘图方法

心电信号波形可视化的部分代码如下：
D1 = Dock(‘painting’,size=(1200, 600)) PW1 = pyqtgraph.PlotWidget() PW2 = pyqtgraph.PlotWidget() D1.addWidget(PW1) D1.addWidget(PW2) curve1 = PW1.plot(pen = ‘y’) curve2 = PW2.plot(pen = ‘y’) def update():
curve1.setData(ecgdata[-1500:]) curve2.setData(denoise_ecgdata[-1500:]) timer = QtCore.QTimer() timer.timeout.connect(update) timer.start(10)
D1 为实例化的 Dock 类对象，’painting’为停靠窗口的名称，用参数 size 给定 Dock 停靠窗口的大小，PW1 和 PW2 是用 pyqtgraph 中的 PlotWidget 类实例化的两 个图形窗口对象，分别用来绘制原始心电信号波形和去噪后的心电信号波形。 curve1 和 curve2 是用图形窗口类中的 plot()方法实例化的两个曲线对象，pen 参数 用来设置曲线的颜色，setData()方法是将绘制心电波形的数据传给曲线对象。timer 是一个定时器，定时器启动时间设定为 10ms，当定时器超时时会触发 update()函 数，update()函数的功能是更新绘制最新接收的 1500 个采样点的心电波形，不足 1500 个采样点时更新绘制全部心电数据的波形。
用户交互控制区的各种组件均需要设计在其所属的 Dock 停靠窗口内，先在
56

第四章 可穿戴心电检测软件系统的实现
Dock 停靠窗口中创建一个 LayoutWidget 类对象，LayoutWidget 类是一个用于网格 布局的窗口。用户交互控制区中主要的组件包括：文字显示、下拉菜单、复选框、 文本框和切换按钮，这些组件都包含在 QtGui 模块中。QtGui 模块中主要包含的组 件如图 4-7 所示。
QtGui

QLable

QLineEdit QComboBox

QPushButton

QCheckBox

图 4-7 QtGui 模块常用组件

文字显示使用 QLabel 类创建，创建时给定显示的文本内容，如果显示的文本 为中文，需要转换解码方式。下拉菜单使用 QComboBox 类创建，创建时用 addItems 添加菜单选项，通过 currentText()方法获取当前选中的内容。复选框用 QCheckBox 类创建，由一个选择框和一个 lable 组成，复选框选中或取消都会使 stateChanged 信号发生变化。文本框用 QLineEdit 类创建，用 setReadOnly()方法将其属性设置为 只读。切换按钮用 QPushButton 类实例化，使用 setText()方法设置按钮上的文字， 用 setEnabled() 方 法 将 按 钮 属 性 设 置 为可 按下 。 待 所有 组 件创 建完 毕 后 ， 用 addWidget()方法将这些组件添加到 LayoutWidget 窗口中，addWidget()方法种包含 的参数有：组件名称、行数、列数、行宽和列宽，其中行宽和列宽是相对 LayoutWidget 窗口的宽度。最后将组件的触发事件与对应的函数用 connect 关联起来，从而达到 通过操作组件实现用户交互功能。
用户交互控制区实现的部分代码如下：
D2 = Dock("control", size=(1200, 200)) LW = pyqtgraph.LayoutWidget() seriallabel_text = unicode('串口号:','utf-8') seriallabel = QtGui.QLabel(seriallabel_text) …… checkbox1 = QtGui.QCheckBox() …… featureEdit1 = QtGui.QLineEdit() …… dianolog_text = unicode('自定义诊断','utf-8')

57

电子科技大学硕士论文
dianologBtn = QtGui.QPushButton(dianolog_text) dianologBtn.clicked.connect(diagrules_setting) LW.addWidget(seriallabel, row=0, col=0,rowspan=1,colspan=1 ) …… D2.addWidget(LW)
其中 D2 为创建的 Dock 停靠窗口，’control’为停靠窗口的名称，使用参数 size 来设置停靠窗口的大小。LW 为在 D2 中创建的 LayoutWidget 类窗口，seriallabel 为创建的 QLabel 对象，seriallabel_text 是要显示的文本内容，unicode()方法的功能 是将解码方式从 utf-8 转换为 unicode。checkbox1 为创建的一个复选框对象， featureEdit1 是一个用于显示特征参数的文本框对象。dianologBtn 是创建的一个切 换按钮，通过 connect()方法将点击按钮事件与 diagrules_setting()函数相关联。 addWidge()方法主要是将创建的组件放在窗口中指定的位置。
4.7 本章小结
本章主要是讲述可穿戴心电检测软件系统各功能模块的具体实现过程。首先， 简单介绍了可穿戴心电检测软件系统的开发环境 PyQt4，主要介绍其基本构成和开 发特点。然后分别介绍各个功能模块在开发过程中使用的方法和具体实现步骤。
58

第五章 系统测试与分析
第五章 系统测试与分析
本章将对设计的可穿戴心电检测软件系统进行功能测试，软件系统主要包含以 下功能：心电信号的采集与存储、心电信号的预处理、心电信号的特征提取和异 常心电信号诊断。心电信号的采集与存储模块主要是检验其是否达到设计要求， 心电信号的预处理、心电信号的特征提取和异常心电信号诊断除了验证其基本功 能之外，还要对其算法作性能分析，检查性能是否达到预期的指标。
5.1 系统功能验证
系统功能测试所需的环境如下：一台装有可穿戴心电检测软件系统的电脑，如 果电脑没有自带蓝牙，还需要一个蓝牙串口模块，一个封装有心电采集模块的小 盒子和一条嵌入织物电极的胸带。按照第二章所述的方式穿上可穿戴式胸带，在 实验室找一个稍显宽敞的位置进行系统测试。
首先打开心电采集模块的电源开关，蓝牙模块的蓝色指示灯会间歇性的闪烁， 然后与 PC 端的蓝牙进行配对连接，连接成功后指示灯变为持续闪烁。连接成功后， 会给 PC 端分配一个 COM 口，通过 PC 端的设备管理器可以查询到 COM 口号。 由于心电采集模块发送数据的波特率为 57600，因此在串口接收数据的波特率也要 设置为 57600。在软件系统主界面上选中对应的 COM 口和波特率，并单击“打开 串口”按钮，至此 PC 端就可以接收到心电信号数据，其主界面如图 5-1 所示。
图 5-1 心电信号采集功能验证界面
59

电子科技大学硕士论文
从图 5-1 中可知，串口号和波特率配置成功，点击“打开串口”按钮后，按钮 文字变为“关闭串口”，同时能够在绘图区中看到实时绘制的心电波形，意味着心 电信号数据已经被 PC 端成功接收，心电采集功能可以正常工作。由于还未勾选预 处理的选项，因此在两个坐标轴中绘制的均为原始心电信号。此段心电信号是在 静止状态下采集的，因此看起来比较干净和整齐。
打开串口后，PC 端从串口中读取心电信号数据，单击“保存数据”按钮，按 钮上的文字变为“结束保存”，等待一段时间以后，再次单击按钮，按钮上的文字 又变回“结束保存”，至此心电信号数据保存结束。心电信号数据保存在一个以当 前时间命名的 txt 文件中，心电信号数据 txt 文件如图 5-2 所示。
图 5-2 心电信号数据 txt 文件
单击“保存数据”按钮后，在 PC 端的指定位置可以看到一个新建的以当前时 间命名的 txt 文件。数据保存完成后，打开 txt 文件可以看到里面保存的心电信号 数据如图 5-2 所示，然后将保存在 txt 文件中的心电数据绘制成波形，其波形如图 5-3 所示。从图中可以看到，绘制出的波形与典型的心电信号波形形态基本一致， 可以清晰的分辨出心电信号的各个波段，其幅值和周期也符合正常心电信号的要 求，因此可以确定心电信号存储功能是正常工作的。
60

第五章 系统测试与分析
图 5-3 txt 文件中心电数据的波形
心电信号的预处理主要是去除以下三种干扰，分别为：工频干扰、基线漂移和 肌电干扰。用户通过勾选复选框来选择去除的干扰，先分别勾选每一种干扰，然 后同时选中三种干扰，通过对比原始心电信号和去除干扰后的心电信号波形，来 测试预处理模块的功能是否正常。心电信号预处理前后的波形如图 5-4 所示。
图 5-4 心电信号去基线漂移前后的波形
从图 5-4 可以看到，预处理前的心电信号波形上下起伏波动较大，基线漂移较 为严重，经过去基线漂移算法处理后，心电信号波形的起伏明显有所减小，心电
61

电子科技大学硕士论文
信号的基线几乎被拉成了一条水平线。 从图 5-5 可知，预处理前的心电信号中存 在着较大的基线漂移，在波形中还能看到许多的毛刺，这些毛刺主要就是由肌电 干扰引起的，经过处理后的心电信号明显比较整齐，被拉到了一条水平线上，且 信号变光滑了，几乎看不到毛刺。经过对上述预处理前后心电波形的对比分析， 确认心电信号的预处理模块可以正常工作。
图 5-5 心电信号预处理前后的波形
从上面几幅图中可以看到，心电特征参数被输出到了软件系统界面对应的文本 框中，且文本框中显示的心电特征参数的数值每隔 2s 会进行一次更新，因此心电 特征提取模块是处于工作状态的。如果复选框一个都没有选中，则特征参数是依 据原始心电信号数据计算得到。如果复选框被选中了，特征参数是用预处理后的 心电信号数据计算得到。
由于身边没有找到患心律失常的用户，本文选择使用 MIT-BIH Arrhythmia 数据 库中的数据对心电信号分析模块中的异常心电信号片段检测算法进行测试。本文 在数据库中分别各挑选出 10 组标记有室性心动过速、室性心动过缓、房室性早搏、 室性二联律和室性三联律的心电信号数据，然后分别测试挑选出的数据，最终， 50 组数据均检测出异常。因此，说明异常心电信号片段检测算法是可行的。接着 测试用户自定义诊断功能，单击“自定义诊断”按钮后，弹出了一个配置诊断信 息的窗口，用户显示界面如图 5-6 所示。用户输入诊断信息后，点击“保存”按钮， 诊断信息被保存在一个 excel 表格中，excel 表格中的内容如图 5-7 所示。
从图 5-6 和 5-7 可以看到，点击“自定义诊断”按钮后，弹出了一个新的窗口 用于配置诊断信息，可以在下拉菜单中选择不同的特征参数，异常类型名称和特
62

第五章 系统测试与分析
征参数应满足的条件通过用户手动输入。单击“保存”按钮后，上述的诊断信息 被依次保存在 excel 表格中。因此软件系统的用户自定义诊断功能是可行的。
图 5-6 用户自定义诊断配置界面
图 5-7 诊断信息保存
5.2 系统性能分析
本文通过可穿戴式胸带采集心电信号数据，分别采集用户静止状态和日常活动 状况下的心电信号，日常活动状况下的心电信号采集是通过让实验者做指定的动 作来模拟日常活动实现的，然后对心电信号数据作处理和分析，并将第二章中提 出的技术指标作为评判软件系统性能的标准。
1. 实验准备 将可穿戴式胸带佩戴在实验者胸前合适的位置，调整好胸带的松紧程度，使实
63

电子科技大学硕士论文
验者处于一个比较舒适放松的状态。打开可穿戴心电检测软件系统，打开心电采 集模块的电源开关，配对连接心电采集模块与 PC 端，选择正确的 COM 口和波特 率，并打开串口。
2. 实验内容 (1) 实验者先安静站立 30s，待心电信号稳定下来后，继续保持站立 5 分钟， 记录下心电信号数据； (2) 实验者先安静站立 30s，待心电信号稳定下来后，在小范围内慢走 5 分钟， 记录下心电信号数据； (3) 实验者先安静站立 30s，待心电信号稳定下来后，重复下蹲动作 5 分钟， 记录下心电信号数据； (4) 实验者先安静站立 30s，待心电信号稳定下来后，重复扩胸运动 5 分钟， 记录下心电信号数据；

(a)

(b)

(c)

(d)

图 5-8 四种不同动作下的心电图： (a) 静止时的心电图；(b) 慢走时的心电图； (c)下蹲时的心电图；(d) 扩胸时的心电图

本文总共有 30 名实验对象，年龄分布在 20~25 岁，其中 15 名男生，15 名女

64

第五章 系统测试与分析

生，每个人重复上述实验内容 3 次，总共得到 360 组实验数据。其中一个实验对 象分别做上述四个动作时的心电波形如图 5-8 所示。
利用第三章中设计的算法对采集到的心电信号数据作预处理，然后分别计算出 每组心电数据的信噪比和均方差，统计出男生和女生分别在四种不同动作下的信 噪比和均方差的平均值，如表 5-1 和 5-2 所示。

SNR(db) 男生 女生

表 5-1 不同性别不同动作下心电信号的 SNR

静止 32.53 32.45

慢走 31.14 30.87

下蹲 24.32 23.72

扩胸 21.36 20.68

表 5-2 不同性别不同动作下心电信号的 MSE

MSE

静止

慢走

下蹲

扩胸

男生

0.00326

0.00378

0.0608

0.0732

女生

0.00324

0.00382

0.0614

0.0727

从表 5-1 和 5-2 中可以看出，男生和女生心电信号的 SNR 和 MSE 的差异性较

小，静止状态下采集的心电信号质量最好，其 SNR 最大，MSE 最小，慢走时的心

电信号质量也还不错，稍逊色于静止时的心电信号，说明静止和慢走时心电信号

预处理的效果较好。下蹲和扩胸时的心电信号质量明显比静止和慢走时的心电信

号差，去噪效果也不如静止和慢走的时候，有待进一步的改进。

用第三章设计的方法对预处理后的心电信号数据作波形检测，分别统计 15 个

男生和 15 个女生在四种不同动作下 R 波的检测情况，其 R 波的检测情况如表 5-3

所示。

从表 5-3 可以看到，静止状态下 R 波检测的准确率最高，高达 99.4%，其心率

敏感性和心率变异性也最大，慢走状态下次之，下蹲和扩胸时 R 波检测的准确率

最低。整体来说，R 波检测算法的准确率比较高，符合预期的目标。

由于实验对象均为健康人群，因此采集的实验数据不适合作为心电信号异常诊

断的准确率分析的数据。类似于前面异常心电信号片段检测的功能验证，本文选

用 MIT-BIH Arrhythmia 数据库中的数据来分析计算心电信号异常诊断的准确率。

从 MIT-BIH Arrhythmia 数据库中分别各挑选出 20 组标记有室性心动过速、室性心

动过缓、房室性早搏、室性二联律和室性三联律的心电信号数据以及 20 组正常的

心电信号数据，共 120 组心电信号数据，经过异常心电信号片段的检测算法后，

得到的检测结果如表 5-4 所示。从表中可知，心电信号分类的准确率为 94.2%。

65

电子科技大学硕士论文

心拍个数
静止 慢走 男 下蹲 扩胸 生 合计 静止 慢走 女 下蹲 扩胸 生 合计

表 5-3 不同性别不同动作下 R 波的检测情况

总心拍个数
6256 6393 6295 6304 25248 6535 6508 6573 6485 26101

正确检测的 R 波 误检的 R 波个数 漏检的 R 波个数
个数

6217

23

16

6338

34

21

6182

65

48

6175

74

55

24912

196

140

6494

26

15

6451

37

20

6475

57

41

6364

68

53

25784

188

129

测试心电总个数 120

表 5-4 心电信号数据的分类状况 分类正确的心电个数 113

分类错误的心电个数 7

5.3 本章小结
本章主要是对可穿戴心电检测软件系统进行功能验证和性能分析，首先分别检 验各功能模块是否可以正常工作，然后设计实验来获取实验数据，利用实验数据 对软件系统做性能分析。

66

第六章 总结与展望
第六章 总结与展望
6.1 总结
本文主要是针对基于织物心电电极的心电采集模块设计一个软件系统，用于监 测人体的心脏活动状况，及时发现异常的心电信号片段，减轻心脏疾病对人类健 康的危害。
本文首先讲述了论文的研究背景与意义和国内外的研究现状，接着介绍心电信 号处理与分析的相关技术理论，包括：心电信号的噪声来源，常用的心电预处理 方法、常用的心电特征提取和心电信号分析的方法等。然后，对软件系统作需求 分析，进行总体设计，按功能的不同将软件系统分为：心电信号采集与存储模块、 心电预处理模块、心电特征提取模块、心电信号分析模块和可视化及用户交互模 块。随后分别介绍各个功能模块的设计与实现，心电信号的采集和存储主要是通 过对串口和文件的基本操作来实现，心电信号的预处理主要是选用小波变换法去 除基线漂移，用 EMD 与 PCA 相结合的方法去除肌电干扰，心电信号的特征提取 采用的是差分阈值法和小波变换法，心电信号分析是采用逻辑分支判断法来检测 心电信号中是否出现异常的心电信号片段，初始时只能检测出几种常见的心律失 常，用户可以通过配置异常诊断规则可以添加新的异常类型。
最后，对软件系统进行整体测试，每一个功能模块均达到设计要求，对软件系 统作性能分析，各部分的性能也达到了相应指标。
6.2 展望
本文的主要工作是针对基于织物心电电极的心电采集模块设计一个软件系统， 最后设计出了一个可行的软件系统，但是仍然存在着许多不足之处，需要在后续 工作中进行完善。
(1) 需要对预处理模块中的算法作改进，从第五章中可以看到,被测者在做幅度 比较大的动作时，预处理的效果还有提升。
(2) 在作特征提取时，可以提取一些心电信号的频域特征，将时域和频域特征 结合起来用于诊断可能效果更好，心电信号分析模块采用的逻辑分支判断法，其 诊断规则主要依赖于医生的经验，可换成机器学习的方法。
(3) 测试部分采集的实验数据较少，且实验对象人群过于单一，实验对象数量 需增加，且年龄范围分布应更广，还应采集一些心脏病患者的心电信号数据。
67

致谢
致谢
时光如白驹过隙，马上就要离开校园，正式的步入社会。很庆幸当初的选择， 让我拥有了研究生阶段的宝贵经历。三年的研究生生活使我的眼界变得更加开阔， 性格变得更加成熟，当然最重要的还是遇到了一群良师益友，他们的出现让我的 研究生生活变得更充实更丰富多彩。
在此，我首先要感谢我的导师夏侯士戟老师，他不仅在学习科研方面为我解疑 答惑，还教会了我许多做人的道理。他为人谦逊、和蔼亲切、诙谐幽默，对待工 作兢兢业业、一丝不苟。他的言行举止在不知不觉中影响着身边的学生，他身上 那种豁达和不服输的精神给我留下了深刻的印象。
与此同时，我还要感谢实验室里的陈东义老师和黄志奇老师。陈老师为人一身 正气，做事非常严谨，眼界十分开阔，思维特别活跃，经常鼓励学生要敢想敢做， 要走出实验室，从实践中学习。黄老师在科研上有自己独特的见解，善于指导学 生，工作非常认真，在生活上也给实验室的同学们提供了很多帮助。
接着，我要感谢实验室的全体同学，感谢他们陪我一起度过这段难忘的时光。 感谢熊帆师兄、郭承刚师兄、万春霆师兄和已毕业的谭署秋师姐在学习生活中给 我的帮助，感谢程顺均、李闻捷、肖翔、王红梅和赵明皓同学一直以来的陪伴， 感谢陈俊辉、陈正豪、朱其锐、代蜀梅、王静艳和赵佳乐师弟师妹给我的帮助， 尤其是找工作和写论文期间，感谢已经毕业的石天山、熊晓峰、陈晓和王琳琳师 兄师姐给我的提供的帮助。
同时，感谢我的父母一直以来对我的支持和鼓励，感谢所有亲朋好友一直以来 对我的关心和爱护，感谢你们为我创造了一个健康美好的成长环境。最后，我要 感谢所有的评审老师和专家，感谢你们在百忙之中抽空阅读和评审我的论文，对 此再次表示感谢，你们辛苦了！
68

攻读硕士学位期间取得的成果
参考文献
[1] Ramli A B, Ahmad P A. Correlation analysis for abnormal ECG signal features extraction [C], proceedings of the Telecommunication Technology, 2003 Nctt 2003 Proceedings National Conference on, 2003: 232-237
[2] 吴璠. 穿戴式单导联心电监测系统及检测位置综合研究 [D]; 浙江大学, 2017, 16-20 [3] Noury N, Dittmar A, Corroy C, et al. VTAMN - A smart clothe for ambulatory remote
monitoring of physiological parameters and activity [J]. 2004, 5:3266-3269 [4] Rienzo M D, Rizzo F, Parati G, et al. MagIC System: a New Textile-Based Wearable Device for
Biological Signal Monitoring. Applicability in Daily Life and Clinical Setting [C], 2005: 7167 [5] Habetha J. The MyHeart project--fighting cardiovascular diseases by prevention and early
diagnosis [C], proceedings of the International Conference of the IEEE Engineering in Medicine & Biology Society, 2006: 6746 [6] Yang H K, Lee J W, Lee K H, et al. Application for the wearable heart activity monitoring system : Analysis of the autonomic function of HRV [C], proceedings of the International Conference of the IEEE Engineering in Medicine & Biology Society, 2008: 1258 [7] Cunha J P S, Cunha B, Pereira A S, et al. Vital-Jacket®: A wearable wireless vital signs monitor for patients' mobility in cardiology and sports [C], proceedings of the Pervasive Computing Technologies for Healthcare, 2010: 1-2 [8] Baek, Ju-Yeoul, An, et al. Flexible polymeric dry electrodes for the long-term monitoring of ECG [J]. Sensors & Actuators A Physical, 2008, 143(2): 423-429 [9] Park C, Chou P H, Bai Y, et al. An ultra-wearable, wireless, low power ECG monitoring system [C], proceedings of the Biomedical Circuits and Systems Conference, 2006 Biocas, 2006: 241244 [10] 孙振华. 腕带式多参数健康监护系统的研究 [D]; 哈尔滨工业大学, 2007:10-12 [11] Jung H C, Moon J H, Baek D H, et al. CNT/PDMS composite flexible dry electrodes for longterm ECG monitoring [J]. IEEE Transactions on Biomedical Engineering, 2012, 59(5): 14721479 [12] Peng M, Wang T, Hu G, et al. A wearable heart rate belt for ambulant ECG monitoring [C], proceedings of the IEEE International Conference on E-Health Networking, Applications and Services, 2012: 371-374 [13] Joshi S L, Vatti R A, Tornekar R V. A Survey on ECG Signal Denoising Techniques [C],
69

参考文献
proceedings of the International Conference on Communication Systems and Network Technologies, 2013: 60-64 [14] Rosu M C, Hamed Y. Methods for Denoising the ECG Signal in Wearable Systems [C], proceedings of the International Conference on Electronics, Computers and Artificial Intelligence, 2015: 1-6 [15] 付乾坤. 基于心电信号的生物识别技术研究 [D]; 哈尔滨工业大学, 2015:19-21 [16] Sun Y, Chan K L, Krishnan S M. Characteristic wave detection in ECG signal using morphological transform [J]. BMC Cardiovascular Disorders, 2005, 5(1): 1-7 [17] Shemi P M, Shareena E M. Analysis of ECG signal denoising using discrete wavelet transform [C], proceedings of the IEEE International Conference on Engineering and Technology, 2016 [18] Poornachandra S. Wavelet-based denoising using subband dependent threshold for ECG signals [J]. Digital Signal Processing, 2008, 18(1): 49-55 [19] Singh B N, Tiwari A K. Optimal selection of wavelet basis function applied to ECG signal denoising [J]. Digital Signal Processing, 2006, 16(3): 275-287 [20] Kabir M A, Shahnaz C. Denoising of ECG signals based on noise reduction algorithms in EMD and wavelet domains [J]. Biomedical Signal Processing & Control, 2012, 7(5): 481-489 [21] Blanco-Velasco M, Weng B, Barner K E. ECG signal denoising and baseline wander correction based on the empirical mode decomposition [J]. Computers in Biology & Medicine, 2008, 38(1): 1 [22] Seena V, Yomas J. A review on feature extraction and denoising of ECG signal using wavelet transform [C], proceedings of the International Conference on Devices, Circuits and Systems, 2014: 1-6 [23] 汪振兴. 心电信号特征提取和 ST 段识别算法研究 [D]; 重庆大学, 2012:22-26 [24] Min S K, Cho Y C, Seo S T, et al. Auto-detection of R wave in ECG (electrocardiography) for patch-type ECG remote monitoring system [J]. Biomedical Engineering Letters, 2011, 1(3): 180 [25] Li C, Zheng C, Tai C. Detection of ECG characteristic points using wavelet transforms [J]. IEEE Trans Biomedical Eng, 1995, 42(1): 21-28 [26] Manikandan M S, Ramkumar B. Straightforward and robust QRS detection algorithm for wearable cardiac monitor [J]. Healthcare Technology Letters, 2014, 1(1): 40 [27] Ramakrishnan S, Yogeswaran R. Design and analysis of feature extraction algorithm for ECG signals using adaptive threshold method [J]. 2017, 1-8 [28] Darouei A, Ayatollahi A. Classification of Cardiac Arrhythmias Using PNN Neural Network Based on ECG Feature Extraction [J]. 2009, 25(12): 309-311
70

参考文献 [29] 刘杰. 心电信号分析算法的研究与软件实现 [D]; 北京交通大学, 2010:26-28 [30] 涂岳文. Holter 系统中运动伪差自动识别的关键技术及算法研究 [D]; 浙江大学, 2013:35-
41 [31] Biel L, Pettersson O, Philipson L, et al. ECG analysis: a new approach in human identification
[C], proceedings of the Instrumentation and Measurement Technology Conference, 1999 Imtc/99 Proceedings of the IEEE, 2001: 557-561 vol.1 [32] Gacek A, Pedrycz W. ECG Signal Processing, Classification and Interpretation: A Comprehensive Framework of Computational Intelligence [M]. Springer London, 2012 [33] Adochiei N, David V, Adochiei F, et al. ECG waves and features extraction using Wavelet Multi-Resolution Analysis [C], proceedings of the E-Health and Bioengineering Conference, 2011: 1-4 [34] Gradl S, Kugler P, Lohmuller C, et al. Real-time ECG monitoring and arrhythmia detection using Android-based mobile devices [J]. 2012, 2012(4): 2452-2455 [35] 李昕, 王秀清, 宋佳霖. 心电信号预处理方法研究与评价 [J]. 测试技术学报, 2008, 22(1): 31-37 [36] Sujan K S S, Pridhvi R S, Priya K P, et al. Performance analysis for the Feature Extraction algorithm of an ECG signal [C], proceedings of the International Conference on Innovations in Information, Embedded and Communication Systems, 2015: 1-5
71

